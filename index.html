<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§‘ç ”ç®¡ç†å™¨ v7 (å®æ—¶åä½œç‰ˆ)</title>
    
    <!-- ä¾èµ–åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']], processEscapes: true },
            startup: { typeset: false }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/markdown/markdown.min.js"></script>
    
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; height: 100vh; background: #f4f5f7; overflow: hidden; color: #333; }
        
        /* UI åŸºç¡€ */
        .bar-btn { background: #444; border: 1px solid #666; color: white; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 8px;}
        .bar-btn:hover { background: #666; }
        .bar-btn.primary { background: #0366d6; border-color: #0366d6; }
        .bar-btn.warn { background: #d73a49; border-color: #d73a49; }

        /* é¡¶éƒ¨æ  */
        #status-bar { position: absolute; top: 0; left: 0; width: 100%; height: 40px; background: #24292e; color: #fff; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-sizing: border-box; z-index: 100; }

        /* å¸ƒå±€ */
        #container { display: flex; width: 100%; height: 100%; padding-top: 40px; box-sizing: border-box; }
        #sidebar { width: 280px; background: #f9f9f9; display: flex; flex-direction: column; flex-shrink: 0; border-right: 1px solid #ddd; }
        #resizer { width: 5px; background: #ddd; cursor: col-resize; z-index: 10; transition: background 0.2s; }
        #resizer:hover, #resizer.resizing { background: #0366d6; }
        #main { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: white; position: relative; }

        /* åˆ—è¡¨ */
        .sidebar-header { padding: 10px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; background: #fff;}
        #list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        .item { padding: 12px 10px; border-bottom: 1px solid #eee; cursor: pointer; border-left: 4px solid transparent; display: flex; align-items: flex-start; gap: 8px; user-select: none;}
        .item:hover { background: #eaeaea; }
        .item.active { background: #e6effc; border-left: 4px solid #0052cc; }
        .item.dragging { opacity: 0.5; background: #ccc; }
        
        .pin-icon { color: #ccc; font-size: 12px; cursor: pointer; }
        .pin-icon.pinned { color: #d97706; }
        .share-icon { font-size: 12px; margin-left: 5px; color: #00875a; display:none; } /* å…±äº«æ ‡è¯† */
        .item.shared .share-icon { display: inline; }

        .item-title { font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }

        /* è¯¦æƒ…ä¸ç¼–è¾‘ */
        #detail-view { display: none; width: 100%; height: 100%; flex-direction: column; overflow-y: auto; }
        .content-wrap { padding: 30px 50px; max-width: 900px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        .markdown-body { line-height: 1.7; font-size: 16px; color: #24292e; }
        .markdown-body pre { background: #f6f8fa; padding: 15px; border-radius: 6px; overflow: auto; }
        
        #editor-layer { display: none; position: fixed; inset: 0; background: white; z-index: 200; flex-direction: column; }
        .CodeMirror { height: 100%; font-family: "SFMono-Regular", Consolas, monospace; font-size: 15px; }

        /* åä½œæ¨ªå¹… */
        #collab-banner { display: none; background: #e6ffed; color: #0052cc; padding: 8px; text-align: center; border-bottom: 1px solid #bfebbb; font-size: 13px; }

        /* Loading & Modal */
        #loading { display: flex; position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 2000; justify-content: center; align-items: center; font-weight: bold; font-size: 18px; color: #333; }
        .modal { display: none; position: fixed; inset: 0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index: 1000; }
        .modal-box { background:white; padding:25px; width:400px; border-radius:8px; display:flex; flex-direction:column; gap:15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .inp { padding: 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%; box-sizing: border-box; }
        
        /* ä»…æ‰€æœ‰è€…å¯è§ */
        body.visitor-mode .only-owner { display: none !important; }
        body.visitor-mode #sidebar { display: none; }
        body.visitor-mode #resizer { display: none; }
    </style>
</head>
<body>

<div id="loading">ğŸš€ æ­£åœ¨è¿æ¥äº‘ç«¯...</div>

<!-- é¡¶éƒ¨æ  -->
<div id="status-bar">
    <div style="display:flex; align-items:center; gap:10px;">
        <span id="app-title" style="font-weight:bold;">ç§‘ç ”ç®¡ç†å™¨ v7</span>
        <span id="sync-status" style="font-size:12px; color:#aaa;">âšª å°±ç»ª</span>
    </div>
    <div id="auth-controls">
        <button class="bar-btn" onclick="syncPull()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
        <button class="bar-btn warn" onclick="openConfig()">âš™ï¸ å¯†é’¥</button>
    </div>
</div>

<div id="container">
    <!-- å·¦ä¾§ -->
    <div id="sidebar">
        <div class="sidebar-header">
            <h3>ğŸ“š é—®é¢˜åº“</h3>
            <button class="bar-btn primary" onclick="createNewLocal()">+</button>
        </div>
        <ul id="list"></ul>
    </div>
    <div id="resizer"></div>

    <!-- ä¸»åŒºåŸŸ -->
    <div id="main">
        <div id="collab-banner">ğŸŒ <b>å®æ—¶åä½œä¸­</b>ï¼šæ­¤å†…å®¹å­˜å‚¨åœ¨ç‹¬ç«‹çš„äº‘ç«¯é“¾æ¥ï¼Œæ‚¨ä¸åˆä½œè€…çš„ä¿®æ”¹å°†å®æ—¶äº’é€šã€‚</div>
        
        <div id="empty-msg" style="text-align:center; color:#888; margin-top:20vh;">
            <h2>è¯·é€‰æ‹©ä¸€ä¸ªé—®é¢˜</h2>
        </div>

        <div id="detail-view">
            <div class="content-wrap">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:10px; border-bottom:1px solid #eee;">
                    <span id="d-date" style="color:#888; font-size:12px;"></span>
                    <div style="display:flex; gap:10px;">
                        <button class="bar-btn only-owner" id="btn-share" onclick="convertToShared()">ğŸ”— å¼€å¯åä½œ/è·å–é“¾æ¥</button>
                        <button class="bar-btn" onclick="openEditor('problem')">âœï¸ ç¼–è¾‘é—®é¢˜</button>
                        <button class="bar-btn warn only-owner" onclick="deleteItem()">ğŸ—‘ï¸</button>
                    </div>
                </div>
                <h1 id="d-title" style="color:#0052cc; margin-top:0;"></h1>
                <div id="d-desc" class="markdown-body"></div>
            </div>

            <div style="background:#f4f5f7; padding:10px 50px; font-weight:bold; font-size:13px; color:#666; margin-top:20px;">
                ç¬”è®° / è®¨è®º
            </div>

            <div class="content-wrap" style="padding-top:20px; padding-bottom:50px;">
                <div id="ans-list"></div>
                <div style="text-align:center; margin-top:30px;">
                    <button class="bar-btn primary" style="padding:10px 30px;" onclick="openEditor('note')">â• æ·»åŠ å…¨å±ç¬”è®°</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å…¨å±ç¼–è¾‘å™¨ -->
<div id="editor-layer">
    <div style="height:50px; background:#f4f5f7; display:flex; align-items:center; justify-content:space-between; padding:0 20px; border-bottom:1px solid #ddd;">
        <span id="editor-title-disp" style="font-weight:bold;">ç¼–è¾‘</span>
        <input id="editor-title-inp" class="inp" style="width:300px; display:none;" placeholder="æ ‡é¢˜">
        <div>
            <button class="bar-btn" onclick="document.getElementById('editor-layer').style.display='none'">å–æ¶ˆ</button>
            <button class="bar-btn primary" onclick="saveEditor()">ğŸ’¾ ä¿å­˜ (Ctrl+S)</button>
        </div>
    </div>
    <div style="flex:1; display:flex;">
        <div style="width:50%; height:100%; border-right:1px solid #ddd;">
            <textarea id="code-editor"></textarea>
        </div>
        <div style="width:50%; height:100%; padding:20px; overflow-y:auto; background:#fff;">
            <div id="editor-preview" class="markdown-body"></div>
        </div>
    </div>
</div>

<!-- Config Modal -->
<div id="config-modal" class="modal">
    <div class="modal-box">
        <h3>âš™ï¸ è®¾ç½®</h3>
        <p style="font-size:12px; color:#666;">éœ€è¦ GitHub Token (æƒé™: gist)</p>
        <input class="inp" id="cfg-token" type="password" placeholder="Token: ghp_...">
        <input class="inp" id="cfg-id" placeholder="ä¸»æ•°æ®åº“ Gist ID (è‡ªåŠ¨ç”Ÿæˆå¯ç•™ç©º)">
        <div style="text-align:right;">
            <button class="bar-btn" onclick="document.getElementById('config-modal').style.display='none'">å…³é—­</button>
            <button class="bar-btn primary" onclick="saveConfig()">ä¿å­˜</button>
        </div>
    </div>
</div>

<script>
    // --- æ ¸å¿ƒå˜é‡ ---
    const CFG_KEY = 'v7_config';
    let ghConfig = JSON.parse(localStorage.getItem(CFG_KEY)) || { token: '', mainGistId: '' };
    
    // DB: { items: [ {id, title, date, isPinned, shareId(å¯é€‰), content(å¦‚æœæœªåˆ†äº«)} ] }
    // å¦‚æœ item.shareId å­˜åœ¨ï¼Œè¯´æ˜å†…å®¹åœ¨å¦ä¸€ä¸ª Gist é‡Œ
    let db = { items: [] };
    
    let currentId = null;
    let currentItemData = null; // å­˜å‚¨å½“å‰åŠ è½½çš„å®Œæ•´æ•°æ®ï¼ˆåŒ…å« contentï¼‰
    let editorMode = 'problem'; 
    let cmEditor;

    // URL åä½œæ¨¡å¼æ£€æµ‹
    const urlParams = new URLSearchParams(window.location.search);
    const visitorGistId = urlParams.get('gist'); // åªæœ‰åˆä½œè€…é€šè¿‡é“¾æ¥è®¿é—®æ—¶æ‰æœ‰è¿™ä¸ª

    // --- åˆå§‹åŒ– ---
    window.onload = async function() {
        initUI();
        if (visitorGistId) {
            enterVisitorMode();
        } else {
            if (ghConfig.token && ghConfig.mainGistId) {
                await syncPullMain();
            } else {
                document.getElementById('loading').style.display = 'none';
                openConfig();
            }
        }
    };

    function initUI() {
        cmEditor = CodeMirror.fromTextArea(document.getElementById("code-editor"), {
            mode: "markdown", lineNumbers: true, lineWrapping: true, extraKeys: { "Ctrl-S": saveEditor }
        });
        cmEditor.on("change", () => {
            const html = marked.parse(cmEditor.getValue());
            document.getElementById('editor-preview').innerHTML = html;
            if(window.MathJax) MathJax.typesetPromise([document.getElementById('editor-preview')]);
        });

        // æ‹–æ‹½åˆ†æ 
        const resizer = document.getElementById('resizer');
        const sidebar = document.getElementById('sidebar');
        resizer.addEventListener('mousedown', () => {
            document.addEventListener('mousemove', resize, false);
            document.addEventListener('mouseup', stopResize, false);
        });
        function resize(e) { sidebar.style.width = Math.max(150, Math.min(600, e.clientX)) + 'px'; }
        function stopResize() { document.removeEventListener('mousemove', resize, false); document.removeEventListener('mouseup', stopResize, false); }
    }

    // --- æ¨¡å¼ A: è®¿å®¢æ¨¡å¼ (åˆä½œè€…) ---
    async function enterVisitorMode() {
        document.body.classList.add('visitor-mode');
        document.getElementById('auth-controls').innerHTML = ''; // éšè—é…ç½®
        document.getElementById('app-title').innerText = "åä½œç¼–è¾‘å™¨ (è®¿å®¢)";
        
        // è®¿å®¢ä¹Ÿéœ€è¦ Token æ‰èƒ½ç¼–è¾‘ (GitHub API é™åˆ¶)
        if (!ghConfig.token) {
            const t = prompt("è¯·è¾“å…¥ GitHub Token ä»¥å¯ç”¨ç¼–è¾‘æƒé™ï¼š");
            if(t) ghConfig.token = t;
        }

        await loadSharedItem(visitorGistId);
    }

    // --- æ¨¡å¼ B: ä¸»äººæ¨¡å¼ (ä½ ) ---
    async function syncPullMain() {
        if(!ghConfig.token || !ghConfig.mainGistId) return;
        setMsg("æ­£åœ¨åŒæ­¥åˆ—è¡¨...");
        try {
            const res = await fetch(`https://api.github.com/gists/${ghConfig.mainGistId}`, {
                headers: { "Authorization": `token ${ghConfig.token}`, "Cache-Control": "no-cache" }
            });
            if(!res.ok) throw new Error("æ— æ³•è¿æ¥ä¸»åº“ï¼Œè¯·æ£€æŸ¥ Token æˆ– Gist ID");
            const json = await res.json();
            
            // [ä¿®å¤] å…¼å®¹æ€§é€»è¾‘ï¼šä¼˜å…ˆæ‰¾ main_db.jsonï¼Œæ‰¾ä¸åˆ°åˆ™æ‰¾æ—§ç‰ˆ research_data.jsonï¼Œå†æ‰¾ä¸åˆ°åˆ™æ‰¾ä»»æ„ json
            let fileObj = json.files["main_db.json"];
            if (!fileObj) fileObj = json.files["research_data.json"]; // v6 å…¼å®¹
            if (!fileObj) {
                const anyJson = Object.keys(json.files).find(k => k.endsWith('.json'));
                if(anyJson) fileObj = json.files[anyJson];
            }

            if (!fileObj) throw new Error("æœªåœ¨ Gist ä¸­æ‰¾åˆ°æœ‰æ•ˆæ•°æ®æ–‡ä»¶");

            const content = fileObj.content;
            db = JSON.parse(content);
            if(!db.items) {
                // v5 ä»¥å‰å¯èƒ½æ˜¯æ•°ç»„ç»“æ„
                if(Array.isArray(db)) db = { items: db };
                else db = { items: [] };
            }
            
            renderList();
            setMsg("å°±ç»ª");
        } catch(e) {
            alert("åŒæ­¥é”™è¯¯: " + e.message);
            setMsg("âŒ å¤±è´¥");
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    // --- æ ¸å¿ƒï¼šåŠ è½½è¯¦æƒ… (æ™ºèƒ½åˆ¤æ–­æ˜¯æœ¬åœ°è¿˜æ˜¯äº‘ç«¯) ---
    async function loadItem(id) {
        currentId = id;
        const itemRef = db.items.find(x => x.id === id);
        if(!itemRef) return;

        document.getElementById('empty-msg').style.display = 'none';
        document.getElementById('detail-view').style.display = 'flex';
        document.getElementById('collab-banner').style.display = 'none';
        document.getElementById('loading').style.display = 'flex';

        try {
            if (itemRef.shareId) {
                // [é‡ç‚¹] å¦‚æœæœ‰ shareIdï¼Œå»è¿œç«¯æ‹‰å–æœ€æ–°å†…å®¹
                document.getElementById('collab-banner').style.display = 'block';
                setMsg("æ­£åœ¨æ‹‰å–åä½œå†…å®¹...");
                await loadSharedItem(itemRef.shareId); 
            } else {
                // æ™®é€šæœ¬åœ°é¡¹ç›®
                currentItemData = itemRef; // ç›´æ¥å¼•ç”¨æœ¬åœ°å¯¹è±¡
                renderDetailView();
            }
        } catch (e) {
            alert("åŠ è½½å¤±è´¥: " + e.message);
        } finally {
            document.getElementById('loading').style.display = 'none';
            setMsg("å°±ç»ª");
        }
    }

    // åŠ è½½å•ä¸ª Shared Gist
    async function loadSharedItem(gistId) {
        const res = await fetch(`https://api.github.com/gists/${gistId}`, {
            headers: { "Authorization": `token ${ghConfig.token}`, "Cache-Control": "no-cache" }
        });
        if(!res.ok) throw new Error("æ— æ³•åŠ è½½åä½œå†…å®¹");
        const json = await res.json();
        const content = json.files["shared_item.json"].content;
        currentItemData = JSON.parse(content);
        // å¦‚æœæ˜¯è®¿å®¢æ¨¡å¼ï¼Œæ‰‹åŠ¨è®¾ç½® currentId
        if(!currentId) currentId = currentItemData.id;
        renderDetailView();
    }

    function renderDetailView() {
        const d = currentItemData;
        document.getElementById('d-title').innerText = d.title;
        document.getElementById('d-date').innerText = new Date(d.date).toLocaleDateString();
        document.getElementById('d-desc').innerHTML = marked.parse(d.desc || "");
        
        // æ¸²æŸ“ç­”æ¡ˆ
        const list = document.getElementById('ans-list');
        list.innerHTML = (d.answers || []).map((a, i) => `
            <div style="background:#fafbfc; border:1px solid #eee; padding:15px; margin-bottom:10px; border-radius:5px;">
                <div class="markdown-body">${marked.parse(a.text)}</div>
                <div style="font-size:12px; color:#aaa; margin-top:5px; display:flex; justify-content:space-between;">
                    <span>${new Date(a.date).toLocaleString()}</span>
                    <button class="bar-btn warn" onclick="deleteAns(${i})">åˆ é™¤</button>
                </div>
            </div>
        `).join('');
        
        // åˆ—è¡¨é€‰ä¸­æ€
        if(!visitorGistId) renderList(); 
        
        // MathJax
        if(window.MathJax) MathJax.typesetPromise();
    }

    // --- åä½œè½¬æ¢é€»è¾‘ ---
    async function convertToShared() {
        const item = db.items.find(x => x.id === currentId);
        if(!item) return;

        if (item.shareId) {
            // å·²ç»æ˜¯å…±äº«çš„ï¼Œåªæ˜¾ç¤ºé“¾æ¥
            const link = `${location.origin}${location.pathname}?gist=${item.shareId}`;
            prompt("ğŸ”— æ­¤é—®é¢˜å·²å¤„äºåä½œæ¨¡å¼ã€‚å°†æ­¤é“¾æ¥å‘ç»™åˆä½œè€…ï¼š", link);
            return;
        }

        if(!confirm("âš ï¸ ç¡®å®šå¼€å¯åä½œæ¨¡å¼å—ï¼Ÿ\n\nå¼€å¯åï¼Œæ­¤é—®é¢˜çš„å†…å®¹å°†ç§»åŠ¨åˆ°ç‹¬ç«‹çš„äº‘ç«¯ç©ºé—´ï¼Œä»¥ä¾¿åˆä½œè€…åŒæ­¥ç¼–è¾‘ã€‚")) return;

        setMsg("æ­£åœ¨åˆå§‹åŒ–åä½œç©ºé—´...");
        document.getElementById('loading').style.display = 'flex';

        try {
            // 1. åˆ›å»ºæ–°çš„ Share Gist
            const payload = {
                description: `[Shared] ${item.title}`,
                public: false,
                files: { "shared_item.json": { content: JSON.stringify(item, null, 2) } }
            };
            const res = await fetch("https://api.github.com/gists", {
                method: "POST",
                headers: { "Authorization": `token ${ghConfig.token}` },
                body: JSON.stringify(payload)
            });
            const json = await res.json();
            const newShareId = json.id;

            // 2. æ›´æ–°æœ¬åœ°ä¸»åº“ï¼ŒæŒ‡å‘è¿™ä¸ª Share IDï¼Œå¹¶æ¸…ç©ºæœ¬åœ° content ä»¥å‡å°ä½“ç§¯
            item.shareId = newShareId;
            // å¯é€‰ï¼šæ¸…ç©ºæœ¬åœ°çš„ desc å’Œ answersï¼Œå› ä¸ºä»¥åéƒ½å»äº‘ç«¯è¯»äº†
            // item.desc = ""; item.answers = []; 

            await saveMainDB(); // ä¿å­˜ä¸»åº“ç»“æ„
            
            alert("âœ… åä½œæ¨¡å¼å·²å¼€å¯ï¼");
            loadItem(currentId); // é‡æ–°åŠ è½½ï¼ˆè§¦å‘è¿œç¨‹è¯»å–ï¼‰

        } catch(e) {
            alert("å¼€å¯å¤±è´¥: " + e.message);
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    // --- ç¼–è¾‘ä¸ä¿å­˜ ---
    function openEditor(mode) {
        editorMode = mode;
        const layer = document.getElementById('editor-layer');
        layer.style.display = 'flex';
        const titleInp = document.getElementById('editor-title-inp');
        
        if (mode === 'problem') {
            titleInp.style.display = 'block';
            titleInp.value = currentItemData.title;
            cmEditor.setValue(currentItemData.desc);
        } else {
            titleInp.style.display = 'none';
            cmEditor.setValue('');
        }
        setTimeout(() => cmEditor.refresh(), 100);
    }

    async function saveEditor() {
        const val = cmEditor.getValue();
        if (editorMode === 'problem') {
            currentItemData.title = document.getElementById('editor-title-inp').value;
            currentItemData.desc = val;
        } else {
            if(!val.trim()) return;
            if(!currentItemData.answers) currentItemData.answers = [];
            currentItemData.answers.push({ text: val, date: new Date().toISOString() });
        }
        currentItemData.date = new Date().toISOString();
        
        // æ‰§è¡Œä¿å­˜
        document.getElementById('editor-layer').style.display = 'none';
        await performSave();
        renderDetailView();
    }
    
    async function deleteAns(idx) {
        if(!confirm("åˆ é™¤ç¬”è®°?")) return;
        currentItemData.answers.splice(idx, 1);
        await performSave();
        renderDetailView();
    }

    // æ™ºèƒ½ä¿å­˜ï¼šåˆ¤æ–­æ˜¯ä¿å­˜åˆ° Share Gist è¿˜æ˜¯ Main Gist
    async function performSave() {
        setMsg("æ­£åœ¨ä¿å­˜...");
        
        // åœºæ™¯1: è®¿å®¢æ¨¡å¼ OR æœ¬åœ°é¡¹ç›®å·²è½¬ä¸ºåä½œ -> ä¿å­˜åˆ° Share Gist
        // åˆ¤æ–­ä¾æ®: visitorGistId å­˜åœ¨ï¼Œæˆ–è€… db item æœ‰ shareId
        let targetShareId = visitorGistId;
        if (!targetShareId && currentId) {
            const ref = db.items.find(x => x.id === currentId);
            if(ref && ref.shareId) targetShareId = ref.shareId;
        }

        if (targetShareId) {
            // ä¿å­˜åˆ°ç‹¬ç«‹çš„ Share Gist
            await updateGistFile(targetShareId, "shared_item.json", currentItemData);
            
            // å¦‚æœæˆ‘æ˜¯ä¸»äººï¼Œè¿˜éœ€è¦æ›´æ–°ä¸€ä¸‹ä¸»åº“é‡Œçš„æ ‡é¢˜å’Œæ—¶é—´ï¼ˆå…ƒæ•°æ®ï¼‰
            if (!visitorGistId) {
                const ref = db.items.find(x => x.id === currentId);
                ref.title = currentItemData.title;
                ref.date = currentItemData.date;
                saveMainDB(true); // é™é»˜ä¿å­˜ä¸»åº“
            }
        } else {
            // åœºæ™¯2: çº¯æœ¬åœ°é¡¹ç›® -> ç›´æ¥æ›´æ–° Main DB
            // currentItemData å°±æ˜¯ db.items é‡Œçš„é‚£ä¸ªå¯¹è±¡å¼•ç”¨
            await saveMainDB();
        }
        setMsg("å·²ä¿å­˜");
    }

    async function saveMainDB(silent = false) {
        if(!silent) setMsg("åŒæ­¥ä¸»åº“...");
        // å³ä½¿è¯»å–çš„æ˜¯æ—§æ–‡ä»¶ï¼Œä¿å­˜æ—¶ä¹Ÿä¼šè‡ªåŠ¨å‡çº§ä¸º main_db.json
        await updateGistFile(ghConfig.mainGistId, "main_db.json", db);
    }

    async function updateGistFile(gistId, filename, dataObj) {
        try {
            const res = await fetch(`https://api.github.com/gists/${gistId}`, {
                method: "PATCH",
                headers: { "Authorization": `token ${ghConfig.token}`, "Content-Type": "application/json" },
                body: JSON.stringify({ files: { [filename]: { content: JSON.stringify(dataObj, null, 2) } } })
            });
            if (!res.ok) throw new Error(`ä¿å­˜å¤±è´¥: ${res.statusText}`);
        } catch(e) {
            alert("æ— æ³•ä¿å­˜åˆ°äº‘ç«¯: " + e.message);
            throw e; // å‘ä¸Šä¼ é€’é”™è¯¯ï¼Œé˜»æ­¢åç»­UIæ›´æ–°
        }
    }

    // --- åˆ—è¡¨ä¸åŸºæœ¬æ“ä½œ ---
    function renderList() {
        const ul = document.getElementById('list');
        ul.innerHTML = db.items.map((item, idx) => `
            <li class="item ${item.id === currentId ? 'active' : ''} ${item.shareId ? 'shared' : ''}" 
                draggable="true" 
                onclick="loadItem(${item.id})"
                ondragstart="dragStart(event, ${idx})" 
                ondrop="dragDrop(event, ${idx})" 
                ondragover="event.preventDefault()">
                <span class="pin-icon ${item.isPinned?'pinned':''}" onclick="togglePin(event, ${idx})">ğŸ“Œ</span>
                <span class="item-title">${item.title}</span>
                <span class="share-icon" title="åä½œä¸­">ğŸ”—</span>
            </li>
        `).join('');
    }

    function createNewLocal() {
        const newItem = { id: Date.now(), title: "æ–°é—®é¢˜", desc: "", answers: [], date: new Date().toISOString(), isPinned: false };
        db.items.unshift(newItem);
        saveMainDB();
        loadItem(newItem.id);
    }
    
    async function deleteItem() {
        if(!confirm("åˆ é™¤æ­¤é—®é¢˜ï¼Ÿ")) return;
        db.items = db.items.filter(x => x.id !== currentId);
        await saveMainDB();
        location.reload();
    }

    // æ‹–æ‹½æ’åº
    function dragStart(e, idx) { e.dataTransfer.setData('idx', idx); }
    function dragDrop(e, targetIdx) {
        e.preventDefault();
        const srcIdx = e.dataTransfer.getData('idx');
        const [moved] = db.items.splice(srcIdx, 1);
        db.items.splice(targetIdx, 0, moved);
        renderList();
        saveMainDB(true);
    }
    
    function togglePin(e, idx) {
        e.stopPropagation();
        db.items[idx].isPinned = !db.items[idx].isPinned;
        // ç®€å•æ’åºï¼šç½®é¡¶ç§»åˆ°æœ€å‰
        if(db.items[idx].isPinned) {
            const [item] = db.items.splice(idx, 1);
            db.items.unshift(item);
        }
        renderList();
        saveMainDB(true);
    }

    // --- é…ç½® ---
    function openConfig() { document.getElementById('config-modal').style.display = 'flex'; }
    function setMsg(t) { document.getElementById('sync-status').innerText = t; }
    
    async function saveConfig() {
        const t = document.getElementById('cfg-token').value;
        let mid = document.getElementById('cfg-id').value;
        if(!t) return alert("Token å¿…å¡«");

        if (!mid) {
            const res = await fetch("https://api.github.com/gists", {
                method: "POST",
                headers: { "Authorization": `token ${t}` },
                body: JSON.stringify({ description: "Research Manager Main DB", public: false, files: { "main_db.json": { content: JSON.stringify({items:[]}) } } })
            });
            const json = await res.json();
            mid = json.id;
            alert("å·²è‡ªåŠ¨åˆ›å»ºä¸»æ•°æ®åº“ ID: " + mid);
        }
        ghConfig = { token: t, mainGistId: mid };
        localStorage.setItem(CFG_KEY, JSON.stringify(ghConfig));
        document.getElementById('config-modal').style.display = 'none';
        syncPullMain();
    }
</script>
</body>
</html>
