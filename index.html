<!DOCTYPE html>
<html lang="zh-CN">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>ç§‘ç ”ç®¡ç†å™¨ </title>
Â  Â Â 
Â  Â  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
Â  Â  <script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']]},startup:{typeset:false}};</script>
Â  Â  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

Â  Â  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
Â  Â  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/markdown/markdown.min.js"></script>
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/stex/stex.min.js"></script>
Â  Â  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
Â  Â Â 
Â  Â  <style>
Â  Â  Â  Â  body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; height: 100vh; background: #f4f5f7; overflow: hidden; color: #333; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* é¡¶éƒ¨äº‘çŠ¶æ€æ  */
Â  Â  Â  Â  #cloud-status-bar {
Â  Â  Â  Â  Â  Â  position: absolute; top: 0; left: 0; width: 100%; height: 32px; background: #24292e; color: #fff;
Â  Â  Â  Â  Â  Â  font-size: 12px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-sizing: border-box; z-index: 100;
Â  Â  Â  Â  }
Â  Â  Â  Â  #cloud-msg { font-weight: bold; }
Â  Â  Â  Â  .cloud-btn { background: #0366d6; border: none; color: white; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 11px; margin-left: 5px;}
Â  Â  Â  Â  .cloud-btn:hover { background: #0255b3; }
Â  Â  Â  Â  .cloud-btn.warn { background: #d73a49; }

Â  Â  Â  Â  /* å¸ƒå±€è°ƒæ•´ (ä¸ºé¡¶éƒ¨æ ç•™ç©º) */
Â  Â  Â  Â  #sidebar { width: 260px; background: white; border-right: 1px solid #ddd; display: flex; flex-direction: column; z-index: 2; flex-shrink: 0; margin-top: 32px; }
Â  Â  Â  Â  #main { flex: 1; display: flex; flex-direction: column; overflow-y: auto; background: white; position: relative; margin-top: 32px; }

Â  Â  Â  Â  /* é€šç”¨ç»„ä»¶ (å¤ç”¨ V8/V9 æ ·å¼) */
Â  Â  Â  Â  .header { padding: 15px; border-bottom: 1px solid #ddd; background: #fafbfc; display: flex; justify-content: space-between; align-items: center; }
Â  Â  Â  Â  .add-btn { background: #0052cc; color: white; border: none; width: 30px; height: 30px; cursor: pointer; border-radius: 4px; font-size: 20px; display:flex; align-items:center; justify-content:center; }
Â  Â  Â  Â  #list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
Â  Â  Â  Â  .item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; border-left: 4px solid transparent; }
Â  Â  Â  Â  .item:hover { background: #eee; }
Â  Â  Â  Â  .item.active { background: #e6effc; border-left: 4px solid #0052cc; }
Â  Â  Â  Â  .item-title { font-weight: bold; margin-bottom: 5px; color: #172b4d; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
Â  Â  Â  Â  .item-date { font-size: 12px; color: #888; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  #detail-view { display: none; width: 100%; height: 100%; flex-direction: column; }
Â  Â  Â  Â  .content-wrap { padding: 30px 40px; max-width: 1000px; margin: 0 auto; width: 100%; box-sizing: border-box; }
Â  Â  Â  Â  .meta-bar { display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; }
Â  Â  Â  Â  .btn { padding: 6px 12px; cursor: pointer; border: none; border-radius: 3px; font-size: 13px; margin-left: 8px;}
Â  Â  Â  Â  .btn-primary { background: #0052cc; color: white; }
Â  Â  Â  Â  .btn-share { background: #00875a; color: white; }
Â  Â  Â  Â  .btn-del { background: #ffebe6; color: #de350b; }
Â  Â  Â  Â  .btn-edit { background: #ebecf0; color: #091e42; }

Â  Â  Â  Â  .markdown-body { line-height: 1.6; font-size: 16px; }
Â  Â  Â  Â  .markdown-body h1, .markdown-body h2 { border-bottom: 1px solid #eaecef; padding-bottom: .3em; margin-top: 24px; }
Â  Â  Â  Â  .markdown-body code { background-color: #f6f8fa; border-radius: 3px; padding: 2px 4px; font-family: monospace; }
Â  Â  Â  Â  .markdown-body pre { background-color: #f6f8fa; padding: 16px; border-radius: 6px; overflow: auto; }
Â  Â  Â  Â  .markdown-body blockquote { border-left: 4px solid #dfe2e5; color: #6a737d; padding-left: 1em; margin: 0; }

Â  Â  Â  Â  .divider-section { background-color: #f4f5f7; border-top: 1px solid #dfe1e6; border-bottom: 1px solid #dfe1e6; padding: 8px 40px; color: #5e6c84; font-weight: bold; font-size: 12px; letter-spacing: 1px; text-transform: uppercase; }
Â  Â  Â  Â  .answers-section { background: #fff; padding-bottom: 80px; }
Â  Â  Â  Â  .ans-item { border: 1px solid #eee; padding: 20px; border-radius: 8px; margin-bottom: 15px; background: #fafbfc; }
Â  Â  Â  Â  .ans-meta { font-size: 12px; color: #aaa; margin-top: 10px; display: flex; justify-content: space-between; border-top: 1px solid #eee; padding-top: 10px; }

Â  Â  Â  Â  /* ç¼–è¾‘å™¨ */
Â  Â  Â  Â  #editor-container { display: none; flex: 1; flex-direction: column; height: 100%; overflow: hidden; background: #fff; }
Â  Â  Â  Â  .editor-toolbar { padding: 10px 20px; border-bottom: 1px solid #ddd; background: #f4f5f7; display: flex; justify-content: space-between; align-items: center; }
Â  Â  Â  Â  .editor-split-view { display: flex; flex: 1; overflow: hidden; }
Â  Â  Â  Â  .editor-pane, .preview-pane { width: 50%; height: 100%; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
Â  Â  Â  Â  .preview-pane { overflow-y: auto; padding: 20px 40px; background: #fff; box-sizing: border-box; border-right: none; }
Â  Â  Â  Â  .title-input { width: 100%; padding: 10px 20px; font-size: 18px; font-weight: bold; border: none; border-bottom: 1px solid #ddd; outline: none; }
Â  Â  Â  Â  .CodeMirror { height: 100%; font-family: Consolas, Monaco, monospace; font-size: 15px; line-height: 1.5; }
Â  Â  Â  Â  .note-input-area { border: 2px solid #eee; border-radius: 6px; overflow: hidden; }
Â  Â  Â  Â  .note-cm-container .CodeMirror { height: 120px; }
Â  Â  Â  Â  #note-live-preview { margin-top: 10px; padding: 10px; border-top: 1px dashed #ddd; min-height: 40px; color: #555; font-size: 14px; }

Â  Â  Â  Â  /* å­¦æœ¯ç¯å¢ƒ */
Â  Â  Â  Â  .env-block { margin: 15px 0; padding: 15px; border-radius: 4px; text-align: left; }
Â  Â  Â  Â  .env-title { font-weight: bold; margin-right: 8px; }
Â  Â  Â  Â  .env-content { font-style: italic; }
Â  Â  Â  Â  .env-thm { background: #e6effc; border-left: 4px solid #0052cc; color: #172b4d; }
Â  Â  Â  Â  .env-thm .env-title { color: #0052cc; }
Â  Â  Â  Â  .env-conj { background: #fff7e6; border-left: 4px solid #ff9900; color: #172b4d; }
Â  Â  Â  Â  .env-conj .env-title { color: #d97706; }
Â  Â  Â  Â  .env-lemma { background: #f4f5f7; border-left: 4px solid #5e6c84; color: #172b4d; }
Â  Â  Â  Â  .env-lemma .env-title { color: #42526e; }
Â  Â  Â  Â  .env-defn { background: #e3fcef; border-left: 4px solid #00875a; color: #172b4d; }
Â  Â  Â  Â  .env-defn .env-title { color: #006644; }
Â  Â  Â  Â  .env-proof { margin: 15px 0; padding-left: 15px; color: #333; }
Â  Â  Â  Â  .env-proof .env-title { font-style: italic; font-weight: bold; color: #333; }
Â  Â  Â  Â  .env-proof .env-content { font-style: normal; }
Â  Â  Â  Â  .qed-symbol { float: right; color: #333; }

Â  Â  Â  Â  /* å¼¹çª— */
Â  Â  Â  Â  #modal, #config-modal { display: none; position: fixed; inset: 0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index: 999; }
Â  Â  Â  Â  .modal-content { background:white; padding:20px; width:500px; border-radius:8px; display:flex; flex-direction:column; gap:10px; }
Â  Â  Â  Â  .modal-inp { padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
Â  Â  </style>
</head>
<body>

<div id="cloud-status-bar">
Â  Â  <div id="cloud-msg">ğŸ“¡ æœªé…ç½®äº‘ç«¯åŒæ­¥</div>
Â  Â  <div>
Â  Â  Â  Â  <button class="cloud-btn" onclick="syncPull()">â¬‡ï¸ æ‹‰å–</button>
Â  Â  Â  Â  <button class="cloud-btn" onclick="syncPush()">â¬†ï¸ æ¨é€</button>
Â  Â  Â  Â  <button class="cloud-btn warn" onclick="openConfig()">âš™ï¸ é…ç½®å¯†é’¥</button>
Â  Â  </div>
</div>

<div id="sidebar">
Â  Â  <div class="header">
Â  Â  Â  Â  <h3 style="margin:0">é—®é¢˜åº“</h3>
Â  Â  Â  Â  <button class="add-btn" onclick="openModal()">+</button>
Â  Â  </div>
Â  Â  <ul id="list"></ul>
</div>

<div id="main">
Â  Â  <div id="empty-msg" style="text-align:center; color:#888; margin-top:100px;">
Â  Â  Â  Â  <h2>è¯·ç‚¹å‡»å·¦ä¾§â€œ+â€æ·»åŠ é—®é¢˜</h2>
Â  Â  </div>

Â  Â  <div id="detail-view">
Â  Â  Â  Â  <div class="content-wrap" style="flex:1;">
Â  Â  Â  Â  Â  Â  <div class="meta-bar">
Â  Â  Â  Â  Â  Â  Â  Â  <span id="d-date" style="color:#888; font-size:12px;"></span>
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-edit" onclick="enterEditMode()">âœï¸ ä¿®æ”¹</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-share" onclick="doExport()">ğŸ“¤ å¯¼å‡º</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-del" onclick="doDelete()">åˆ é™¤</button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <h1 id="d-title" style="color:#0052cc; margin-top:0;"></h1>
Â  Â  Â  Â  Â  Â  <div id="d-desc" class="markdown-body"></div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="divider-section">â–¼ ç¬”è®°ä¸è®¨è®º</div>

Â  Â  Â  Â  <div class="content-wrap answers-section">
Â  Â  Â  Â  Â  Â  <div id="ans-list"></div>
Â  Â  Â  Â  Â  Â  <h4 style="margin:20px 0 10px 0; color:#555;">æ·»åŠ æ–°ç¬”è®°:</h4>
Â  Â  Â  Â  Â  Â  <div class="note-input-area note-cm-container"><textarea id="new-ans-textarea"></textarea></div>
Â  Â  Â  Â  Â  Â  <div id="note-live-preview" class="markdown-body">é¢„è§ˆåŒºåŸŸ</div>
Â  Â  Â  Â  Â  Â  <div style="text-align:right; margin-top:10px;">
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-primary" onclick="addAns()">æäº¤ç¬”è®°</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="editor-container">
Â  Â  Â  Â  <div class="editor-toolbar">
Â  Â  Â  Â  Â  Â  <span style="font-weight:bold;">âœï¸ ç¼–è¾‘æ¨¡å¼</span>
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn" style="background:#eee;" onclick="exitEditMode()">å–æ¶ˆ</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button class="btn btn-primary" onclick="saveEdit()">ä¿å­˜ä¿®æ”¹</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <input type="text" id="editor-title" class="title-input" placeholder="é—®é¢˜æ ‡é¢˜">
Â  Â  Â  Â  <div class="editor-split-view">
Â  Â  Â  Â  Â  Â  <div class="editor-pane"><textarea id="code-editor"></textarea></div>
Â  Â  Â  Â  Â  Â  <div class="preview-pane"><div id="editor-preview" class="markdown-body"></div></div>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<div id="modal">
Â  Â  <div class="modal-content">
Â  Â  Â  Â  <h3>æ–°å»ºé—®é¢˜</h3>
Â  Â  Â  Â  <input class="modal-inp" id="m-title" placeholder="æ ‡é¢˜">
Â  Â  Â  Â  <textarea class="modal-inp" id="m-desc" style="height:150px" placeholder="ç®€è¦æè¿°"></textarea>
Â  Â  Â  Â  <div style="text-align:right;">
Â  Â  Â  Â  Â  Â  <button class="btn" style="background:#eee;" onclick="document.getElementById('modal').style.display='none'">å–æ¶ˆ</button>
Â  Â  Â  Â  Â  Â  <button class="btn btn-primary" onclick="saveNew()">åˆ›å»º</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<div id="config-modal">
Â  Â  <div class="modal-content">
Â  Â  Â  Â  <h3>âš™ï¸ äº‘ç«¯é…ç½® (GitHub Gist)</h3>
Â  Â  Â  Â  <p style="font-size:12px; color:#666;">é…ç½®åï¼Œæ•°æ®å°†åŒæ­¥åˆ°æ‚¨çš„ç§äºº Gistï¼Œå®ç°å¤šè®¾å¤‡åŒæ­¥ã€‚</p>
Â  Â  Â  Â  <label>GitHub Token (éœ€å‹¾é€‰ gist æƒé™):</label>
Â  Â  Â  Â  <input class="modal-inp" id="cfg-token" type="password" placeholder="ghp_xxxxxxxxxxxx">
Â  Â  Â  Â  <label>Gist ID (URL åé¢çš„é‚£ä¸²å­—ç¬¦):</label>
Â  Â  Â  Â  <input class="modal-inp" id="cfg-id" placeholder="ä¾‹å¦‚: abc1234567890def">
Â  Â  Â  Â  <div style="text-align:right;">
Â  Â  Â  Â  Â  Â  <button class="btn" style="background:#eee;" onclick="document.getElementById('config-modal').style.display='none'">å…³é—­</button>
Â  Â  Â  Â  Â  Â  <button class="btn btn-primary" onclick="saveConfig()">ä¿å­˜å¹¶æµ‹è¯•</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<script>
Â  Â  // --- 0. é…ç½®ä¸åˆå§‹åŒ– ---
Â  Â  const LATEX_KEYWORDS = [ { text: "\\begin{thm}\n\n\\end{thm}", displayText: "thm" }, { text: "\\begin{conj}\n\n\\end{conj}", displayText: "conj" }, "\\alpha", "\\beta", "\\sum", "\\prod" ];
Â  Â  let mainEditor, noteEditor, debounceTimer;
Â  Â  var data = JSON.parse(localStorage.getItem('my_research_v4')) || [];
Â  Â  var currentId = null;

Â  Â  // GitHub é…ç½®
Â  Â  var ghConfig = JSON.parse(localStorage.getItem('gh_config')) || { token: '', gistId: '' };

Â  Â  window.onload = function() {
Â  Â  Â  Â  initEditors();
Â  Â  Â  Â  renderList();
Â  Â  Â  Â  updateCloudStatus();
Â  Â  Â  Â  if(ghConfig.token && ghConfig.gistId) {
Â  Â  Â  Â  Â  Â  syncPull(true); // è‡ªåŠ¨æ‹‰å–
Â  Â  Â  Â  }
Â  Â  };

Â  Â  function initEditors() {
Â  Â  Â  Â  mainEditor = CodeMirror.fromTextArea(document.getElementById("code-editor"), { mode: "markdown", theme: "default", lineNumbers: true, lineWrapping: true, extraKeys: {"Ctrl-Space": "autocomplete"} });
Â  Â  Â  Â  mainEditor.on("inputRead", function(cm, change) { if (change.text[0].match(/[\\a-zA-Z]/)) CodeMirror.commands.autocomplete(cm, null, { completeSingle: false }); });
Â  Â  Â  Â  mainEditor.on("change", () => updateMainPreview());

Â  Â  Â  Â  noteEditor = CodeMirror.fromTextArea(document.getElementById("new-ans-textarea"), { mode: "markdown", lineWrapping: true, extraKeys: {"Ctrl-Space": "autocomplete"} });
Â  Â  Â  Â  noteEditor.on("inputRead", function(cm, change) { if (change.text[0].match(/[\\a-zA-Z]/)) CodeMirror.commands.autocomplete(cm, null, { completeSingle: false }); });
Â  Â  Â  Â  noteEditor.on("change", () => updateNotePreview());
Â  Â  Â  Â Â 
Â  Â  Â  Â  CodeMirror.registerHelper("hint", "markdown", function(editor) {
Â  Â  Â  Â  Â  Â  var cur = editor.getCursor(); var token = editor.getTokenAt(cur);
Â  Â  Â  Â  Â  Â  var start = token.start; var end = cur.ch; var word = token.string.slice(0, end - start);
Â  Â  Â  Â  Â  Â  var list = LATEX_KEYWORDS.filter(function(item) { var text = (typeof item === "string") ? item : item.displayText; return text.indexOf(word) >= 0; });
Â  Â  Â  Â  Â  Â  return { list: list, from: CodeMirror.Pos(cur.line, start), to: CodeMirror.Pos(cur.line, end) };
Â  Â  Â  Â  });
Â  Â  }

Â  Â  // --- 1. äº‘ç«¯åŒæ­¥æ ¸å¿ƒé€»è¾‘ ---
Â  Â  function openConfig() {
Â  Â  Â  Â  document.getElementById('cfg-token').value = ghConfig.token;
Â  Â  Â  Â  document.getElementById('cfg-id').value = ghConfig.gistId;
Â  Â  Â  Â  document.getElementById('config-modal').style.display = 'flex';
Â  Â  }

Â  Â  function saveConfig() {
Â  Â  Â  Â  ghConfig.token = document.getElementById('cfg-token').value.trim();
Â  Â  Â  Â  ghConfig.gistId = document.getElementById('cfg-id').value.trim();
Â  Â  Â  Â  localStorage.setItem('gh_config', JSON.stringify(ghConfig));
Â  Â  Â  Â  document.getElementById('config-modal').style.display = 'none';
Â  Â  Â  Â  updateCloudStatus();
Â  Â  Â  Â  syncPull(); // ä¿å­˜åç«‹å³å°è¯•æ‹‰å–
Â  Â  }

Â  Â  function updateCloudStatus() {
Â  Â  Â  Â  const msg = document.getElementById('cloud-msg');
Â  Â  Â  Â  if(!ghConfig.token || !ghConfig.gistId) {
Â  Â  Â  Â  Â  Â  msg.innerText = "ğŸ“¡ æœªé…ç½®äº‘ç«¯";
Â  Â  Â  Â  Â  Â  msg.style.color = "#ff9900";
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  msg.innerText = "âœ… äº‘ç«¯å·²å°±ç»ª";
Â  Â  Â  Â  Â  Â  msg.style.color = "#4caf50";
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // æ‹‰å–æ•°æ® (Load)
Â  Â  async function syncPull(silent = false) {
Â  Â  Â  Â  if(!ghConfig.token) return (!silent && alert("è¯·å…ˆé…ç½®å¯†é’¥"));
Â  Â  Â  Â  const msg = document.getElementById('cloud-msg');
Â  Â  Â  Â  msg.innerText = "ğŸ”„ æ­£åœ¨åŒæ­¥...";
Â  Â  Â  Â Â 
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const res = await fetch(`https://api.github.com/gists/${ghConfig.gistId}`, {
Â  Â  Â  Â  Â  Â  Â  Â  headers: { "Authorization": `token ${ghConfig.token}` }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  if(!res.ok) throw new Error("è¿æ¥å¤±è´¥");
Â  Â  Â  Â  Â  Â  const json = await res.json();
Â  Â  Â  Â  Â  Â  const fileContent = json.files["data.json"].content;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // åˆå¹¶é€»è¾‘ï¼šç®€å•è¦†ç›– (å®é™…ä½¿ç”¨å»ºè®®æ›´å°å¿ƒ)
Â  Â  Â  Â  Â  Â  data = JSON.parse(fileContent);
Â  Â  Â  Â  Â  Â  localStorage.setItem('my_research_v4', JSON.stringify(data));
Â  Â  Â  Â  Â  Â  renderList();
Â  Â  Â  Â  Â  Â  if(currentId) loadDetail(currentId); // åˆ·æ–°å½“å‰é¡µ
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  msg.innerText = "â˜ï¸ å·²åŒæ­¥åˆ°æœ€æ–° (" + new Date().toLocaleTimeString() + ")";
Â  Â  Â  Â  Â  Â  if(!silent) alert("æ‹‰å–æˆåŠŸï¼");
Â  Â  Â  Â  } catch(e) {
Â  Â  Â  Â  Â  Â  msg.innerText = "âŒ åŒæ­¥å¤±è´¥";
Â  Â  Â  Â  Â  Â  if(!silent) alert("åŒæ­¥å¤±è´¥: " + e.message);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // æ¨é€æ•°æ® (Save)
Â  Â  async function syncPush() {
Â  Â  Â  Â  if(!ghConfig.token) return alert("è¯·å…ˆé…ç½®å¯†é’¥");
Â  Â  Â  Â  const msg = document.getElementById('cloud-msg');
Â  Â  Â  Â  msg.innerText = "â¬†ï¸ æ­£åœ¨ä¸Šä¼ ...";
Â  Â  Â  Â Â 
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const payload = {
Â  Â  Â  Â  Â  Â  Â  Â  files: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "data.json": { content: JSON.stringify(data, null, 2) }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  const res = await fetch(`https://api.github.com/gists/${ghConfig.gistId}`, {
Â  Â  Â  Â  Â  Â  Â  Â  method: "PATCH",
Â  Â  Â  Â  Â  Â  Â  Â  headers: {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "Authorization": `token ${ghConfig.token}`,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  "Content-Type": "application/json"
Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify(payload)
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  if(!res.ok) throw new Error("ä¸Šä¼ å¤±è´¥");
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  msg.innerText = "â˜ï¸ ä¸Šä¼ æˆåŠŸ (" + new Date().toLocaleTimeString() + ")";
Â  Â  Â  Â  } catch(e) {
Â  Â  Â  Â  Â  Â  msg.innerText = "âŒ ä¸Šä¼ å¤±è´¥";
Â  Â  Â  Â  Â  Â  alert("ä¸Šä¼ å¤±è´¥: " + e.message);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // --- 2. æ¸²æŸ“ä¸ç¼–è¾‘ (å¤ç”¨é€»è¾‘) ---
Â  Â  function renderContent(text) {
Â  Â  Â  Â  if (!text) return "";
Â  Â  Â  Â  let html = marked.parse(text);
Â  Â  Â  Â  const envs = [ { tags: ['thm','theorem'], name: 'Theorem', class: 'env-thm' }, { tags: ['conjecture','conj'], name: 'Conjecture', class: 'env-conj' }, { tags: ['lemma'], name: 'Lemma', class: 'env-lemma' }, { tags: ['defn'], name: 'Definition', class: 'env-defn' }, { tags: ['proof'], name: 'Proof', class: 'env-proof', isProof: true } ];
Â  Â  Â  Â  envs.forEach(env => {
Â  Â  Â  Â  Â  Â  env.tags.forEach(tag => {
Â  Â  Â  Â  Â  Â  Â  Â  const regex = new RegExp(`\\\\begin\\{${tag}\\}([\\s\\S]*?)\\\\end\\{${tag}\\}`, 'gi');
Â  Â  Â  Â  Â  Â  Â  Â  html = html.replace(regex, (m, c) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  c = c.replace(/^<p>|<\/p>$/g, '');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return env.isProof ? `<div class="${env.class}"><span class="env-title">${env.name}.</span> <span class="env-content">${c}</span> <span class="qed-symbol">â—¼</span></div>` : `<div class="env-block ${env.class}"><span class="env-title">${env.name}.</span> <span class="env-content">${c}</span></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  Â  Â  return html;
Â  Â  }

Â  Â  function renderList() {
Â  Â  Â  Â  var listHtml = '';
Â  Â  Â  Â  for (var i = 0; i < data.length; i++) {
Â  Â  Â  Â  Â  Â  var item = data[i];
Â  Â  Â  Â  Â  Â  var activeClass = (item.id === currentId) ? 'active' : '';
Â  Â  Â  Â  Â  Â  listHtml += `<li class="item ${activeClass}" onclick="loadDetail(${item.id})"><div class="item-title">${escapeHtml(item.title)}</div><div class="item-date">${new Date(item.date).toLocaleDateString()}</div></li>`;
Â  Â  Â  Â  }
Â  Â  Â  Â  document.getElementById('list').innerHTML = listHtml;
Â  Â  }

Â  Â  function loadDetail(id) {
Â  Â  Â  Â  currentId = id;
Â  Â  Â  Â  var item = data.find(x => x.id === id);
Â  Â  Â  Â  if (!item) return;

Â  Â  Â  Â  document.getElementById('empty-msg').style.display = 'none';
Â  Â  Â  Â  document.getElementById('detail-view').style.display = 'flex';
Â  Â  Â  Â  document.getElementById('editor-container').style.display = 'none';
Â  Â  Â  Â  document.getElementById('d-title').innerText = item.title;
Â  Â  Â  Â  document.getElementById('d-date').innerText = new Date(item.date).toLocaleString();
Â  Â  Â  Â  document.getElementById('d-desc').innerHTML = renderContent(item.desc);
Â  Â  Â  Â Â 
Â  Â  Â  Â  var ansHtml = '';
Â  Â  Â  Â  if (item.answers.length === 0) ansHtml = '<div style="color:#999; font-style:italic; text-align:center;">æš‚æ— ç¬”è®°</div>';
Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  Â  item.answers.forEach((ans, idx) => {
Â  Â  Â  Â  Â  Â  Â  Â  ansHtml += `<div class="ans-item"><div class="markdown-body">${renderContent(ans.text)}</div><div class="ans-meta"><span>${new Date(ans.date).toLocaleString()}</span><span><button class="btn-link" style="color:#de350b" onclick="delAns(${idx})">åˆ é™¤</button></span></div></div>`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  document.getElementById('ans-list').innerHTML = ansHtml;
Â  Â  Â  Â  renderList();
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (window.MathJax) MathJax.typesetPromise([document.getElementById('d-desc'), document.getElementById('ans-list')]);
Â  Â  Â  Â  noteEditor.setValue("");
Â  Â  Â  Â  setTimeout(() => noteEditor.refresh(), 100);
Â  Â  Â  Â  document.getElementById('note-live-preview').innerHTML = 'é¢„è§ˆåŒºåŸŸ';
Â  Â  }

Â  Â  function enterEditMode() {
Â  Â  Â  Â  var item = data.find(x => x.id === currentId);
Â  Â  Â  Â  document.getElementById('detail-view').style.display = 'none';
Â  Â  Â  Â  document.getElementById('editor-container').style.display = 'flex';
Â  Â  Â  Â  document.getElementById('editor-title').value = item.title;
Â  Â  Â  Â  mainEditor.setValue(item.desc);
Â  Â  Â  Â  setTimeout(() => mainEditor.refresh(), 100);
Â  Â  Â  Â  updateMainPreview();
Â  Â  }

Â  Â  function updateMainPreview() {
Â  Â  Â  Â  const text = mainEditor.getValue();
Â  Â  Â  Â  const previewEl = document.getElementById('editor-preview');
Â  Â  Â  Â  previewEl.innerHTML = renderContent(text);
Â  Â  Â  Â  clearTimeout(debounceTimer);
Â  Â  Â  Â  debounceTimer = setTimeout(() => { if (window.MathJax) MathJax.typesetPromise([previewEl]); }, 300);
Â  Â  }
Â  Â Â 
Â  Â  function updateNotePreview() {
Â  Â  Â  Â  const text = noteEditor.getValue();
Â  Â  Â  Â  const previewEl = document.getElementById('note-live-preview');
Â  Â  Â  Â  previewEl.innerHTML = renderContent(text) || "é¢„è§ˆåŒºåŸŸ";
Â  Â  Â  Â  clearTimeout(debounceTimer);
Â  Â  Â  Â  debounceTimer = setTimeout(() => { if (window.MathJax) MathJax.typesetPromise([previewEl]); }, 300);
Â  Â  }

Â  Â  function saveEdit() {
Â  Â  Â  Â  var item = data.find(x => x.id === currentId);
Â  Â  Â  Â  item.title = document.getElementById('editor-title').value;
Â  Â  Â  Â  item.desc = mainEditor.getValue();
Â  Â  Â  Â  saveAndPush();
Â  Â  Â  Â  exitEditMode();
Â  Â  Â  Â  loadDetail(currentId);
Â  Â  }
Â  Â  function addAns() {
Â  Â  Â  Â  var txt = noteEditor.getValue(); if (!txt) return;
Â  Â  Â  Â  var item = data.find(x => x.id === currentId);
Â  Â  Â  Â  item.answers.push({ text: txt, date: new Date().toISOString() });
Â  Â  Â  Â  saveAndPush();
Â  Â  Â  Â  loadDetail(currentId);
Â  Â  }
Â  Â  function saveNew() {
Â  Â  Â  Â  var t = document.getElementById('m-title').value; var d = document.getElementById('m-desc').value; if (!t) return alert('æ ‡é¢˜ä¸èƒ½ä¸ºç©º');
Â  Â  Â  Â  var newItem = { id: Date.now(), title: t, desc: d, date: new Date().toISOString(), answers: [] };
Â  Â  Â  Â  data.unshift(newItem);
Â  Â  Â  Â  saveAndPush();
Â  Â  Â  Â  document.getElementById('modal').style.display = 'none';
Â  Â  Â  Â  document.getElementById('m-title').value = ''; document.getElementById('m-desc').value = '';
Â  Â  Â  Â  loadDetail(newItem.id);
Â  Â  }
Â  Â  function delAns(idx) { if(confirm('åˆ é™¤æ­¤ç¬”è®°ï¼Ÿ')) { var item = data.find(x => x.id === currentId); item.answers.splice(idx, 1); saveAndPush(); loadDetail(currentId); } }
Â  Â  function doDelete() { if(confirm('åˆ é™¤æ•´ä¸ªé—®é¢˜ï¼Ÿ')) { data = data.filter(x => x.id !== currentId); saveAndPush(); if(data.length > 0) loadDetail(data[0].id); else location.reload(); } }

Â  Â  function exitEditMode() { document.getElementById('editor-container').style.display = 'none'; document.getElementById('detail-view').style.display = 'flex'; }
Â  Â  function openModal() { document.getElementById('modal').style.display = 'flex'; }
Â  Â  function escapeHtml(text) { if (!text) return text; return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
Â  Â  function saveAndPush() {
Â  Â  Â  Â  localStorage.setItem('my_research_v4', JSON.stringify(data));
Â  Â  Â  Â  syncPush(); // è‡ªåŠ¨æ¨é€
Â  Â  }
Â  Â Â 
Â  Â  // å¯¼å‡ºå•é¢˜
Â  Â  function doExport() {
Â  Â  Â  Â  var item = data.find(x => x.id === currentId);
Â  Â  Â  Â  if (!item) return;
Â  Â  Â  Â  var content = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>' + escapeHtml(item.title) + '</title>';
Â  Â  Â  Â  content += '<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"><\/script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" async><\/script><script>MathJax={tex:{inlineMath:[["$","$"],["\\\\(","\\\\)"]]}}<\/script>';
Â  Â  Â  Â  content += '<style>body{max-width:900px;margin:20px auto;font-family:sans-serif;padding:20px;line-height:1.6;color:#333} .ans{background:#f9f9f9;padding:15px;border:1px solid #eee;margin-bottom:10px;border-radius:5px;} .env-block {margin:15px 0;padding:15px;border-radius:4px;text-align:left;background:#e6effc;border-left:4px solid #0052cc;font-style:italic;} .env-title {font-weight:bold;color:#0052cc;margin-right:5px;font-style:normal;} .env-conj {background:#fff7e6;border-left-color:#ff9900;} .env-conj .env-title {color:#d97706;} blockquote {border-left:4px solid #ddd;padding-left:15px;color:#777;} code {background:#f4f4f4;padding:2px 5px;border-radius:3px;font-family:monospace;} pre {background:#f4f4f4;padding:10px;border-radius:5px;overflow-x:auto;} h1,h2,h3 {border-bottom:1px solid #eee;padding-bottom:10px;}</style></head><body>';
Â  Â  Â  Â  content += '<h1 style="color:#0052cc">' + escapeHtml(item.title) + '</h1><p style="color:#888">Exported: ' + new Date().toLocaleString() + '</p><div id="desc-content"></div><h3 style="margin-top:40px">ç¬”è®°ä¸è®¨è®º</h3><div id="ans-container"></div>';
Â  Â  Â  Â  content += '<script>var rawDesc=' + JSON.stringify(item.desc) + '; var rawAnswers=' + JSON.stringify(item.answers) + '; function render(t){var h=marked.parse(t); return h.replace(/\\\\begin{thm}([\\s\\S]*?)\\\\end{thm}/gi, "<div class=\'env-block\'><span class=\'env-title\'>Theorem.</span>$1</div>").replace(/\\\\begin{conj}([\\s\\S]*?)\\\\end{conj}/gi, "<div class=\'env-block env-conj\'><span class=\'env-title\'>Conjecture.</span>$1</div>");} document.getElementById("desc-content").innerHTML=render(rawDesc); var ah=""; rawAnswers.forEach(function(a){ ah+="<div class=\'ans\'>"+render(a.text)+"<div style=\'font-size:12px;color:#999;margin-top:5px\'>"+new Date(a.date).toLocaleString()+"</div></div>"; }); document.getElementById("ans-container").innerHTML=ah; <\/script></body></html>';
Â  Â  Â  Â  var blob = new Blob([content], { type: 'text/html;charset=utf-8' });
Â  Â  Â  Â  var url = URL.createObjectURL(blob);
Â  Â  Â  Â  var a = document.createElement('a'); a.href = url; a.download = 'Research-' + item.title + '.html'; a.click();
Â  Â  }
</script>
</body>
</html>
