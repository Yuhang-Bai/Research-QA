<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§‘ç ”ç®¡ç†å™¨ v7 (ä¿®å¤ç‰ˆ)</title>
    
    <!-- ä¾èµ–åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']], processEscapes: true },
            startup: { typeset: false }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    
    <!-- CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/markdown/markdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
    
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; height: 100vh; background: #f4f5f7; overflow: hidden; color: #333; }
        
        /* UI åŸºç¡€ */
        .bar-btn { background: #444; border: 1px solid #666; color: white; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 8px;}
        .bar-btn:hover { background: #666; }
        .bar-btn.primary { background: #0366d6; border-color: #0366d6; }
        .bar-btn.warn { background: #d73a49; border-color: #d73a49; }

        /* é¡¶éƒ¨æ  */
        #status-bar { position: absolute; top: 0; left: 0; width: 100%; height: 40px; background: #24292e; color: #fff; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-sizing: border-box; z-index: 100; }

        /* å¸ƒå±€ */
        #container { display: flex; width: 100%; height: 100%; padding-top: 40px; box-sizing: border-box; }
        #sidebar { width: 280px; background: #f9f9f9; display: flex; flex-direction: column; flex-shrink: 0; border-right: 1px solid #ddd; }
        #resizer { width: 5px; background: #ddd; cursor: col-resize; z-index: 10; transition: background 0.2s; }
        #resizer:hover, #resizer.resizing { background: #0366d6; }
        #main { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: white; position: relative; }

        /* åˆ—è¡¨ */
        .sidebar-header { padding: 10px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; background: #fff;}
        #list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        .item { padding: 12px 10px; border-bottom: 1px solid #eee; cursor: pointer; border-left: 4px solid transparent; display: flex; align-items: flex-start; gap: 8px; user-select: none;}
        .item:hover { background: #eaeaea; }
        .item.active { background: #e6effc; border-left: 4px solid #0052cc; }
        .item.dragging { opacity: 0.5; background: #ccc; }
        
        .pin-icon { color: #ccc; font-size: 12px; cursor: pointer; }
        .pin-icon.pinned { color: #d97706; }
        .share-icon { font-size: 12px; margin-left: 5px; color: #00875a; display:none; }
        .item.shared .share-icon { display: inline; }

        .item-title { font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }

        /* è¯¦æƒ…ä¸ç¼–è¾‘ */
        #detail-view { display: none; width: 100%; height: 100%; flex-direction: column; overflow-y: auto; }
        .content-wrap { padding: 30px 50px; max-width: 900px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        .markdown-body { line-height: 1.7; font-size: 16px; color: #24292e; }
        .markdown-body pre { background: #f6f8fa; padding: 15px; border-radius: 6px; overflow: auto; }
        
        #editor-layer { display: none; position: fixed; inset: 0; background: white; z-index: 200; flex-direction: column; }
        .CodeMirror { height: 100%; font-family: "SFMono-Regular", Consolas, monospace; font-size: 15px; }
        .CodeMirror-hints { z-index: 3000; } /* ç¡®ä¿æç¤ºæ¡†åœ¨é¡¶å±‚ */

        /* è‡ªå®šä¹‰ LaTeX ç¯å¢ƒæ ·å¼ */
        .env-block { margin: 1em 0; padding: 15px; border-radius: 4px; border-left: 4px solid #555; background: #f9f9f9; }
        
        .env-thm { background: #e6effc; border-left-color: #0052cc; } .env-thm .env-title { color: #0052cc; font-weight: bold; }
        .env-conj { background: #fff7e6; border-left-color: #ff9900; } .env-conj .env-title { color: #d97706; }
        .env-lemma { background: #f4f5f7; border-left-color: #5e6c84; } .env-lemma .env-title { color: #42526e; font-weight: bold; }
        .env-defn { background: #e3fcef; border-left-color: #00875a; } .env-defn .env-title { color: #006644; font-weight: bold; }
        
        .env-proof { background: #fff; border-left: 2px solid #ddd; color: #333; font-style: normal; } 
        .env-proof .env-title { font-style: italic; font-weight: bold; color:#555; }

        /* åä½œæ¨ªå¹… */
        #collab-banner { display: none; background: #e6ffed; color: #0052cc; padding: 8px; text-align: center; border-bottom: 1px solid #bfebbb; font-size: 13px; }

        /* Loading & Modal */
        #loading { display: flex; position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 2000; justify-content: center; align-items: center; font-weight: bold; font-size: 18px; color: #333; flex-direction: column; gap: 10px; }
        .modal { display: none; position: fixed; inset: 0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index: 1000; }
        .modal-box { background:white; padding:25px; width:450px; border-radius:8px; display:flex; flex-direction:column; gap:15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .inp { padding: 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%; box-sizing: border-box; }
        
        /* ä»…æ‰€æœ‰è€…å¯è§ */
        body.visitor-mode .only-owner { display: none !important; }
        body.visitor-mode #sidebar { display: none; }
        body.visitor-mode #resizer { display: none; }
    </style>
</head>
<body>

<div id="loading">
    <div>ğŸš€ æ­£åœ¨è¿æ¥äº‘ç«¯...</div>
    <div id="loading-tip" style="font-size:12px; font-weight:normal; color:#666;"></div>
</div>

<!-- é¡¶éƒ¨æ  -->
<div id="status-bar">
    <div style="display:flex; align-items:center; gap:10px;">
        <span id="app-title" style="font-weight:bold;">ç§‘ç ”ç®¡ç†å™¨ v7</span>
        <span id="sync-status" style="font-size:12px; color:#aaa;">âšª å°±ç»ª</span>
    </div>
    <div id="auth-controls">
        <button class="bar-btn" onclick="syncPull()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
        <button class="bar-btn warn" onclick="openConfig()">âš™ï¸ å¯†é’¥</button>
    </div>
</div>

<div id="container">
    <!-- å·¦ä¾§ -->
    <div id="sidebar">
        <div class="sidebar-header">
            <h3>ğŸ“š é—®é¢˜åº“</h3>
            <button class="bar-btn primary" onclick="createNewLocal()">+</button>
        </div>
        <ul id="list"></ul>
    </div>
    <div id="resizer"></div>

    <!-- ä¸»åŒºåŸŸ -->
    <div id="main">
        <div id="collab-banner">ğŸŒ <b>å®æ—¶åä½œä¸­</b>ï¼šæ­¤å†…å®¹å­˜å‚¨åœ¨ç‹¬ç«‹çš„äº‘ç«¯é“¾æ¥ï¼Œæ‚¨ä¸åˆä½œè€…çš„ä¿®æ”¹å°†å®æ—¶äº’é€šã€‚</div>
        
        <div id="empty-msg" style="text-align:center; color:#888; margin-top:20vh;">
            <h2>è¯·é€‰æ‹©ä¸€ä¸ªé—®é¢˜</h2>
        </div>

        <div id="detail-view">
            <div class="content-wrap">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:10px; border-bottom:1px solid #eee;">
                    <span id="d-date" style="color:#888; font-size:12px;"></span>
                    <div style="display:flex; gap:10px;">
                        <button class="bar-btn only-owner" id="btn-share" onclick="manageCollaboration()">ğŸ”— ç®¡ç†åä½œ</button>
                        <button class="bar-btn" onclick="openEditor('problem')">âœï¸ ç¼–è¾‘é—®é¢˜</button>
                        <button class="bar-btn warn only-owner" onclick="deleteItem()">ğŸ—‘ï¸</button>
                    </div>
                </div>
                <h1 id="d-title" style="color:#0052cc; margin-top:0;"></h1>
                <div id="d-desc" class="markdown-body"></div>
            </div>

            <div style="background:#f4f5f7; padding:10px 50px; font-weight:bold; font-size:13px; color:#666; margin-top:20px;">
                ç¬”è®° / è®¨è®º
            </div>

            <div class="content-wrap" style="padding-top:20px; padding-bottom:50px;">
                <div id="ans-list"></div>
                <div style="text-align:center; margin-top:30px;">
                    <button class="bar-btn primary" style="padding:10px 30px;" onclick="openEditor('note')">â• æ·»åŠ å…¨å±ç¬”è®°</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å…¨å±ç¼–è¾‘å™¨ -->
<div id="editor-layer">
    <div style="height:50px; background:#f4f5f7; display:flex; align-items:center; justify-content:space-between; padding:0 20px; border-bottom:1px solid #ddd;">
        <span id="editor-title-disp" style="font-weight:bold;">ç¼–è¾‘</span>
        <input id="editor-title-inp" class="inp" style="width:300px; display:none;" placeholder="æ ‡é¢˜">
        <div>
            <button class="bar-btn" onclick="document.getElementById('editor-layer').style.display='none'">å–æ¶ˆ</button>
            <button class="bar-btn primary" onclick="saveEditor()">ğŸ’¾ ä¿å­˜ (Ctrl+S)</button>
        </div>
    </div>
    <div style="flex:1; display:flex;">
        <div style="width:50%; height:100%; border-right:1px solid #ddd;">
            <textarea id="code-editor"></textarea>
        </div>
        <div style="width:50%; height:100%; padding:20px; overflow-y:auto; background:#fff;">
            <div id="editor-preview" class="markdown-body"></div>
        </div>
    </div>
</div>

<!-- Config Modal -->
<div id="config-modal" class="modal">
    <div class="modal-box">
        <h3 style="margin:0">âš™ï¸ è¿æ¥è®¾ç½®</h3>
        <div style="background:#fff3cd; color:#856404; padding:10px; font-size:12px; border-radius:4px;">
            âš ï¸ <b>æ³¨æ„ï¼š</b> è‹¥å‡ºç° "Failed to fetch"ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼ˆéœ€è¦èƒ½è®¿é—® GitHub APIï¼‰æˆ– Token æ ¼å¼ã€‚
        </div>
        <div>
            <label style="font-size:12px; font-weight:bold;">GitHub Token (å¿…å¡«):</label>
            <input class="inp" id="cfg-token" type="password" placeholder="æ ¼å¼å¦‚: ghp_xxxxxxxxxxxx">
            <div style="font-size:11px; color:#888; margin-top:3px;">è¯·ç¡®ä¿ Token ç”Ÿæˆæ—¶å‹¾é€‰äº† <b>gist</b> æƒé™ã€‚</div>
        </div>
        <div>
            <label style="font-size:12px; font-weight:bold;">ä¸»æ•°æ®åº“ Gist ID:</label>
            <input class="inp" id="cfg-id" placeholder="åˆæ¬¡ä½¿ç”¨è¯·ç•™ç©ºï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆ">
        </div>
        <div style="text-align:right;">
            <button class="bar-btn" onclick="document.getElementById('config-modal').style.display='none'">å…³é—­</button>
            <button class="bar-btn primary" onclick="saveConfig()">ä¿å­˜å¹¶æµ‹è¯•è¿æ¥</button>
        </div>
    </div>
</div>

<script>
    // --- æ ¸å¿ƒå˜é‡ ---
    const CFG_KEY = 'v7_config';
    let ghConfig = JSON.parse(localStorage.getItem(CFG_KEY)) || { token: '', mainGistId: '' };
    
    // è¡¥å…¨å…³é”®è¯åˆ—è¡¨
    const LATEX_KEYWORDS = [ 
        { text: "\\begin{thm}\n\n\\end{thm}", displayText: "\\begin{thm} (Theorem)" }, 
        { text: "\\begin{conj}\n\n\\end{conj}", displayText: "\\begin{conj} (Conjecture)" },
        { text: "\\begin{defn}\n\n\\end{defn}", displayText: "\\begin{defn} (Definition)" },
        { text: "\\begin{lemma}\n\n\\end{lemma}", displayText: "\\begin{lemma} (Lemma)" },
        { text: "\\begin{proof}\n\n\\end{proof}", displayText: "\\begin{proof} (Proof)" },
        "\\alpha", "\\beta", "\\gamma", "\\delta", "\\epsilon", "\\lambda", "\\sum", "\\prod", "\\int", "\\infty", "\\frac{}{}", "\\sqrt{}"
    ];

    let db = { items: [] };
    let currentId = null;
    let currentItemData = null; 
    let editorMode = 'problem'; 
    let cmEditor;

    const urlParams = new URLSearchParams(window.location.search);
    const visitorGistId = urlParams.get('gist');

    // --- åˆå§‹åŒ– ---
    window.onload = async function() {
        initUI();
        if (visitorGistId) {
            enterVisitorMode();
        } else {
            if (ghConfig.token && ghConfig.mainGistId) {
                await syncPullMain();
            } else {
                document.getElementById('loading').style.display = 'none';
                openConfig();
            }
        }
    };

    function initUI() {
        cmEditor = CodeMirror.fromTextArea(document.getElementById("code-editor"), {
            mode: "markdown", 
            lineNumbers: true, 
            lineWrapping: true, 
            extraKeys: { "Ctrl-S": saveEditor, "Ctrl-Space": "autocomplete" }
        });
        
        cmEditor.on("inputRead", function(cm, change) { 
            if (change.text[0].match(/[\\a-zA-Z]/)) {
                CodeMirror.commands.autocomplete(cm, null, { completeSingle: false }); 
            }
        });

        cmEditor.on("change", () => {
            const val = cmEditor.getValue();
            document.getElementById('editor-preview').innerHTML = renderContent(val);
            if(window.MathJax) MathJax.typesetPromise([document.getElementById('editor-preview')]);
        });
        
        CodeMirror.registerHelper("hint", "markdown", function(editor) {
            var cur = editor.getCursor(); 
            var token = editor.getTokenAt(cur);
            var start = token.start; 
            var end = cur.ch; 
            var word = token.string.slice(0, end - start);
            
            if (word === "" && token.string === "\\") {
                word = "\\";
                start = token.start;
            }

            var list = LATEX_KEYWORDS.filter(function(item) { 
                var text = (typeof item === "string") ? item : item.displayText || item.text; 
                return text.indexOf(word) >= 0; 
            });
            return { list: list, from: CodeMirror.Pos(cur.line, start), to: CodeMirror.Pos(cur.line, end) };
        });

        // æ‹–æ‹½åˆ†æ 
        const resizer = document.getElementById('resizer');
        const sidebar = document.getElementById('sidebar');
        resizer.addEventListener('mousedown', () => {
            document.addEventListener('mousemove', resize, false);
            document.addEventListener('mouseup', stopResize, false);
        });
        function resize(e) { sidebar.style.width = Math.max(150, Math.min(600, e.clientX)) + 'px'; }
        function stopResize() { document.removeEventListener('mousemove', resize, false); document.removeEventListener('mouseup', stopResize, false); }
    }

    function renderContent(text) {
        if (!text) return "";
        let html = marked.parse(text);
        
        const envs = [ 
            { tags: ['thm','theorem'], name: 'Theorem', class: 'env-thm' }, 
            { tags: ['conjecture','conj'], name: 'Conjecture', class: 'env-conj' }, 
            { tags: ['lemma'], name: 'Lemma', class: 'env-lemma' },
            { tags: ['defn','definition'], name: 'Definition', class: 'env-defn' },
            { tags: ['proof'], name: 'Proof', class: 'env-proof', isProof: true } 
        ];

        envs.forEach(env => {
            env.tags.forEach(tag => {
                const regex = new RegExp(`\\\\begin\\{${tag}\\}([\\s\\S]*?)\\\\end\\{${tag}\\}`, 'gi');
                html = html.replace(regex, (m, c) => {
                    c = c.replace(/^\s*<p>|<\/p>\s*$/g, '');
                    let blockHtml = "";
                    if (env.isProof) {
                        blockHtml = `<div class="${env.class}"><span class="env-title">${env.name}.</span> <span class="env-content">${c}</span> <span style="float:right">â—¼</span></div>`;
                    } else {
                        blockHtml = `<div class="env-block ${env.class}"><span class="env-title">${env.name}.</span> <span class="env-content">${c}</span></div>`;
                    }
                    return blockHtml;
                });
            });
        });

        html = html.replace(/<p>(<div class="env-.*?>[\s\S]*?<\/div>)<\/p>/gi, '$1');

        return html;
    }

    async function syncPull() {
        if (visitorGistId) {
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('loading-tip').innerText = "åˆ·æ–°åä½œå†…å®¹...";
            try {
                await loadSharedItem(visitorGistId);
                setMsg("å°±ç»ª");
            } catch(e) {
                handleNetworkError(e);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        } else {
            await syncPullMain();
        }
    }

    // --- æ¨¡å¼ A: è®¿å®¢æ¨¡å¼ ---
    async function enterVisitorMode() {
        document.body.classList.add('visitor-mode');
        document.getElementById('auth-controls').innerHTML = ''; 
        document.getElementById('app-title').innerText = "åä½œç¼–è¾‘å™¨ (è®¿å®¢)";
        
        if (!ghConfig.token) {
            const t = prompt("è¯·è¾“å…¥ GitHub Token ä»¥å¯ç”¨ç¼–è¾‘æƒé™ï¼š");
            if(t) ghConfig.token = t;
        }
        await loadSharedItem(visitorGistId);
    }

    // --- æ¨¡å¼ B: ä¸»äººæ¨¡å¼ ---
    async function syncPullMain() {
        if(!ghConfig.token || !ghConfig.mainGistId) return;
        setMsg("æ­£åœ¨åŒæ­¥åˆ—è¡¨...");
        document.getElementById('loading').style.display = 'flex';
        
        try {
            const res = await fetch(`https://api.github.com/gists/${ghConfig.mainGistId}`, {
                headers: { "Authorization": `token ${ghConfig.token}` }
            });
            await handleApiError(res); 

            const json = await res.json();
            let fileObj = json.files["main_db.json"];
            if (!fileObj) fileObj = json.files["research_data.json"]; 
            if (!fileObj) {
                const anyJson = Object.keys(json.files).find(k => k.endsWith('.json'));
                if(anyJson) fileObj = json.files[anyJson];
            }

            if (!fileObj) throw new Error("Gist ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ•°æ®æ–‡ä»¶");

            const content = fileObj.content;
            db = JSON.parse(content);
            if(!db.items) {
                if(Array.isArray(db)) db = { items: db };
                else db = { items: [] };
            }
            renderList();
            setMsg("å°±ç»ª");
        } catch(e) {
            handleNetworkError(e);
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    async function handleApiError(res) {
        if (res.ok) return;
        if (res.status === 401) throw new Error("Token æ— æ•ˆ (401)");
        if (res.status === 403) throw new Error("æƒé™è¢«æ‹’ç» (403)");
        if (res.status === 404) throw new Error("Gist ID é”™è¯¯ (404)");
        throw new Error(`è¿æ¥é”™è¯¯ (${res.status})`);
    }

    function handleNetworkError(e) {
        console.error(e);
        let msg = e.message;
        if (msg.includes("Failed to fetch")) {
            msg = "è¿æ¥å¤±è´¥ã€‚è¯·æ£€æŸ¥ç½‘ç»œ(éœ€è®¿é—® GitHub API) æˆ– Tokenã€‚";
        }
        alert("âš ï¸ " + msg);
        setMsg("âŒ è¿æ¥å¤±è´¥");
        openConfig(); 
    }

    async function loadItem(id) {
        currentId = id;
        const itemRef = db.items.find(x => x.id === id);
        if(!itemRef) return;

        document.getElementById('empty-msg').style.display = 'none';
        document.getElementById('detail-view').style.display = 'flex';
        document.getElementById('collab-banner').style.display = 'none';
        document.getElementById('loading').style.display = 'flex';
        document.getElementById('loading-tip').innerText = "åŠ è½½å†…å®¹ä¸­...";

        try {
            if (itemRef.shareId) {
                document.getElementById('collab-banner').style.display = 'block';
                await loadSharedItem(itemRef.shareId); 
            } else {
                currentItemData = itemRef; 
                renderDetailView();
            }
        } catch (e) {
            handleNetworkError(e);
        } finally {
            document.getElementById('loading').style.display = 'none';
            setMsg("å°±ç»ª");
        }
    }

    async function loadSharedItem(gistId) {
        const res = await fetch(`https://api.github.com/gists/${gistId}`, {
            headers: { "Authorization": `token ${ghConfig.token}` }
        });
        await handleApiError(res);
        const json = await res.json();
        const content = json.files["shared_item.json"].content;
        currentItemData = JSON.parse(content);
        if(!currentId) currentId = currentItemData.id;
        renderDetailView();
    }

    function renderDetailView() {
        const d = currentItemData;
        document.getElementById('d-title').innerText = d.title;
        document.getElementById('d-date').innerText = new Date(d.date).toLocaleDateString();
        document.getElementById('d-desc').innerHTML = renderContent(d.desc || "");
        
        const list = document.getElementById('ans-list');
        list.innerHTML = (d.answers || []).map((a, i) => `
            <div style="background:#fafbfc; border:1px solid #eee; padding:15px; margin-bottom:10px; border-radius:5px;">
                <div class="markdown-body">${renderContent(a.text)}</div>
                <div style="font-size:12px; color:#aaa; margin-top:5px; display:flex; justify-content:space-between;">
                    <span>${new Date(a.date).toLocaleString()}</span>
                    <button class="bar-btn warn" onclick="deleteAns(${i})">åˆ é™¤</button>
                </div>
            </div>
        `).join('');
        
        if(!visitorGistId) renderList(); 
        if(window.MathJax) MathJax.typesetPromise();
    }

    // [æ›´æ–°] ç®¡ç†åä½œçš„å…¥å£å‡½æ•°
    async function manageCollaboration() {
        const item = db.items.find(x => x.id === currentId);
        if(!item) return;

        if (item.shareId) {
            const action = prompt("âš™ï¸ åä½œç®¡ç†\nè¯·è¾“å…¥å¯¹åº”æ•°å­—ï¼š\n\n1. ğŸ“‹ è·å–åˆ†äº«é“¾æ¥\n2. ğŸ”Œ åœæ­¢åä½œ (æ–­å¼€è¿æ¥ï¼Œå†…å®¹å­˜å›æœ¬åœ°)", "1");
            if (action === "1") {
                const link = `${location.origin}${location.pathname}?gist=${item.shareId}`;
                prompt("ğŸ”— é“¾æ¥ï¼š", link);
            } else if (action === "2") {
                await stopCollaboration(item);
            }
        } else {
            await convertToShared();
        }
    }

    // [æ–°å¢] åœæ­¢åä½œåŠŸèƒ½
    async function stopCollaboration(item) {
        if(!confirm("âš ï¸ ç¡®å®šåœæ­¢åä½œå—ï¼Ÿ\n\n1. å°†æ–­å¼€ä¸äº‘ç«¯ Gist çš„è¿æ¥ã€‚\n2. å½“å‰æ˜¾ç¤ºçš„æœ€æ–°å†…å®¹å°†ä¿å­˜å›æ‚¨çš„ä¸»æ•°æ®åº“ã€‚\n3. ä¹‹å‰çš„åˆ†äº«é“¾æ¥å°†å¤±æ•ˆï¼ˆæ— æ³•å†åŒæ­¥ï¼‰ã€‚")) return;
        
        setMsg("æ­£åœ¨æ–­å¼€...");
        document.getElementById('loading').style.display = 'flex';
        document.getElementById('loading-tip').innerText = "æ­£åœ¨åˆå¹¶æ•°æ®å›æœ¬åœ°...";
        
        try {
            // 1. Merge remote content into local item (currentItemData has the latest from shared Gist)
            item.desc = currentItemData.desc;
            item.answers = currentItemData.answers;
            item.title = currentItemData.title;
            item.date = currentItemData.date;
            
            // 2. Remove shareId
            delete item.shareId;
            
            // 3. Save Main DB
            await saveMainDB(true);
            
            alert("âœ… å·²å…³é—­åä½œï¼Œå†…å®¹å·²å®Œæ•´å­˜å›æœ¬åœ°ã€‚");
            loadItem(item.id); 
        } catch(e) {
            alert("æ“ä½œå¤±è´¥: " + e.message);
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    // åŸå¼€å¯åä½œåŠŸèƒ½
    async function convertToShared() {
        const item = db.items.find(x => x.id === currentId);
        if(!confirm("âš ï¸ ç¡®å®šå¼€å¯åä½œæ¨¡å¼å—ï¼Ÿ\n\nå¼€å¯åï¼Œæ­¤é—®é¢˜çš„å†…å®¹å°†ç§»åŠ¨åˆ°ç‹¬ç«‹çš„äº‘ç«¯ç©ºé—´ï¼Œä»¥ä¾¿åˆä½œè€…åŒæ­¥ç¼–è¾‘ã€‚")) return;

        setMsg("åˆ›å»ºåä½œç©ºé—´...");
        document.getElementById('loading').style.display = 'flex';

        try {
            const payload = {
                description: `[Shared] ${item.title}`,
                public: false,
                files: { "shared_item.json": { content: JSON.stringify(item, null, 2) } }
            };
            const res = await fetch("https://api.github.com/gists", {
                method: "POST",
                headers: { "Authorization": `token ${ghConfig.token}` },
                body: JSON.stringify(payload)
            });
            await handleApiError(res);
            const json = await res.json();
            const newShareId = json.id;

            item.shareId = newShareId;
            await saveMainDB(true); 
            
            alert("âœ… åä½œæ¨¡å¼å·²å¼€å¯ï¼");
            loadItem(currentId); 

        } catch(e) {
            handleNetworkError(e);
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    function openEditor(mode) {
        editorMode = mode;
        const layer = document.getElementById('editor-layer');
        layer.style.display = 'flex';
        const titleInp = document.getElementById('editor-title-inp');
        
        if (mode === 'problem') {
            titleInp.style.display = 'block';
            titleInp.value = currentItemData.title;
            cmEditor.setValue(currentItemData.desc);
        } else {
            titleInp.style.display = 'none';
            cmEditor.setValue('');
        }
        setTimeout(() => cmEditor.refresh(), 100);
    }

    async function saveEditor() {
        const val = cmEditor.getValue();
        if (editorMode === 'problem') {
            currentItemData.title = document.getElementById('editor-title-inp').value;
            currentItemData.desc = val;
        } else {
            if(!val.trim()) return;
            if(!currentItemData.answers) currentItemData.answers = [];
            currentItemData.answers.push({ text: val, date: new Date().toISOString() });
        }
        currentItemData.date = new Date().toISOString();
        
        document.getElementById('editor-layer').style.display = 'none';
        await performSave();
        renderDetailView();
    }
    
    async function deleteAns(idx) {
        if(!confirm("åˆ é™¤ç¬”è®°?")) return;
        currentItemData.answers.splice(idx, 1);
        await performSave();
        renderDetailView();
    }

    async function deleteItem() {
        if(!currentId) return;
        if(!confirm("âš ï¸ ç¡®å®šè¦å½»åº•åˆ é™¤æ­¤é—®é¢˜å—ï¼Ÿ\næ“ä½œä¸å¯æ¢å¤ã€‚")) return;
        
        document.getElementById('loading').style.display = 'flex';
        document.getElementById('loading-tip').innerText = "æ­£åœ¨äº‘ç«¯åˆ é™¤...";

        try {
            db.items = db.items.filter(x => x.id !== currentId);
            await saveMainDB(true); 
            location.reload(); 
        } catch(e) {
            document.getElementById('loading').style.display = 'none';
            alert("âŒ åˆ é™¤å¤±è´¥: " + e.message + "\nå¯èƒ½æ˜¯ç½‘ç»œè¿æ¥é—®é¢˜æˆ– Token æƒé™ä¸è¶³ã€‚");
        }
    }

    async function performSave() {
        setMsg("æ­£åœ¨ä¿å­˜...");
        try {
            let targetShareId = visitorGistId;
            if (!targetShareId && currentId) {
                const ref = db.items.find(x => x.id === currentId);
                if(ref && ref.shareId) targetShareId = ref.shareId;
            }

            if (targetShareId) {
                await updateGistFile(targetShareId, "shared_item.json", currentItemData);
                if (!visitorGistId) {
                    const ref = db.items.find(x => x.id === currentId);
                    ref.title = currentItemData.title;
                    ref.date = currentItemData.date;
                    saveMainDB(true); 
                }
            } else {
                await saveMainDB(true);
            }
            setMsg("âœ… å·²ä¿å­˜");
        } catch(e) {
            handleNetworkError(e);
        }
    }

    async function saveMainDB(silent = false) {
        if(!silent) setMsg("åŒæ­¥ä¸»åº“...");
        await updateGistFile(ghConfig.mainGistId, "main_db.json", db);
    }

    async function updateGistFile(gistId, filename, dataObj) {
        const res = await fetch(`https://api.github.com/gists/${gistId}`, {
            method: "PATCH",
            headers: { "Authorization": `token ${ghConfig.token}`, "Content-Type": "application/json" },
            body: JSON.stringify({ files: { [filename]: { content: JSON.stringify(dataObj, null, 2) } } })
        });
        await handleApiError(res);
    }

    function renderList() {
        const ul = document.getElementById('list');
        ul.innerHTML = db.items.map((item, idx) => `
            <li class="item ${item.id === currentId ? 'active' : ''} ${item.shareId ? 'shared' : ''}" 
                draggable="true" 
                onclick="loadItem(${item.id})"
                ondragstart="dragStart(event, ${idx})" 
                ondrop="dragDrop(event, ${idx})" 
                ondragover="event.preventDefault()">
                <span class="pin-icon ${item.isPinned?'pinned':''}" onclick="togglePin(event, ${idx})">ğŸ“Œ</span>
                <span class="item-title">${item.title}</span>
                <span class="share-icon" title="åä½œä¸­">ğŸ”—</span>
            </li>
        `).join('');
    }

    function createNewLocal() {
        const newItem = { id: Date.now(), title: "æ–°é—®é¢˜", desc: "", answers: [], date: new Date().toISOString(), isPinned: false };
        db.items.unshift(newItem);
        saveMainDB();
        loadItem(newItem.id);
    }
    
    function dragStart(e, idx) { e.dataTransfer.setData('idx', idx); }
    function dragDrop(e, targetIdx) {
        e.preventDefault();
        const srcIdx = e.dataTransfer.getData('idx');
        const [moved] = db.items.splice(srcIdx, 1);
        db.items.splice(targetIdx, 0, moved);
        renderList();
        saveMainDB(true);
    }
    
    function togglePin(e, idx) {
        e.stopPropagation();
        db.items[idx].isPinned = !db.items[idx].isPinned;
        if(db.items[idx].isPinned) {
            const [item] = db.items.splice(idx, 1);
            db.items.unshift(item);
        }
        renderList();
        saveMainDB(true);
    }

    function openConfig() { 
        document.getElementById('cfg-token').value = ghConfig.token;
        document.getElementById('cfg-id').value = ghConfig.mainGistId;
        document.getElementById('config-modal').style.display = 'flex'; 
    }
    function setMsg(t) { document.getElementById('sync-status').innerText = t; }
    
    async function saveConfig() {
        const t = document.getElementById('cfg-token').value.trim();
        let mid = document.getElementById('cfg-id').value.trim();
        
        if(!t) return alert("Token ä¸èƒ½ä¸ºç©º");
        
        if (mid.includes('/')) {
            const parts = mid.split('/');
            mid = parts[parts.length - 1];
            mid = mid.replace('.git', '');
            alert("æ£€æµ‹åˆ°ç²˜è´´äº† URLï¼Œå·²è‡ªåŠ¨æå– ID: " + mid);
        }

        ghConfig = { token: t, mainGistId: mid };
        
        if (!mid) {
            setMsg("æ­£åœ¨åˆå§‹åŒ–æ•°æ®åº“...");
            document.getElementById('loading').style.display = 'flex';
            try {
                const res = await fetch("https://api.github.com/gists", {
                    method: "POST",
                    headers: { "Authorization": `token ${t}` },
                    body: JSON.stringify({ description: "Research Manager Main DB", public: false, files: { "main_db.json": { content: JSON.stringify({items:[]}) } } })
                });
                await handleApiError(res);
                const json = await res.json();
                mid = json.id;
                alert("âœ… è¿æ¥æˆåŠŸï¼å·²è‡ªåŠ¨åˆ›å»ºæ–°æ•°æ®åº“ ID: " + mid);
                ghConfig.mainGistId = mid;
            } catch(e) {
                handleNetworkError(e);
                document.getElementById('loading').style.display = 'none';
                return;
            }
        }
        
        localStorage.setItem(CFG_KEY, JSON.stringify(ghConfig));
        document.getElementById('config-modal').style.display = 'none';
        
        syncPullMain();
    }
</script>
</body>
</html>
