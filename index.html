<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§‘ç ”ç®¡ç†å™¨</title>
    
    <!-- ä¾èµ–åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        MathJax = {
            loader: { load: ['[tex]/physics', '[tex]/mhchem', '[tex]/color', '[tex]/cancel', '[tex]/boldsymbol'] },
            tex: { 
                packages: {'[+]': ['physics', 'mhchem', 'color', 'cancel', 'boldsymbol']},
                inlineMath: [['$', '$'], ['\\(', '\\)']], 
                displayMath: [['$$', '$$'], ['\\[', '\\]']], 
                processEscapes: true,
                tags: 'ams',
                macros: {
                    R: "{\\mathbb{R}}", N: "{\\mathbb{N}}", Z: "{\\mathbb{Z}}", Q: "{\\mathbb{Q}}", C: "{\\mathbb{C}}",
                    P: "{\\mathbb{P}}", PP: "{\\mathbb{P}}", E: "{\\mathbb{E}}",
                    ex: "\\operatorname{ex}",
                    bf: ["{\\mathbf{#1}}", 1], rm: ["{\\mathrm{#1}}", 1], it: ["{\\mathit{#1}}", 1], cal: ["{\\mathcal{#1}}", 1],
                    cM: "{\\mathcal{M}}", cT: "{\\mathcal{T}}", cS: "{\\mathcal{S}}",
                }
            },
            startup: { typeset: false }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    
    <!-- CodeMirror & Plugins -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/dialog/dialog.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/matchesonscrollbar.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/markdown/markdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/dialog/dialog.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/searchcursor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/search.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/search/jump-to-line.min.js"></script>
    
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; height: 100vh; background: #f4f5f7; overflow: hidden; color: #333; }
        
        /* UI åŸºç¡€ */
        .bar-btn { background: #444; border: 1px solid #666; color: white; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 8px;}
        .bar-btn:hover { background: #666; }
        .bar-btn.primary { background: #0366d6; border-color: #0366d6; }
        .bar-btn.warn { background: #d73a49; border-color: #d73a49; }
        .bar-btn.secondary { background: #f6f8fa; border-color: #d1d5da; color: #24292e; }
        .bar-btn.secondary:hover { background: #e1e4e8; }
        .btn-text { background: none; border: none; color: #0366d6; cursor: pointer; font-size: 12px; padding: 0 5px; }
        .btn-text:hover { text-decoration: underline; }

        #status-bar { position: absolute; top: 0; left: 0; width: 100%; height: 40px; background: #24292e; color: #fff; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-sizing: border-box; z-index: 1000; }

        #container { display: flex; width: 100%; height: 100%; padding-top: 40px; box-sizing: border-box; }
        #sidebar { width: 280px; background: #f9f9f9; display: flex; flex-direction: column; flex-shrink: 0; border-right: 1px solid #ddd; }
        #resizer { width: 5px; background: #ddd; cursor: col-resize; z-index: 10; transition: background 0.2s; user-select: none; }
        #resizer:hover, #resizer.resizing { background: #0366d6; }
        #main { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: white; position: relative; }

        .sidebar-header { padding: 10px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; background: #fff;}
        .search-box { padding: 8px 10px; border-bottom: 1px solid #ddd; background: #fff; }
        .search-inp { width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 13px; }
        .search-inp:focus { border-color: #0366d6; outline: none; }

        #list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        .item { padding: 12px 10px; border-bottom: 1px solid #eee; cursor: pointer; border-left: 4px solid transparent; display: flex; align-items: flex-start; gap: 8px; user-select: none; position: relative; }
        .item:hover { background: #eaeaea; }
        .item.active { background: #e6effc; border-left: 4px solid #0052cc; }
        
        /* [ä¿®æ”¹] åƒåœ¾æ¡¶æ¨¡å¼ä¸‹çš„æ ·å¼ */
        .item.trash-mode { border-left-color: #d73a49; background: #fff0f0; }
        .item.trash-mode:hover { background: #ffeef0; }
        .item.trash-mode .item-title { color: #555; text-decoration: line-through; }

        .item-title { font-weight: 600; font-size: 14px; white-space: normal; overflow: visible; word-break: break-word; flex: 1; line-height: 1.4; }
        .pin-indicator { color: #d97706; font-size: 12px; margin-right: 5px; margin-top: 3px; flex-shrink: 0; }
        .share-icon { font-size: 12px; margin-left: 5px; color: #00875a; display:none; flex-shrink: 0; margin-top: 3px; }
        .item.shared .share-icon { display: inline; }
        
        .trash-badge { font-size: 10px; background: #d73a49; color: white; padding: 1px 4px; border-radius: 3px; margin-left: 5px; vertical-align: middle; }

        #ctx-menu { display: none; position: fixed; z-index: 10001; background: #fff; border: 1px solid #d1d5da; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-radius: 6px; padding: 5px 0; min-width: 120px; }
        .ctx-item { padding: 8px 15px; cursor: pointer; font-size: 13px; color: #333; display: block; }
        .ctx-item:hover { background: #0366d6; color: white; }
        .ctx-item.warn { color: #d73a49; border-top: 1px solid #eee; }
        .ctx-item.warn:hover { background: #d73a49; color: white; }

        #detail-view { display: none; width: 100%; height: 100%; flex-direction: column; overflow-y: auto; position: relative; }
        
        #detail-toolbar { position: sticky; top: 0; z-index: 90; background: rgba(255,255,255,0.98); backdrop-filter: blur(8px); border-bottom: 1px solid #eee; padding: 12px 50px; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; box-shadow: 0 1px 3px rgba(0,0,0,0.05); height: 60px; box-sizing: border-box; }

        .content-wrap { padding: 30px 50px; max-width: 900px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        .markdown-body { font-family: "Times New Roman", "SimSun", "Songti SC", "NSimSun", serif; font-size: 17px; line-height: 1.8; color: #24292e; }
        .markdown-body pre { background: #f6f8fa; padding: 15px; border-radius: 6px; overflow: auto; font-family: Consolas, monospace; font-size: 14px;}
        .markdown-body code { font-family: Consolas, monospace; background: rgba(27,31,35,.05); border-radius: 3px; padding: .2em .4em; font-size: 85%; }
        
        .CodeMirror { height: 100%; font-family: "SFMono-Regular", Consolas, monospace; font-size: 15px; }
        .CodeMirror-hints { z-index: 6000; }
        .CodeMirror-dialog { font-size: 13px; padding: 5px 10px; background: #fcfcfc; border-bottom: 1px solid #eee; }
        .CodeMirror-activeline-background { background: #e8f2ff !important; }

        .embedded-editor { display: none; flex-direction: column; border: 1px solid #ddd; border-radius: 6px; margin-top: 15px; background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.1); resize: vertical; overflow: hidden; height: 500px; min-height: 200px; }
        .embedded-editor.fullscreen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100vw; height: 100vh; z-index: 5000; margin: 0; border-radius: 0; resize: none; }
        .embedded-editor .toolbar { padding: 8px 15px; background: #f4f5f7; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
        .embedded-editor .editor-area { display: flex; flex: 1; height: auto; overflow: hidden; }
        .embedded-editor .pane { width: 50%; height: 100%; overflow-y: auto; }
        .embedded-editor .preview-pane { padding: 20px; background: #fff; border-left: 1px solid #eee; cursor: pointer; }
        .embedded-editor .preview-pane:hover { background: #fafafa; } 
        
        #preamble-section { background: #fff8dc; padding: 10px; border-bottom: 1px solid #ddd; display:none; }
        #prob-preamble-inp { width: 100%; height: 80px; box-sizing: border-box; border: 1px solid #ccc; font-family: monospace; font-size: 13px; padding: 5px; border-radius: 4px; resize: vertical; }

        .ans-card { background: #fff; border: 1px solid #e1e4e8; border-radius: 6px; padding: 25px; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); position: relative; transition: all 0.2s ease-in-out; }
        .ans-card:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.08); transform: translateY(-2px); border-color: #d1d5da; }
        .ans-content { transition: max-height 0.3s ease; }
        .ans-content.collapsed { max-height: 200px; overflow: hidden; -webkit-mask-image: linear-gradient(180deg, black 60%, transparent 100%); mask-image: linear-gradient(180deg, black 60%, transparent 100%); }
        .ans-footer { margin-top: 15px; padding-top: 15px; border-top: 1px dashed #eee; display: flex; justify-content: space-between; align-items: center; color: #586069; font-size: 12px; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }

        .thm-proof-wrapper { position: relative; margin-bottom: 1em; }
        .env-block { margin: 1em 0; padding: 15px; border-radius: 4px; border-left: 4px solid #555; background: #f9f9f9; position: relative; transition: box-shadow 0.2s; }
        .env-block.sticky-mode { position: sticky; top: 60px; z-index: 80; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-bottom: 1px solid #ddd; margin-bottom: 0; border-bottom-left-radius: 0; border-bottom-right-radius: 0; opacity: 0.98; max-height: 30vh; overflow-y: auto; }
        .env-thm { background: #e6effc; border-left-color: #0052cc; } .env-thm .env-title { color: #0052cc; font-weight: bold; }
        .env-conj { background: #fff7e6; border-left-color: #ff9900; } .env-conj .env-title { color: #d97706; }
        .env-lemma { background: #f4f5f7; border-left-color: #5e6c84; } .env-lemma .env-title { color: #42526e; font-weight: bold; }
        .env-defn { background: #e3fcef; border-left-color: #00875a; } .env-defn .env-title { color: #006644; font-weight: bold; }
        .env-problem { background: #fff0f0; border-left-color: #d73a49; } .env-problem .env-title { color: #d73a49; font-weight: bold; }
        .env-proof { background: #fff; border-left: 2px solid #ddd; color: #333; font-style: normal; margin: 1em 0; padding-left: 15px;} 
        .env-proof .env-title { font-style: italic; font-weight: bold; color:#555; }
        .env-proof.attached { margin-top: 0; border-top-left-radius: 0; border-top-right-radius: 0; padding-top: 15px; }

        .latex-ref { color: #0052cc; cursor: pointer; text-decoration: none; border-bottom: none; font-weight: bold;}
        .latex-ref:hover { text-decoration: underline; background: #e6effc; }

        #fullscreen-reader { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: #fff; z-index: 2000; flex-direction: column; }
        #fullscreen-reader .header { padding: 15px 30px; background: #f9f9f9; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        #fullscreen-content { flex: 1; overflow-y: auto; padding: 40px; max-width: 900px; margin: 0 auto; width: 100%; box-sizing: border-box; }

        #collab-banner { display: none; background: #e6ffed; color: #0052cc; padding: 8px; text-align: center; border-bottom: 1px solid #bfebbb; font-size: 13px; }
        #loading { display: flex; position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 2000; justify-content: center; align-items: center; font-weight: bold; font-size: 18px; color: #333; flex-direction: column; gap: 10px; }
        .modal { display: none; position: fixed; inset: 0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index: 1000; }
        .modal-box { background:white; padding:25px; width:500px; border-radius:8px; display:flex; flex-direction:column; gap:15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto;}
        .inp { padding: 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%; box-sizing: border-box; }
        
        /* ä»…åœ¨ Trash æ¨¡å¼ä¸‹æ˜¾ç¤ºçš„æç¤º */
        #trash-banner { display:none; background:#d73a49; color:white; padding:5px; text-align:center; font-size:12px; }
        
        body.visitor-mode .only-owner { display: none !important; }
        body.visitor-mode #sidebar { display: none; }
        body.visitor-mode #resizer { display: none; }
    </style>
</head>
<body>

<!-- å³é”®èœå• -->
<div id="ctx-menu">
    <div class="ctx-item" id="ctx-pin" onclick="togglePinFromCtx()">ğŸ“Œ ç½®é¡¶ / å–æ¶ˆç½®é¡¶</div>
    <div class="ctx-item warn" id="ctx-del" onclick="deleteItemFromCtx()">ğŸ—‘ï¸ åˆ é™¤æ­¤é—®é¢˜</div>
    <!-- å›æ”¶ç«™ä¸“ç”¨èœå• -->
    <div class="ctx-item" id="ctx-restore" style="display:none" onclick="restoreItemFromCtx()">â™»ï¸ æ¢å¤</div>
    <div class="ctx-item warn" id="ctx-hard-del" style="display:none" onclick="hardDeleteFromCtx()">âŒ å½»åº•åˆ é™¤</div>
</div>

<div id="loading">
    <div>ğŸš€ æ­£åœ¨è¿æ¥äº‘ç«¯...</div>
    <div id="loading-tip" style="font-size:12px; font-weight:normal; color:#666;"></div>
</div>

<div id="status-bar">
    <div style="display:flex; align-items:center; gap:10px;">
        <span id="app-title" style="font-weight:bold;">ç§‘ç ”ç®¡ç†å™¨</span>
        <span id="sync-status" style="font-size:12px; color:#aaa;">âšª å°±ç»ª</span>
    </div>
    <div id="auth-controls">
        <button class="bar-btn" onclick="syncPull()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
        <button class="bar-btn warn" onclick="openConfig()">âš™ï¸ å¯†é’¥é…ç½®</button>
    </div>
</div>

<div id="container">
    <div id="sidebar">
        <div class="sidebar-header">
            <!-- æ¨¡å¼åˆ‡æ¢åŒº -->
            <div style="display:flex; align-items:center;">
                <h3 style="margin:0; margin-right:10px;" id="sidebar-title">ğŸ“š é—®é¢˜åº“</h3>
            </div>
            <div>
                <button class="bar-btn primary" id="btn-new" onclick="createNewLocal()">+</button>
                <button class="bar-btn secondary" id="btn-trash" onclick="toggleTrashMode()" title="å›æ”¶ç«™">â™»ï¸</button>
            </div>
        </div>
        <div id="trash-banner">ğŸ—‘ï¸ å›æ”¶ç«™æ¨¡å¼ (åªè¯»)</div>
        <div class="search-box">
            <input id="search-input" class="search-inp" placeholder="ğŸ” æœç´¢..." oninput="renderList()">
        </div>
        <ul id="list"></ul>
    </div>
    <div id="resizer"></div>

    <div id="main">
        <div id="collab-banner">ğŸŒ <b>å®æ—¶åä½œä¸­</b>ï¼šå†…å®¹å­˜å‚¨åœ¨ç‹¬ç«‹äº‘ç«¯é“¾æ¥ï¼Œä¿®æ”¹å®æ—¶äº’é€šã€‚</div>
        <div id="empty-msg" style="text-align:center; color:#888; margin-top:20vh;"><h2>è¯·é€‰æ‹©ä¸€ä¸ªé—®é¢˜</h2></div>

        <div id="detail-view">
            <div id="detail-toolbar">
                <span id="d-date" style="color:#888; font-size:12px;"></span>
                <div style="display:flex; gap:10px;" id="normal-toolbar-btns">
                    <button class="bar-btn only-owner" id="btn-share" onclick="manageCollaboration()">ğŸ”— ç®¡ç†åä½œ</button>
                    <button class="bar-btn" onclick="openProblemEditor()">âœï¸ ç¼–è¾‘é—®é¢˜</button>
                    <button class="bar-btn warn only-owner" onclick="deleteItem()">ğŸ—‘ï¸</button>
                </div>
                <div style="display:none; gap:10px;" id="trash-toolbar-btns">
                    <span style="color:#d73a49; font-weight:bold; font-size:12px; display:flex; align-items:center;">ğŸ—‘ï¸ å·²åˆ é™¤å†…å®¹</span>
                    <button class="bar-btn primary" onclick="restoreCurrentItem()">â™»ï¸ æ¢å¤æ­¤é—®é¢˜</button>
                    <button class="bar-btn warn" onclick="hardDeleteCurrentItem()">âŒ å½»åº•åˆ é™¤</button>
                </div>
            </div>

            <div class="content-wrap" style="padding-top: 20px;">
                <div id="problem-display-area">
                    <h1 id="d-title" style="color:#0052cc; margin-top:0;"></h1>
                    <div id="d-desc" class="markdown-body"></div>
                </div>

                <div id="problem-editor-wrapper" class="embedded-editor">
                    <div class="toolbar">
                        <div style="display:flex; align-items:center; gap:10px; width: 60%;">
                            <input id="prob-title-inp" class="inp" style="flex:1; border:1px solid #ccc; padding:6px;" placeholder="é—®é¢˜æ ‡é¢˜">
                            <span style="font-size:11px; color:#666;">(Ctrl-F æŸ¥æ‰¾)</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:5px;">
                            <button class="bar-btn secondary" onclick="togglePreamble()">âˆ‘ å®šä¹‰å®</button>
                            <button class="bar-btn" onclick="toggleFullscreen('problem-editor-wrapper')">â›¶ å…¨å±</button>
                            <button class="bar-btn" onclick="closeProblemEditor()">å–æ¶ˆ</button>
                            <button class="bar-btn primary" onclick="saveProblem()">ğŸ’¾ ä¿å­˜</button>
                        </div>
                    </div>
                    <div id="preamble-section">
                        <div style="font-size:12px; color:#666; margin-bottom:5px;">åœ¨æ­¤è¾“å…¥ LaTeX å®å®šä¹‰ (ä¾‹å¦‚ \newcommand{\myvec}[1]{\mathbf{#1}})ï¼š</div>
                        <textarea id="prob-preamble-inp" placeholder="\def\R{\mathbb{R}}"></textarea>
                    </div>
                    <div class="editor-area">
                        <div class="pane"><textarea id="prob-code-editor"></textarea></div>
                        <div class="pane preview-pane" id="prob-preview-container" title="åŒå‡»æ­¤å¤„è·³è½¬åˆ°å·¦ä¾§å¯¹åº”ä»£ç ">
                            <div id="prob-live-preview" class="markdown-body"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="background:#f4f5f7; padding:10px 50px; font-weight:bold; font-size:13px; color:#666; margin-top:20px;">
                ç¬”è®° / è®¨è®º
            </div>

            <div class="content-wrap" style="padding-top:20px; padding-bottom:50px;">
                <div id="ans-list"></div>
                
                <div id="note-section-footer" style="margin-top:30px;">
                    <div id="note-trigger-btn" style="text-align:center;">
                        <button class="bar-btn primary" style="padding:10px 40px; font-size:14px;" onclick="openNoteEditor()">â• æ·»åŠ ç¬”è®°</button>
                    </div>
                    
                    <div id="note-editor-wrapper" class="embedded-editor">
                        <div class="toolbar">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <span id="note-editor-title" style="font-weight:bold;">ğŸ“ æ–°ç¬”è®°</span>
                                <span style="font-size:11px; color:#666;">(è‡ªåŠ¨ç»§æ‰¿ä¸Šæ–¹å®šä¹‰çš„å®)</span>
                            </div>
                            <div>
                                <button class="bar-btn" onclick="toggleFullscreen('note-editor-wrapper')">â›¶ å…¨å±</button>
                                <button class="bar-btn" onclick="closeNoteEditor()" style="margin-left:10px;">å–æ¶ˆ</button>
                                <button class="bar-btn primary" onclick="saveNote()">ğŸ’¾ æäº¤</button>
                            </div>
                        </div>
                        <div class="editor-area">
                            <div class="pane"><textarea id="note-code-editor"></textarea></div>
                            <div class="pane preview-pane" id="note-preview-container" title="åŒå‡»æ­¤å¤„è·³è½¬åˆ°å·¦ä¾§å¯¹åº”ä»£ç ">
                                <div id="note-live-preview" class="markdown-body"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- å…¨å±é˜…è¯»è¦†ç›–å±‚ -->
<div id="fullscreen-reader">
    <div class="header">
        <span style="font-weight:bold; font-size:18px;">ğŸ“– å…¨å±é˜…è¯»</span>
        <button class="bar-btn" onclick="document.getElementById('fullscreen-reader').style.display='none'">âœ• å…³é—­ (Esc)</button>
    </div>
    <div id="fullscreen-content" class="markdown-body"></div>
</div>

<!-- Config Modal -->
<div id="config-modal" class="modal">
    <div class="modal-box">
        <h3 style="margin:0">âš™ï¸ è®¾ç½®ä¸é…ç½®</h3>
        <div style="background:#f9f9f9; padding:10px; margin-top:10px; border-radius:4px;">
            <label style="font-size:12px; font-weight:bold;">GitHub Token (å¿…å¡«):</label>
            <input class="inp" id="cfg-token" type="password" placeholder="ghp_xxxxxxxxxxxx">
            <div style="font-size:11px; color:#888; margin-top:3px;">éœ€å‹¾é€‰ <b>gist</b> æƒé™ã€‚</div>
        </div>
        
        <div style="background:#f9f9f9; padding:10px; margin-top:10px; border-radius:4px;">
            <label style="font-size:12px; font-weight:bold;">ä¸»æ•°æ®åº“ Gist ID:</label>
            <input class="inp" id="cfg-id" placeholder="åˆæ¬¡ä½¿ç”¨è¯·ç•™ç©º">
        </div>

        <div style="text-align:right; margin-top:15px;">
            <button class="bar-btn" onclick="document.getElementById('config-modal').style.display='none'">å…³é—­</button>
            <button class="bar-btn primary" onclick="saveConfig()">ä¿å­˜å¹¶ç”Ÿæ•ˆ</button>
        </div>
    </div>
</div>

<script>
    const CFG_KEY = 'v7_config';
    let ghConfig = JSON.parse(localStorage.getItem(CFG_KEY)) || { token: '', mainGistId: '' };
    
    const LATEX_KEYWORDS = [
        { text: "\\begin{thm}\\label{thm:}\n\n\\end{thm}", displayText: "thm (å®šç†)" },
        { text: "\\begin{proof}\n\n\\end{proof}", displayText: "proof (è¯æ˜)" },
        { text: "\\begin{lemma}\\label{lem:}\n\n\\end{lemma}", displayText: "lemma (å¼•ç†)" },
        { text: "\\begin{defn}\\label{def:}\n\n\\end{defn}", displayText: "defn (å®šä¹‰)" },
        { text: "\\begin{problem}\\label{prob:}\n\n\\end{problem}", displayText: "problem (é—®é¢˜)" },
        { text: "\\begin{conj}\\label{conj:}\n\n\\end{conj}", displayText: "conj (çŒœæƒ³)" },
        { text: "\\begin{align}\n\n\\end{align}", displayText: "align (å¤šè¡Œå…¬å¼)" },
        { text: "\\textbf{}", displayText: "\\textbf (ç²—ä½“)" },
        { text: "\\textit{}", displayText: "\\textit (æ–œä½“)" },
        { text: "\\emph{}", displayText: "\\emph (å¼ºè°ƒ)" },
        { text: "\\underline{}", displayText: "\\underline (ä¸‹åˆ’çº¿)" },
        { text: "\\texttt{}", displayText: "\\texttt (ä»£ç )" },
        { text: "\\begin{itemize}\n\\item \n\\end{itemize}", displayText: "itemize (åˆ—è¡¨)" },
        { text: "\\begin{enumerate}\n\\item \n\\end{enumerate}", displayText: "enumerate (åºå·åˆ—è¡¨)" },
        { text: "\\frac{}{}", displayText: "\\frac (åˆ†æ•°)" },
        "\\alpha", "\\beta", "\\gamma", "\\lambda", "\\sum", "\\prod", "\\int", "\\infty", "\\ex", "\\PP", "\\boldsymbol"
    ];

    let db = { items: [], trash: [] }; // [ä¿®æ”¹] å¢åŠ  trash
    let currentId = null;
    let currentItemData = null; 
    let probCm, noteCm;
    let docState = { counters: {}, labels: {} };
    let editingNoteIndex = null;
    let contextMenuTargetIdx = null;
    let viewMode = 'active'; // 'active' or 'trash'

    const urlParams = new URLSearchParams(window.location.search);
    const visitorGistId = urlParams.get('gist');

    window.onload = async function() {
        initEditors();
        initContextMenu();
        if (visitorGistId) { enterVisitorMode(); } 
        else { if (ghConfig.token && ghConfig.mainGistId) { await syncPullMain(); } else { document.getElementById('loading').style.display = 'none'; openConfig(); } }
        
        document.addEventListener('keydown', (e) => {
            if(e.key === "Escape") document.getElementById('fullscreen-reader').style.display = 'none';
        });
    };

    function initEditors() {
        const cmConfig = { mode: "markdown", lineNumbers: true, lineWrapping: true, extraKeys: { "Ctrl-Space": "autocomplete" }, styleActiveLine: true };
        
        probCm = CodeMirror.fromTextArea(document.getElementById("prob-code-editor"), { ...cmConfig, extraKeys: { ...cmConfig.extraKeys, "Ctrl-S": saveProblem } });
        setupCmEvents(probCm, 'prob-live-preview', false, () => document.getElementById('prob-preamble-inp').value); 
        document.getElementById('prob-preview-container').addEventListener('dblclick', (e) => jumpToSource(probCm, e));

        noteCm = CodeMirror.fromTextArea(document.getElementById("note-code-editor"), { ...cmConfig, extraKeys: { ...cmConfig.extraKeys, "Ctrl-S": saveNote } });
        setupCmEvents(noteCm, 'note-live-preview', false, () => currentItemData ? currentItemData.preamble : "");
        document.getElementById('note-preview-container').addEventListener('dblclick', (e) => jumpToSource(noteCm, e));

        document.getElementById('prob-preamble-inp').addEventListener('input', () => {
             const val = probCm.getValue();
             const el = document.getElementById('prob-live-preview');
             const preamble = document.getElementById('prob-preamble-inp').value;
             el.innerHTML = renderContent(val, false, preamble, null);
             postProcessDom(el);
             if(window.MathJax && val.trim().length > 0) MathJax.typesetPromise([el]);
        });

        CodeMirror.registerHelper("hint", "markdown", function(editor) {
            var cur = editor.getCursor(), token = editor.getTokenAt(cur), start = token.start, end = cur.ch, word = token.string.slice(0, end - start);
            if (word === "" && token.string === "\\") { word = "\\"; start = token.start; }
            var list = LATEX_KEYWORDS.filter(function(item) { var text = (typeof item === "string") ? item : item.displayText || item.text; return text.indexOf(word) >= 0; });
            var hintResult = { list: list, from: CodeMirror.Pos(cur.line, start), to: CodeMirror.Pos(cur.line, end) };
            CodeMirror.on(hintResult, "pick", function(completion) {
                var text = (typeof completion === "string") ? completion : completion.text;
                var braceIdx = text.indexOf("}{");
                if (braceIdx === -1) braceIdx = text.indexOf("{}");
                if (braceIdx !== -1) { editor.setCursor({ line: cur.line, ch: start + braceIdx + 1 }); }
            });
            return hintResult;
        });

        const resizer = document.getElementById('resizer');
        const sidebar = document.getElementById('sidebar');
        let isResizing = false;
        let animationFrameId;

        resizer.addEventListener('mousedown', (e) => {
            e.preventDefault(); 
            isResizing = true;
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none'; 
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', stopResize);
        });

        function handleMouseMove(e) {
            if (!isResizing) return;
            cancelAnimationFrame(animationFrameId);
            animationFrameId = requestAnimationFrame(() => {
                let newWidth = e.clientX;
                if (newWidth < 150) newWidth = 150;
                if (newWidth > 600) newWidth = 600;
                sidebar.style.width = newWidth + 'px';
            });
        }

        function stopResize() {
            isResizing = false;
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', stopResize);
        }
    }

    function initContextMenu() {
        const menu = document.getElementById('ctx-menu');
        document.addEventListener('click', (e) => { if (!menu.contains(e.target)) menu.style.display = 'none'; });
        document.addEventListener('scroll', () => menu.style.display = 'none', true);
    }

    function openContextMenu(e, idx) {
        e.preventDefault(); e.stopPropagation();
        contextMenuTargetIdx = idx;
        const menu = document.getElementById('ctx-menu');
        
        // æ ¹æ®æ¨¡å¼æ˜¾ç¤ºä¸åŒçš„èœå•é¡¹
        if (viewMode === 'active') {
            document.getElementById('ctx-pin').style.display = 'block';
            document.getElementById('ctx-del').style.display = 'block';
            document.getElementById('ctx-restore').style.display = 'none';
            document.getElementById('ctx-hard-del').style.display = 'none';
        } else {
            document.getElementById('ctx-pin').style.display = 'none';
            document.getElementById('ctx-del').style.display = 'none';
            document.getElementById('ctx-restore').style.display = 'block';
            document.getElementById('ctx-hard-del').style.display = 'block';
        }

        let x = e.clientX, y = e.clientY;
        if (x + 150 > window.innerWidth) x = window.innerWidth - 160;
        if (y + 100 > window.innerHeight) y = window.innerHeight - 110;
        menu.style.left = x + 'px'; menu.style.top = y + 'px'; menu.style.display = 'block';
    }

    // --- å›æ”¶ç«™ä¸æ¨¡å¼åˆ‡æ¢ ---
    function toggleTrashMode() {
        viewMode = viewMode === 'active' ? 'trash' : 'active';
        const btn = document.getElementById('btn-trash');
        const banner = document.getElementById('trash-banner');
        
        if (viewMode === 'trash') {
            btn.innerText = "ğŸ”™";
            btn.title = "è¿”å›é—®é¢˜åº“";
            document.getElementById('sidebar-title').innerText = "ğŸ—‘ï¸ å›æ”¶ç«™";
            document.getElementById('btn-new').style.display = 'none';
            banner.style.display = 'block';
        } else {
            btn.innerText = "â™»ï¸";
            btn.title = "å›æ”¶ç«™";
            document.getElementById('sidebar-title').innerText = "ğŸ“š é—®é¢˜åº“";
            document.getElementById('btn-new').style.display = 'inline-block';
            banner.style.display = 'none';
        }
        // æ¸…ç©ºè¯¦æƒ…è§†å›¾
        currentId = null;
        document.getElementById('detail-view').style.display = 'none';
        document.getElementById('empty-msg').style.display = 'block';
        renderList();
    }

    function togglePinFromCtx() {
        if (contextMenuTargetIdx === null) return;
        const idx = contextMenuTargetIdx;
        document.getElementById('ctx-menu').style.display = 'none';
        db.items[idx].isPinned = !db.items[idx].isPinned;
        if(db.items[idx].isPinned) { const [item] = db.items.splice(idx, 1); db.items.unshift(item); }
        renderList(); saveMainDB(true);
    }

    async function deleteItemFromCtx() {
        if (contextMenuTargetIdx === null) return;
        const idx = contextMenuTargetIdx;
        const item = db.items[idx];
        document.getElementById('ctx-menu').style.display = 'none';
        if(!confirm(`ç¡®è®¤å°† "${item.title}" ç§»å…¥å›æ”¶ç«™ï¼Ÿ`)) return;
        
        if (item.id === currentId) { currentId = null; document.getElementById('detail-view').style.display = 'none'; document.getElementById('empty-msg').style.display = 'block'; }
        
        // è½¯åˆ é™¤
        const deleted = db.items.splice(idx, 1)[0];
        deleted.deletedAt = new Date().toISOString();
        deleted.type = 'item'; // æ ‡è®°ç±»å‹
        if(!db.trash) db.trash = [];
        db.trash.unshift(deleted);
        
        await saveMainDB(true); renderList();
    }

    // [æ–°å¢] æ¢å¤é€»è¾‘
    async function restoreItemFromCtx() {
        if (contextMenuTargetIdx === null) return;
        const idx = contextMenuTargetIdx;
        document.getElementById('ctx-menu').style.display = 'none';
        
        const item = db.trash[idx];
        
        if (item.type === 'note') {
            // æ¢å¤ç¬”è®°ï¼šå°è¯•æ‰¾å›åŸé—®é¢˜
            let parent = db.items.find(x => x.id === item.parentId);
            if (!parent) {
                // å¦‚æœåŸé—®é¢˜ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªå½’æ¡£é—®é¢˜
                parent = db.items.find(x => x.title === "ğŸ“‚ æ¢å¤çš„å½’æ¡£ç¬”è®°");
                if (!parent) {
                    parent = { id: Date.now(), title: "ğŸ“‚ æ¢å¤çš„å½’æ¡£ç¬”è®°", desc: "è‡ªåŠ¨åˆ›å»ºçš„å½’æ¡£ï¼Œç”¨äºå­˜æ”¾åŸé—®é¢˜å·²ä¸¢å¤±çš„æ¢å¤ç¬”è®°ã€‚", answers: [], date: new Date().toISOString() };
                    db.items.unshift(parent);
                }
                alert(`åŸé—®é¢˜å·²ä¸å­˜åœ¨ï¼Œç¬”è®°å°†æ¢å¤åˆ° "${parent.title}" ä¸­ã€‚`);
            }
            if(!parent.answers) parent.answers = [];
            parent.answers.push(item.data);
            db.trash.splice(idx, 1);
        } else {
            // æ¢å¤é—®é¢˜
            const restored = db.trash.splice(idx, 1)[0];
            delete restored.deletedAt;
            db.items.unshift(restored);
        }
        
        await saveMainDB(true); renderList();
    }

    async function hardDeleteFromCtx() {
        if (contextMenuTargetIdx === null) return;
        const idx = contextMenuTargetIdx;
        document.getElementById('ctx-menu').style.display = 'none';
        if(!confirm("âš ï¸ å½»åº•åˆ é™¤æ— æ³•æ¢å¤ï¼Œç¡®å®šå—ï¼Ÿ")) return;
        
        db.trash.splice(idx, 1);
        
        if (viewMode === 'trash' && currentId) { // å¦‚æœæ­£åœ¨æŸ¥çœ‹è¯¥åƒåœ¾é¡¹
            // å…¶å® loadItem æ—¶ currentId æŒ‡å‘çš„æ˜¯ trash ä¸­çš„ itemï¼Œè¿™é‡Œ id åŒ¹é…å¯èƒ½ä¼šæœ‰é—®é¢˜å¦‚æœ id é‡å¤ã€‚
            // ç®€å•å¤„ç†ï¼šæ¸…ç©ºè§†å›¾
            currentId = null; 
            document.getElementById('detail-view').style.display = 'none';
        }

        await saveMainDB(true); renderList();
    }

    async function restoreCurrentItem() {
        // åœ¨è¯¦æƒ…é¡µç‚¹å‡»æ¢å¤
        const trashIdx = db.trash.findIndex(x => x.id === currentId || (x.data && x.data.date === currentItemData.date)); // ç®€å•åŒ¹é…
        if (trashIdx !== -1) {
            contextMenuTargetIdx = trashIdx;
            await restoreItemFromCtx();
            // æ¢å¤ååˆ‡æ¢å›æ™®é€šè§†å›¾æŸ¥çœ‹
            if(viewMode === 'trash') {
                 // è‡ªåŠ¨åˆ‡å› active æ¨¡å¼å¹¶é€‰ä¸­
                 toggleTrashMode(); 
                 // éœ€è¦æ‰¾åˆ°åœ¨ items ä¸­çš„æ–°ä½ç½®ï¼Œé€šå¸¸æ˜¯ 0
                 loadItem(db.items[0].id);
            }
        }
    }

    async function hardDeleteCurrentItem() {
        const trashIdx = db.trash.findIndex(x => x.id === currentId);
        if (trashIdx !== -1) {
            contextMenuTargetIdx = trashIdx;
            await hardDeleteFromCtx();
        }
    }

    function jumpToSource(cm, event) {
        let target = event.target;
        if (target.tagName.toLowerCase().includes('mjx')) { target = target.closest('p, li, h1, h2, h3, h4, h5, h6, .env-block') || target; }
        let text = target.innerText || target.textContent;
        if (!text) return;
        let searchPhrase = text.slice(0, 30).replace(/\s+/g, ' ').trim();
        if (searchPhrase.length < 3) return; 
        let cursor = cm.getSearchCursor(searchPhrase);
        if (cursor.findNext()) { let pos = cursor.from(); cm.setCursor(pos); cm.scrollIntoView(pos, 200); cm.setSelection(cursor.from(), cursor.to()); cm.focus(); }
    }

    function setupCmEvents(cm, previewId, isGlobal, getPreambleFn) {
        let debounceTimer = null;
        cm.on("inputRead", function(cm, change) { if (change.text[0].match(/[\\a-zA-Z]/)) { CodeMirror.commands.autocomplete(cm, null, { completeSingle: false }); } });
        cm.on("change", () => {
            if (debounceTimer) clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                const val = cm.getValue();
                const el = document.getElementById(previewId);
                const preamble = getPreambleFn ? getPreambleFn() : "";
                const localState = { counters: { thm: 0, lemma: 0, defn: 0, conj: 0, problem: 0 }, labels: {} };
                el.innerHTML = renderContent(val, false, preamble, localState);
                postProcessDom(el);
                if(window.MathJax && val.trim().length > 0) MathJax.typesetPromise([el]);
            }, 300);
        });
    }

    function resetDocState() {
        docState = { counters: { thm: 0, lemma: 0, defn: 0, conj: 0, problem: 0 }, labels: {} };
    }

    function postProcessDom(container) {
        const proofs = container.querySelectorAll('.env-proof');
        proofs.forEach(proof => {
            const prev = proof.previousElementSibling;
            if (prev && prev.classList.contains('env-block')) {
                const wrapper = document.createElement('div');
                wrapper.className = 'thm-proof-wrapper';
                prev.parentNode.insertBefore(wrapper, prev);
                wrapper.appendChild(prev); wrapper.appendChild(proof);
                prev.classList.add('sticky-mode'); proof.classList.add('attached');
            }
        });
    }

    function renderContent(text, isGlobal, preamble = "", customState = null) {
        if (!text) return "";
        const state = customState || docState; 

        const mathBlocks = [];
        const storeMath = (content) => { mathBlocks.push(content); return `MATHBLOCK${mathBlocks.length - 1}ENDMATHBLOCK`; };

        let processedText = text;
        if (preamble && preamble.trim()) { processedText = `$$ ${preamble} $$ \n` + processedText; }

        processedText = processedText.replace(/\$\$([\s\S]*?)\$\$/g, (match) => { return storeMath(match); });
        processedText = processedText.replace(/\$((?:\\.|[^$\\])*)\$/g, (match) => { return storeMath(match); });
        processedText = processedText.replace(/\\\(((?:\\.|[^\\])*)\\\)/g, (match) => { return storeMath(match); });
        processedText = processedText.replace(/\\\[([\s\S]*?)\\\]/g, (match) => { return storeMath(match); });

        const envsToProtect = ['align', 'align\\*', 'equation', 'equation\\*', 'gather', 'gather\\*', 'alignat', 'alignat\\*', 'xalignat', 'xalignat\\*', 'flalign', 'flalign\\*'];
        const envRegex = new RegExp(`\\\\begin\\{(${envsToProtect.join('|')})\\}([\\s\\S]*?)\\\\end\\{\\1\\}`, 'g');
        processedText = processedText.replace(envRegex, (match) => { return storeMath(match); });

        processedText = processedText.replace(/~/g, ' ');
        processedText = processedText.replace(/\\textbf\{([^{}]+)\}/g, '<strong>$1</strong>').replace(/\\textit\{([^{}]+)\}/g, '<em>$1</em>').replace(/\\emph\{([^{}]+)\}/g, '<em>$1</em>').replace(/\\underline\{([^{}]+)\}/g, '<u>$1</u>').replace(/\\texttt\{([^{}]+)\}/g, '<code>$1</code>');

        let html = marked.parse(processedText);

        html = html.replace(/<p>MATHBLOCK(\d+)ENDMATHBLOCK<\/p>/g, (m, id) => mathBlocks[id]);
        html = html.replace(/MATHBLOCK(\d+)ENDMATHBLOCK/g, (m, id) => mathBlocks[id]);
        
        if (preamble && preamble.trim() && mathBlocks.length > 0) { html = html.replace(/^<p>(\$\$[\s\S]*?\$\$)< \/p>/, '$1'); }

        const envs = [ 
            { tags: ['thm','theorem'], name: 'Theorem', key: 'thm', class: 'env-thm' }, 
            { tags: ['conjecture','conj'], name: 'Conjecture', key: 'conj', class: 'env-conj' }, 
            { tags: ['lemma','lem'], name: 'Lemma', key: 'lemma', class: 'env-lemma' }, 
            { tags: ['defn','definition'], name: 'Definition', key: 'defn', class: 'env-defn' },
            { tags: ['problem'], name: 'Problem', key: 'problem', class: 'env-problem' },
            { tags: ['proof'], name: 'Proof', key: null, class: 'env-proof', isProof: true } 
        ];

        envs.forEach(env => {
            env.tags.forEach(tag => {
                const regex = new RegExp(`\\\\begin\\{${tag}\\}([\\s\\S]*?)\\\\end\\{${tag}\\}`, 'gi');
                html = html.replace(regex, (m, c) => {
                    let numStr = ""; let anchorId = "";
                    if (env.key) {
                        state.counters[env.key] = (state.counters[env.key] || 0) + 1; // ä½¿ç”¨ state
                        const num = state.counters[env.key];
                        numStr = ` ${num}`; anchorId = `env-${env.key}-${num}`;
                        const labelRegex = /\\label\{([^}]+)\}/g; let match;
                        while ((match = labelRegex.exec(c)) !== null) {
                            const labelName = match[1]; state.labels[labelName] = { num: num, id: anchorId }; // ä½¿ç”¨ state
                        }
                        c = c.replace(labelRegex, ''); 
                    }
                    c = c.replace(/^\s*<p>|<\/p>\s*$/g, '');
                    if (env.isProof) {
                        return `<div class="${env.class}"><span class="env-title">${env.name}.</span> <span class="env-content">${c}</span> <span style="float:right">â—¼</span></div>`;
                    } else {
                        return `<div id="${anchorId}" class="env-block ${env.class}"><span class="env-title">${env.name}${numStr}.</span> <span class="env-content">${c}</span></div>`;
                    }
                });
            });
        });
        
        html = html.replace(/\\ref\{([^}]+)\}/g, (m, labelName) => { return `<a class="latex-ref" data-ref="${labelName}">[?]</a>`; });
        
        return html;
    }

    function resolveReferences(customState = null) {
        const state = customState || docState;
        document.querySelectorAll('#detail-view .latex-ref').forEach(el => {
            const refKey = el.getAttribute('data-ref');
            const target = state.labels[refKey];
            if (target) { el.innerHTML = target.num; el.href = "#" + target.id; } 
            else { el.innerHTML = "<strong>?</strong>"; el.title = "æœªæ‰¾åˆ°å¼•ç”¨"; el.style.color = "red"; }
        });
    }

    function toggleFullscreen(wrapperId) {
        const el = document.getElementById(wrapperId); el.classList.toggle('fullscreen');
        const cm = wrapperId.includes('prob') ? probCm : noteCm; cm.refresh(); 
    }

    function togglePreamble() {
        const el = document.getElementById('preamble-section');
        el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }

    function openProblemEditor() {
        document.getElementById('problem-display-area').style.display = 'none';
        document.getElementById('problem-editor-wrapper').style.display = 'flex';
        document.getElementById('prob-title-inp').value = currentItemData.title;
        document.getElementById('prob-preamble-inp').value = currentItemData.preamble || "";
        document.getElementById('preamble-section').style.display = currentItemData.preamble ? 'block' : 'none';
        probCm.setValue(currentItemData.desc);
        setTimeout(() => { probCm.refresh(); probCm.focus(); }, 50);
    }
    function closeProblemEditor() {
        const el = document.getElementById('problem-editor-wrapper');
        el.style.display = 'none'; el.classList.remove('fullscreen'); 
        document.getElementById('problem-display-area').style.display = 'block';
    }
    function openNoteEditor() {
        document.getElementById('note-trigger-btn').style.display = 'none';
        document.getElementById('note-editor-wrapper').style.display = 'flex';
        noteCm.setValue('');
        setTimeout(() => { noteCm.refresh(); noteCm.focus(); }, 100);
        document.getElementById('note-section-footer').scrollIntoView({ behavior: 'smooth' });
    }
    function closeNoteEditor() {
        const el = document.getElementById('note-editor-wrapper');
        el.style.display = 'none'; el.classList.remove('fullscreen');
        document.getElementById('note-trigger-btn').style.display = 'block';
        editingNoteIndex = null;
        document.getElementById('note-editor-title').innerText = "ğŸ“ æ–°ç¬”è®°";
        noteCm.setValue('');
    }

    function editAns(idx) {
        editingNoteIndex = idx;
        const note = currentItemData.answers[idx];
        document.getElementById('note-trigger-btn').style.display = 'none';
        document.getElementById('note-editor-wrapper').style.display = 'flex';
        noteCm.setValue(note.text);
        document.getElementById('note-editor-title').innerText = "âœï¸ ç¼–è¾‘ç¬”è®°";
        setTimeout(() => { noteCm.refresh(); noteCm.focus(); }, 100);
        document.getElementById('note-section-footer').scrollIntoView({ behavior: 'smooth' });
    }
    
    function toggleNote(idx) {
        const content = document.getElementById(`ans-content-${idx}`);
        const btn = document.getElementById(`ans-btn-toggle-${idx}`);
        if (content.classList.contains('collapsed')) { content.classList.remove('collapsed'); btn.innerText = "ğŸ”¼ æ”¶èµ·"; } 
        else { content.classList.add('collapsed'); btn.innerText = "ğŸ”½ å±•å¼€"; }
    }
    
    function fullscreenNote(idx) {
        const note = currentItemData.answers[idx];
        const container = document.getElementById('fullscreen-content');
        const localState = { counters: { thm: 0, lemma: 0, defn: 0, conj: 0, problem: 0 }, labels: {} };
        container.innerHTML = renderContent(note.text, true, currentItemData.preamble, localState);
        container.querySelectorAll('.latex-ref').forEach(el => {
            const refKey = el.getAttribute('data-ref');
            const target = localState.labels[refKey];
            if (target) { el.innerHTML = target.num; el.href = "#"; } 
            else { el.innerHTML = "<strong>?</strong>"; el.style.color = "red"; }
        });
        postProcessDom(container);
        if(window.MathJax) MathJax.typesetPromise([container]);
        document.getElementById('fullscreen-reader').style.display = 'flex';
    }

    async function saveProblem() {
        currentItemData.title = document.getElementById('prob-title-inp').value;
        currentItemData.desc = probCm.getValue();
        currentItemData.preamble = document.getElementById('prob-preamble-inp').value;
        currentItemData.date = new Date().toISOString();
        closeProblemEditor();
        await performSave();
        renderDetailView();
    }
    
    async function saveNote() {
        const val = noteCm.getValue();
        if(!val.trim()) return;
        if (editingNoteIndex !== null) { currentItemData.answers[editingNoteIndex].text = val; } 
        else { if(!currentItemData.answers) currentItemData.answers = []; currentItemData.answers.push({ text: val, date: new Date().toISOString() }); }
        currentItemData.date = new Date().toISOString(); 
        closeNoteEditor();
        await performSave();
        renderDetailView();
    }

    async function syncPull() {
        if (visitorGistId) {
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('loading-tip').innerText = "åˆ·æ–°åä½œå†…å®¹...";
            try { await loadSharedItem(visitorGistId); setMsg("å°±ç»ª"); } 
            catch(e) { handleNetworkError(e); } 
            finally { document.getElementById('loading').style.display = 'none'; }
        } else { await syncPullMain(); }
    }
    
    async function enterVisitorMode() {
        document.body.classList.add('visitor-mode');
        document.getElementById('auth-controls').innerHTML = ''; 
        document.getElementById('app-title').innerText = "åä½œç¼–è¾‘å™¨ (è®¿å®¢)";
        document.getElementById('loading').style.display = 'flex';
        document.getElementById('loading-tip').innerText = "è¿æ¥ä¸­...";

        if (!ghConfig.token) { 
            const t = prompt("è¯·è¾“å…¥ GitHub Token ä»¥å¯ç”¨ç¼–è¾‘æƒé™ï¼š"); 
            if(t) {
                ghConfig.token = t.trim();
                localStorage.setItem(CFG_KEY, JSON.stringify(ghConfig));
            }
        }
        
        try {
            await loadSharedItem(visitorGistId);
            setMsg("åä½œæ¨¡å¼");
        } catch(e) {
            alert("è¿æ¥å¤±è´¥: " + e.message);
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }
    async function syncPullMain() {
        if(!ghConfig.token || !ghConfig.mainGistId) return;
        setMsg("æ­£åœ¨åŒæ­¥åˆ—è¡¨...");
        document.getElementById('loading').style.display = 'flex';
        try {
            const res = await fetch(`https://api.github.com/gists/${ghConfig.mainGistId}`, { headers: { "Authorization": `token ${ghConfig.token}` } });
            await handleApiError(res); 
            const json = await res.json();
            let fileObj = json.files["main_db.json"] || json.files["research_data.json"];
            if (!fileObj) { const anyJson = Object.keys(json.files).find(k => k.endsWith('.json')); if(anyJson) fileObj = json.files[anyJson]; }
            if (!fileObj) throw new Error("Gist ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ•°æ®æ–‡ä»¶");
            db = JSON.parse(fileObj.content);
            if(!db.items) { db = Array.isArray(db) ? { items: db } : { items: [] }; }
            // å…¼å®¹æ€§åˆå§‹åŒ–
            if(!db.trash) db.trash = [];
            renderList();
            setMsg("å°±ç»ª");
        } catch(e) { handleNetworkError(e); } 
        finally { document.getElementById('loading').style.display = 'none'; }
    }
    
    async function loadItem(id) {
        // [ä¿®å¤] æ”¯æŒåŠ è½½ trash ä¸­çš„ item
        let itemRef;
        if (viewMode === 'active') {
            itemRef = db.items.find(x => x.id === id);
        } else {
            itemRef = db.trash.find(x => x.id === id);
        }
        
        if(!itemRef) return;
        currentId = id;
        document.getElementById('empty-msg').style.display = 'none';
        document.getElementById('detail-view').style.display = 'flex';
        document.getElementById('collab-banner').style.display = 'none';
        
        // åƒåœ¾æ¡¶æ¨¡å¼ä¸‹éšè—å¸¸è§„å·¥å…·æ ï¼Œæ˜¾ç¤ºåƒåœ¾æ¡¶å·¥å…·æ 
        if (viewMode === 'trash') {
            document.getElementById('normal-toolbar-btns').style.display = 'none';
            document.getElementById('trash-toolbar-btns').style.display = 'flex';
            // åƒåœ¾æ¡¶æ¨¡å¼ä¸‹çš„å†…å®¹æ˜¯åªè¯»çš„ï¼Œæ‰€ä»¥ä¸éœ€è¦ complex editing logic, but we still use currentItemData for rendering
            currentItemData = itemRef;
            renderDetailView();
            // ç¦ç”¨ç¼–è¾‘æŒ‰é’®
            document.querySelectorAll('.bar-btn.secondary').forEach(b => b.style.display = 'none');
            // éšè—æ·»åŠ ç¬”è®°
            document.getElementById('note-section-footer').style.display = 'none';
        } else {
            document.getElementById('normal-toolbar-btns').style.display = 'flex';
            document.getElementById('trash-toolbar-btns').style.display = 'none';
            document.getElementById('note-section-footer').style.display = 'block';
            
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('loading-tip').innerText = "åŠ è½½å†…å®¹ä¸­...";
            closeNoteEditor(); closeProblemEditor();
            try {
                if (itemRef.shareId) { document.getElementById('collab-banner').style.display = 'block'; await loadSharedItem(itemRef.shareId); } 
                else { currentItemData = itemRef; renderDetailView(); }
            } catch (e) { handleNetworkError(e); } 
            finally { document.getElementById('loading').style.display = 'none'; setMsg("å°±ç»ª"); }
        }
    }
    
    async function loadSharedItem(gistId) {
        const headers = {};
        if (ghConfig.token) headers["Authorization"] = `token ${ghConfig.token}`;
        
        const res = await fetch(`https://api.github.com/gists/${gistId}`, { headers: headers });
        await handleApiError(res);
        const json = await res.json();
        let fileObj = json.files["shared_item.json"];
        if (!fileObj) { const key = Object.keys(json.files).find(k => k.endsWith('.json')); if(key) fileObj = json.files[key]; }
        if (!fileObj) throw new Error("Gist æ•°æ®æŸå");
        currentItemData = JSON.parse(fileObj.content);
        if(!currentId) currentId = currentItemData.id;
        document.getElementById('empty-msg').style.display = 'none';
        document.getElementById('detail-view').style.display = 'flex';
        renderDetailView();
    }

    function renderDetailView() {
        resetDocState();
        const d = currentItemData;
        document.getElementById('d-title').innerText = d.title;
        document.getElementById('d-date').innerText = new Date(d.date).toLocaleDateString();
        
        const descContainer = document.getElementById('d-desc');
        descContainer.innerHTML = renderContent(d.desc || "", true, d.preamble);
        postProcessDom(descContainer);
        
        document.getElementById('problem-display-area').style.display = 'block';
        document.getElementById('problem-editor-wrapper').style.display = 'none';
        
        const ansList = document.getElementById('ans-list');
        ansList.innerHTML = (d.answers || []).map((a, i) => `
            <div class="ans-card">
                <div id="ans-content-${i}" class="markdown-body ans-content collapsed">${renderContent(a.text, true, d.preamble)}</div>
                <div class="ans-footer">
                    <div>
                        <button class="btn-text" id="ans-btn-toggle-${i}" onclick="toggleNote(${i})">ğŸ”½ å±•å¼€</button>
                        <button class="btn-text" onclick="fullscreenNote(${i})">â›¶ å…¨å±é˜…è¯»</button>
                    </div>
                    
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span>${new Date(a.date).toLocaleString()}</span>
                        ${viewMode === 'active' ? `
                        <button class="bar-btn secondary" style="font-size:11px; padding:3px 8px;" onclick="editAns(${i})">âœï¸ ç¼–è¾‘</button>
                        <button class="bar-btn warn" style="font-size:11px; padding:3px 8px;" onclick="deleteAns(${i})">ğŸ—‘ï¸</button>
                        ` : ''}
                    </div>
                </div>
            </div>
        `).join('');
        
        ansList.querySelectorAll('.ans-content').forEach(el => postProcessDom(el));
        
        resolveReferences();
        if(!visitorGistId) renderList(); 
        if(window.MathJax) MathJax.typesetPromise();
    }

    // [ä¿®æ”¹] åˆ é™¤é—®é¢˜ -> ç§»å…¥ Trash
    async function deleteItem() {
        if(!currentId) return;
        if(!confirm("âš ï¸ ç¡®å®šè¦ç§»å…¥å›æ”¶ç«™å—ï¼Ÿ")) return;
        
        const idx = db.items.findIndex(x => x.id === currentId);
        if(idx === -1) return;
        
        const deleted = db.items.splice(idx, 1)[0];
        deleted.deletedAt = new Date().toISOString();
        deleted.type = 'item';
        
        if(!db.trash) db.trash = [];
        db.trash.unshift(deleted);
        
        currentId = null;
        document.getElementById('detail-view').style.display = 'none';
        document.getElementById('empty-msg').style.display = 'block';
        
        await saveMainDB(true); 
        renderList();
    }
    
    // [ä¿®æ”¹] åˆ é™¤ç¬”è®° -> ç§»å…¥ Trash
    async function deleteAns(idx) {
        if(!confirm("åˆ é™¤ç¬”è®°å¹¶ç§»å…¥å›æ”¶ç«™?")) return;
        
        const note = currentItemData.answers.splice(idx, 1)[0];
        const trashNote = {
            type: 'note',
            data: note,
            parentId: currentItemData.id,
            parentTitle: currentItemData.title,
            deletedAt: new Date().toISOString()
        };
        
        if(!db.trash) db.trash = [];
        db.trash.unshift(trashNote);
        
        await performSave();
        renderDetailView();
    }

    async function performSave() {
        setMsg("æ­£åœ¨ä¿å­˜...");
        try {
            let targetShareId = visitorGistId;
            if (!targetShareId && currentId) { const ref = db.items.find(x => x.id === currentId); if(ref && ref.shareId) targetShareId = ref.shareId; }
            if (targetShareId) {
                await updateGistFile(targetShareId, "shared_item.json", currentItemData);
                if (!visitorGistId) { const ref = db.items.find(x => x.id === currentId); ref.title = currentItemData.title; ref.date = currentItemData.date; saveMainDB(true); }
            } else { await saveMainDB(true); }
            setMsg("âœ… å·²ä¿å­˜");
        } catch(e) { handleNetworkError(e); }
    }
    async function updateGistFile(gistId, filename, dataObj) {
        const res = await fetch(`https://api.github.com/gists/${gistId}`, { method: "PATCH", headers: { "Authorization": `token ${ghConfig.token}`, "Content-Type": "application/json" }, body: JSON.stringify({ files: { [filename]: { content: JSON.stringify(dataObj, null, 2) } } }) });
        await handleApiError(res);
    }
    async function saveMainDB(silent = false) { if(!silent) setMsg("åŒæ­¥ä¸»åº“..."); await updateGistFile(ghConfig.mainGistId, "main_db.json", db); }
    async function handleApiError(res) { if (res.ok) return; throw new Error(`Error ${res.status}: ${res.statusText}`); }
    function handleNetworkError(e) { alert("âš ï¸ " + e.message); setMsg("âŒ å¤±è´¥"); openConfig(); }
    
    // [ä¿®æ”¹] æ¸²æŸ“åˆ—è¡¨é€»è¾‘ (æ”¯æŒå›æ”¶ç«™è§†å›¾)
    function renderList() { 
        const term = document.getElementById('search-input') ? document.getElementById('search-input').value.toLowerCase() : "";
        const isSearching = term.length > 0;
        
        let sourceList = (viewMode === 'trash') ? db.trash : db.items;
        
        let displayItems = sourceList;
        if(isSearching) {
            displayItems = sourceList.filter(item => {
                if (item.type === 'note') {
                    return (item.data.text && item.data.text.toLowerCase().includes(term));
                }
                return (item.title && item.title.toLowerCase().includes(term)) || (item.desc && item.desc.toLowerCase().includes(term));
            });
        }
        
        document.getElementById('list').innerHTML = displayItems.map((item) => {
            // Note: In trash mode, we use the trash array index
            const idx = sourceList.indexOf(item); 
            const activeClass = (item.id === currentId) ? 'active' : ''; // Only valid for problem items
            
            // Trash Item Rendering
            if (viewMode === 'trash') {
                if (item.type === 'note') {
                    return `<li class="item trash-mode" onclick="alert('è¿™æ˜¯å•æ¡ç¬”è®°ï¼Œè¯·æ¢å¤åæŸ¥çœ‹')">
                        <span class="item-title" style="font-size:12px">ğŸ“„ ç¬”è®° (åŸé—®é¢˜: ${item.parentTitle}) <br> <span style="color:#999">${item.data.text.substring(0,30)}...</span></span>
                        <div style="font-size:10px; color:#d73a49; margin-top:5px; cursor:pointer;" onclick="contextMenuTargetIdx=${idx}; restoreItemFromCtx(); event.stopPropagation()">â™»ï¸ æ¢å¤</div>
                         <div style="font-size:10px; color:#555; margin-top:5px; cursor:pointer; margin-left:10px;" onclick="contextMenuTargetIdx=${idx}; hardDeleteFromCtx(); event.stopPropagation()">âŒ é”€æ¯</div>
                    </li>`;
                } else {
                    return `<li class="item trash-mode ${activeClass}" onclick="loadItem(${item.id})" oncontextmenu="openContextMenu(event, ${idx})">
                        <span class="item-title">${item.title} <span class="trash-badge">å·²åˆ é™¤</span></span>
                    </li>`;
                }
            }

            // Normal Item Rendering
            const sharedClass = item.shareId ? 'shared' : '';
            const pinnedIndicator = item.isPinned ? `<span class="pin-indicator">ğŸ“Œ</span>` : '';
            const draggableAttr = isSearching ? '' : `draggable="true" ondragstart="dragStart(event, ${idx})" ondrop="dragDrop(event, ${idx})" ondragover="event.preventDefault()"`;
            
            return `<li class="item ${activeClass} ${sharedClass}" ${draggableAttr} onclick="loadItem(${item.id})" oncontextmenu="openContextMenu(event, ${idx})">
                ${pinnedIndicator}
                <span class="item-title">${item.title}</span>
                <span class="share-icon" title="åä½œä¸­">ğŸ”—</span>
            </li>`;
        }).join(''); 
    }

    function createNewLocal() { const newItem = { id: Date.now(), title: "æ–°é—®é¢˜", desc: "", answers: [], date: new Date().toISOString(), isPinned: false }; db.items.unshift(newItem); saveMainDB(); loadItem(newItem.id); }
    function dragStart(e, idx) { e.dataTransfer.setData('idx', idx); }
    function dragDrop(e, targetIdx) { e.preventDefault(); const srcIdx = e.dataTransfer.getData('idx'); const [moved] = db.items.splice(srcIdx, 1); db.items.splice(targetIdx, 0, moved); renderList(); saveMainDB(true); }
    
    async function manageCollaboration() { const item = db.items.find(x => x.id === currentId); if(item.shareId) { const a = prompt("1.è·å–é“¾æ¥ 2.åœæ­¢åä½œ", "1"); if(a==="1") prompt("é“¾æ¥:", `${location.origin}${location.pathname}?gist=${item.shareId}`); else if(a==="2") stopCollaboration(item); } else convertToShared(); }
    async function stopCollaboration(item) { if(!confirm("åœæ­¢åä½œå¹¶å­˜å›æœ¬åœ°?")) return; try { item.desc=currentItemData.desc; item.answers=currentItemData.answers; delete item.shareId; await saveMainDB(true); alert("å·²åœæ­¢"); loadItem(item.id); } catch(e){alert(e.message);} }
    async function convertToShared() { const item = db.items.find(x => x.id === currentId); if(!confirm("å¼€å¯åä½œ?")) return; try { const res = await fetch("https://api.github.com/gists", { method: "POST", headers: { "Authorization": `token ${ghConfig.token}` }, body: JSON.stringify({ description: `[Shared] ${item.title}`, public: false, files: { "shared_item.json": { content: JSON.stringify(item, null, 2) } } }) }); const json = await res.json(); item.shareId = json.id; await saveMainDB(true); alert("å·²å¼€å¯"); loadItem(currentId); } catch(e){alert(e.message);} }

    function openConfig() { 
        document.getElementById('cfg-token').value = ghConfig.token; 
        document.getElementById('cfg-id').value = ghConfig.mainGistId; 
        document.getElementById('config-modal').style.display = 'flex'; 
    }
    function setMsg(t) { document.getElementById('sync-status').innerText = t; }
    
    async function saveConfig() {
        const t = document.getElementById('cfg-token').value.trim();
        let mid = document.getElementById('cfg-id').value.trim();
        
        if(!t) return alert("Token ä¸èƒ½ä¸ºç©º");
        if (mid.includes('/')) mid = mid.split('/').pop().replace('.git', '');
        
        ghConfig = { token: t, mainGistId: mid };
        
        if (!mid) {
            setMsg("åˆå§‹åŒ–..."); try {
                const res = await fetch("https://api.github.com/gists", { method: "POST", headers: { "Authorization": `token ${t}` }, body: JSON.stringify({ description: "Research Manager Main DB", public: false, files: { "main_db.json": { content: JSON.stringify({items:[]}) } } }) });
                ghConfig.mainGistId = (await res.json()).id; alert("å·²åˆ›å»ºæ–°åº“: " + ghConfig.mainGistId);
            } catch(e) { alert(e.message); return; }
        }
        localStorage.setItem(CFG_KEY, JSON.stringify(ghConfig));
        document.getElementById('config-modal').style.display = 'none';
        
        syncPullMain(); 
    }
</script>
</body>
</html>
