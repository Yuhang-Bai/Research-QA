<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§‘ç ”ç®¡ç†å™¨ (äº‘ç«¯ç‰ˆ)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']]},startup:{typeset:false}};</script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/markdown/markdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/stex/stex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
    
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; height: 100vh; background: #f4f5f7; overflow: hidden; color: #333; }
        
        /* é¡¶éƒ¨äº‘çŠ¶æ€æ  */
        #cloud-status-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 32px; background: #24292e; color: #fff;
            font-size: 12px; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-sizing: border-box; z-index: 100;
        }
        #cloud-msg { font-weight: bold; }
        .cloud-btn { background: #0366d6; border: none; color: white; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 11px; margin-left: 5px;}
        .cloud-btn:hover { background: #0255b3; }
        .cloud-btn.warn { background: #d73a49; }

        /* å¸ƒå±€è°ƒæ•´ */
        #container-wrapper { display: flex; width: 100%; height: 100%; padding-top: 32px; box-sizing: border-box; }
        
        #sidebar { width: 260px; min-width: 150px; max-width: 600px; background: white; display: flex; flex-direction: column; z-index: 2; flex-shrink: 0; }
        
        /* æ‹–åŠ¨æ¡ */
        #resizer { width: 5px; background: #ddd; cursor: col-resize; z-index: 3; flex-shrink: 0; transition: background 0.2s; }
        #resizer:hover, #resizer.resizing { background: #0052cc; }

        #main { flex: 1; display: flex; flex-direction: column; overflow-y: auto; background: white; position: relative; min-width: 300px; }

        /* é€šç”¨ç»„ä»¶ */
        .header { padding: 15px; border-bottom: 1px solid #ddd; background: #fafbfc; display: flex; justify-content: space-between; align-items: center; }
        .add-btn { background: #0052cc; color: white; border: none; width: 30px; height: 30px; cursor: pointer; border-radius: 4px; font-size: 20px; display:flex; align-items:center; justify-content:center; }
        
        #list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        
        /* åˆ—è¡¨é¡¹æ‹–æ‹½æ ·å¼ */
        .item { padding: 12px 15px; border-bottom: 1px solid #eee; cursor: pointer; border-left: 4px solid transparent; position: relative; display: flex; align-items: flex-start; gap: 8px; user-select: none; }
        .item:hover { background: #eee; }
        .item.active { background: #e6effc; border-left: 4px solid #0052cc; }
        .item.dragging { opacity: 0.5; background: #f0f0f0; border: 2px dashed #ccc; }
        
        .item-content { flex: 1; overflow: hidden; }
        .item-title { font-weight: bold; margin-bottom: 4px; color: #172b4d; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 14px;}
        .item-date { font-size: 11px; color: #888; }
        
        /* ç½®é¡¶æŒ‰é’® */
        .pin-btn { font-size: 14px; color: #ccc; cursor: pointer; padding-top: 2px; }
        .pin-btn.pinned { color: #de350b; transform: rotate(-45deg); }
        .pin-btn:hover { color: #555; }

        #detail-view { display: none; width: 100%; height: 100%; flex-direction: column; }
        .content-wrap { padding: 30px 40px; max-width: 1000px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        .meta-bar { display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; }
        .btn { padding: 6px 12px; cursor: pointer; border: none; border-radius: 3px; font-size: 13px; margin-left: 8px;}
        .btn-primary { background: #0052cc; color: white; }
        .btn-share { background: #00875a; color: white; }
        .btn-del { background: #ffebe6; color: #de350b; }
        .btn-edit { background: #ebecf0; color: #091e42; }

        .markdown-body { line-height: 1.6; font-size: 16px; }
        .markdown-body h1, .markdown-body h2 { border-bottom: 1px solid #eaecef; padding-bottom: .3em; margin-top: 24px; }
        .markdown-body code { background-color: #f6f8fa; border-radius: 3px; padding: 2px 4px; font-family: monospace; }
        .markdown-body pre { background-color: #f6f8fa; padding: 16px; border-radius: 6px; overflow: auto; }
        .markdown-body blockquote { border-left: 4px solid #dfe2e5; color: #6a737d; padding-left: 1em; margin: 0; }

        .divider-section { background-color: #f4f5f7; border-top: 1px solid #dfe1e6; border-bottom: 1px solid #dfe1e6; padding: 8px 40px; color: #5e6c84; font-weight: bold; font-size: 12px; letter-spacing: 1px; text-transform: uppercase; display: flex; justify-content: space-between; align-items: center; }
        .answers-section { background: #fff; padding-bottom: 80px; }
        .ans-item { border: 1px solid #eee; padding: 20px; border-radius: 8px; margin-bottom: 15px; background: #fafbfc; }
        .ans-meta { font-size: 12px; color: #aaa; margin-top: 10px; display: flex; justify-content: space-between; border-top: 1px solid #eee; padding-top: 10px; }

        /* ç¼–è¾‘å™¨ */
        #editor-container { display: none; flex: 1; flex-direction: column; height: 100%; overflow: hidden; background: #fff; }
        .editor-toolbar { padding: 10px 20px; border-bottom: 1px solid #ddd; background: #f4f5f7; display: flex; justify-content: space-between; align-items: center; }
        .editor-split-view { display: flex; flex: 1; overflow: hidden; }
        .editor-pane, .preview-pane { width: 50%; height: 100%; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .preview-pane { overflow-y: auto; padding: 20px 40px; background: #fff; box-sizing: border-box; border-right: none; }
        .title-input { width: 100%; padding: 10px 20px; font-size: 18px; font-weight: bold; border: none; border-bottom: 1px solid #ddd; outline: none; }
        .CodeMirror { height: 100%; font-family: Consolas, Monaco, monospace; font-size: 15px; line-height: 1.5; }

        /* å­¦æœ¯ç¯å¢ƒ */
        .env-block { margin: 15px 0; padding: 15px; border-radius: 4px; text-align: left; }
        .env-title { font-weight: bold; margin-right: 8px; }
        .env-content { font-style: italic; }
        .env-thm { background: #e6effc; border-left: 4px solid #0052cc; color: #172b4d; }
        .env-thm .env-title { color: #0052cc; }
        .env-conj { background: #fff7e6; border-left: 4px solid #ff9900; color: #172b4d; }
        .env-conj .env-title { color: #d97706; }
        .env-lemma { background: #f4f5f7; border-left: 4px solid #5e6c84; color: #172b4d; }
        .env-lemma .env-title { color: #42526e; }
        .env-defn { background: #e3fcef; border-left: 4px solid #00875a; color: #172b4d; }
        .env-defn .env-title { color: #006644; }
        .env-proof { margin: 15px 0; padding-left: 15px; color: #333; }
        .env-proof .env-title { font-style: italic; font-weight: bold; color: #333; }
        .env-proof .env-content { font-style: normal; }
        .qed-symbol { float: right; color: #333; }

        /* å¼¹çª— */
        #modal, #config-modal { display: none; position: fixed; inset: 0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index: 999; }
        .modal-content { background:white; padding:20px; width:500px; border-radius:8px; display:flex; flex-direction:column; gap:10px; }
        .modal-inp { padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>

<div id="cloud-status-bar">
    <div id="cloud-msg">ğŸ“¡ æœªé…ç½®äº‘ç«¯åŒæ­¥</div>
    <div>
        <button class="cloud-btn" onclick="syncPull()">â¬‡ï¸ æ‹‰å–</button>
        <button class="cloud-btn" onclick="syncPush()">â¬†ï¸ æ¨é€</button>
        <button class="cloud-btn warn" onclick="openConfig()">âš™ï¸ é…ç½®å¯†é’¥</button>
    </div>
</div>

<div id="container-wrapper">
    <div id="sidebar">
        <div class="header">
            <h3 style="margin:0">é—®é¢˜åº“</h3>
            <button class="add-btn" onclick="openModal()">+</button>
        </div>
        <ul id="list"></ul>
    </div>

    <div id="resizer"></div>

    <div id="main">
        <div id="empty-msg" style="text-align:center; color:#888; margin-top:100px;">
            <h2>è¯·é…ç½®äº‘ç«¯å¹¶æ‹‰å–æ•°æ®ï¼Œæˆ–æ·»åŠ æ–°é—®é¢˜</h2>
        </div>

        <div id="detail-view">
            <div class="content-wrap" style="flex:1;">
                <div class="meta-bar">
                    <span id="d-date" style="color:#888; font-size:12px;"></span>
                    <div>
                        <button class="btn btn-edit" onclick="enterEditMode('question')">âœï¸ ä¿®æ”¹é—®é¢˜</button>
                        <button class="btn btn-share" onclick="doExport()">ğŸ“¤ å¯¼å‡º</button>
                        <button class="btn btn-del" onclick="doDelete()">åˆ é™¤</button>
                    </div>
                </div>
                <h1 id="d-title" style="color:#0052cc; margin-top:0;"></h1>
                <div id="d-desc" class="markdown-body"></div>
            </div>

            <div class="divider-section">
                <span>â–¼ ç¬”è®°ä¸è®¨è®º</span>
                <button class="btn btn-primary" style="font-size:11px; padding:2px 8px;" onclick="enterEditMode('note')">â• æ·»åŠ å…¨å±ç¬”è®°</button>
            </div>

            <div class="content-wrap answers-section">
                <div id="ans-list"></div>
                </div>
        </div>

        <div id="editor-container">
            <div class="editor-toolbar">
                <span style="font-weight:bold;" id="editor-mode-text">âœï¸ ç¼–è¾‘æ¨¡å¼</span>
                <div>
                    <button class="btn" style="background:#eee;" onclick="exitEditMode()">å–æ¶ˆ</button>
                    <button class="btn btn-primary" onclick="saveEdit()">ä¿å­˜</button>
                </div>
            </div>
            <input type="text" id="editor-title" class="title-input" placeholder="é—®é¢˜æ ‡é¢˜">
            <div class="editor-split-view">
                <div class="editor-pane"><textarea id="code-editor"></textarea></div>
                <div class="preview-pane"><div id="editor-preview" class="markdown-body"></div></div>
            </div>
        </div>
    </div>
</div>

<div id="modal">
    <div class="modal-content">
        <h3>æ–°å»ºé—®é¢˜</h3>
        <input class="modal-inp" id="m-title" placeholder="æ ‡é¢˜">
        <textarea class="modal-inp" id="m-desc" style="height:150px" placeholder="ç®€è¦æè¿°"></textarea>
        <div style="text-align:right;">
            <button class="btn" style="background:#eee;" onclick="document.getElementById('modal').style.display='none'">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="saveNew()">åˆ›å»º</button>
        </div>
    </div>
</div>

<div id="config-modal">
    <div class="modal-content">
        <h3>âš™ï¸ äº‘ç«¯é…ç½® (GitHub Gist)</h3>
        <p style="font-size:12px; color:#666;">é…ç½®åï¼Œæ•°æ®å°†åŒæ­¥åˆ°æ‚¨çš„ç§äºº Gistã€‚æ•°æ®ä¸å†æœ¬åœ°ä¿å­˜ã€‚</p>
        <label>GitHub Token (éœ€å‹¾é€‰ gist æƒé™):</label>
        <input class="modal-inp" id="cfg-token" type="password" placeholder="ghp_xxxxxxxxxxxx">
        <label>Gist ID:</label>
        <input class="modal-inp" id="cfg-id" placeholder="Gist ID å­—ç¬¦ä¸²">
        <div style="text-align:right;">
            <button class="btn" style="background:#eee;" onclick="document.getElementById('config-modal').style.display='none'">å…³é—­</button>
            <button class="btn btn-primary" onclick="saveConfig()">ä¿å­˜å¹¶æ‹‰å–</button>
        </div>
    </div>
</div>

<script>
    // --- å…¨å±€å˜é‡ ---
    const LATEX_KEYWORDS = [ { text: "\\begin{thm}\n\n\\end{thm}", displayText: "thm" }, { text: "\\begin{conj}\n\n\\end{conj}", displayText: "conj" }, "\\alpha", "\\beta", "\\sum", "\\prod" ];
    let mainEditor, debounceTimer;
    // æ•°æ®åªå­˜äºå†…å­˜ï¼Œä¸å­˜ LocalStorage
    var data = []; 
    var currentId = null;
    var editMode = 'question'; // 'question' æˆ– 'note'

    // é…ç½®å­˜ LocalStorage ä»¥é¿å…é‡å¤è¾“å…¥
    var ghConfig = JSON.parse(localStorage.getItem('gh_config')) || { token: '', gistId: '' };

    window.onload = function() {
        initEditor();
        initResizer();
        updateCloudStatus();
        if(ghConfig.token && ghConfig.gistId) {
            syncPull(true); // è‡ªåŠ¨æ‹‰å–
        } else {
            renderList(); // æ¸²æŸ“ç©ºåˆ—è¡¨
        }
    };

    function initEditor() {
        mainEditor = CodeMirror.fromTextArea(document.getElementById("code-editor"), { mode: "markdown", theme: "default", lineNumbers: true, lineWrapping: true, extraKeys: {"Ctrl-Space": "autocomplete"} });
        mainEditor.on("inputRead", function(cm, change) { if (change.text[0].match(/[\\a-zA-Z]/)) CodeMirror.commands.autocomplete(cm, null, { completeSingle: false }); });
        mainEditor.on("change", () => updatePreview());

        CodeMirror.registerHelper("hint", "markdown", function(editor) {
            var cur = editor.getCursor(); var token = editor.getTokenAt(cur);
            var start = token.start; var end = cur.ch; var word = token.string.slice(0, end - start);
            var list = LATEX_KEYWORDS.filter(function(item) { var text = (typeof item === "string") ? item : item.displayText; return text.indexOf(word) >= 0; });
            return { list: list, from: CodeMirror.Pos(cur.line, start), to: CodeMirror.Pos(cur.line, end) };
        });
    }

    // --- ä¾§è¾¹æ æ‹–æ‹½è°ƒæ•´å®½åº¦ ---
    function initResizer() {
        const resizer = document.getElementById('resizer');
        const sidebar = document.getElementById('sidebar');
        let isResizing = false;

        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            resizer.classList.add('resizing');
            document.body.style.cursor = 'col-resize';
            document.body.style.userSelect = 'none'; // é˜²æ­¢æ‹–åŠ¨æ—¶é€‰ä¸­æ–‡æœ¬
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            // é™åˆ¶å®½åº¦èŒƒå›´
            let newWidth = e.clientX;
            if (newWidth < 150) newWidth = 150;
            if (newWidth > 600) newWidth = 600;
            sidebar.style.width = newWidth + 'px';
        });

        document.addEventListener('mouseup', () => {
            isResizing = false;
            resizer.classList.remove('resizing');
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
        });
    }

    // --- äº‘ç«¯åŒæ­¥ (æ ¸å¿ƒ: å»æ‰æœ¬åœ°æ•°æ®å­˜å‚¨) ---
    function openConfig() {
        document.getElementById('cfg-token').value = ghConfig.token;
        document.getElementById('cfg-id').value = ghConfig.gistId;
        document.getElementById('config-modal').style.display = 'flex';
    }

    function saveConfig() {
        ghConfig.token = document.getElementById('cfg-token').value.trim();
        ghConfig.gistId = document.getElementById('cfg-id').value.trim();
        localStorage.setItem('gh_config', JSON.stringify(ghConfig)); // ä»…ä¿å­˜é…ç½®
        document.getElementById('config-modal').style.display = 'none';
        updateCloudStatus();
        syncPull(); 
    }

    function updateCloudStatus() {
        const msg = document.getElementById('cloud-msg');
        if(!ghConfig.token || !ghConfig.gistId) {
            msg.innerText = "ğŸ“¡ æœªé…ç½®äº‘ç«¯";
            msg.style.color = "#ff9900";
        } else {
            msg.innerText = "âœ… äº‘ç«¯å·²é…ç½®";
            msg.style.color = "#4caf50";
        }
    }

    async function syncPull(silent = false) {
        if(!ghConfig.token) return (!silent && alert("è¯·å…ˆé…ç½®å¯†é’¥"));
        const msg = document.getElementById('cloud-msg');
        msg.innerText = "ğŸ”„ æ­£åœ¨æ‹‰å–...";
        
        try {
            const res = await fetch(`https://api.github.com/gists/${ghConfig.gistId}`, {
                headers: { "Authorization": `token ${ghConfig.token}`, "Cache-Control": "no-cache" }
            });
            if(!res.ok) throw new Error("è¿æ¥å¤±è´¥ " + res.status);
            const json = await res.json();
            const fileContent = json.files["data.json"].content;
            
            // è¦†ç›–å†…å­˜ä¸­çš„ data
            data = JSON.parse(fileContent);
            // ç¡®ä¿æ—§æ•°æ®æœ‰ pinned å­—æ®µ
            data.forEach(item => { if(typeof item.pinned === 'undefined') item.pinned = false; });

            renderList();
            if(data.length > 0 && !currentId) loadDetail(data[0].id); // é»˜è®¤åŠ è½½ç¬¬ä¸€ä¸ª
            else if(currentId) loadDetail(currentId); // åˆ·æ–°å½“å‰
            
            msg.innerText = "â˜ï¸ å·²åŒæ­¥ (" + new Date().toLocaleTimeString() + ")";
            if(!silent) console.log("æ‹‰å–æˆåŠŸ");
        } catch(e) {
            msg.innerText = "âŒ æ‹‰å–å¤±è´¥";
            if(!silent) alert("åŒæ­¥å¤±è´¥: " + e.message);
        }
    }

    async function syncPush() {
        if(!ghConfig.token) return alert("è¯·å…ˆé…ç½®å¯†é’¥");
        const msg = document.getElementById('cloud-msg');
        msg.innerText = "â¬†ï¸ æ­£åœ¨ä¸Šä¼ ...";
        
        try {
            const payload = {
                files: { "data.json": { content: JSON.stringify(data, null, 2) } }
            };
            const res = await fetch(`https://api.github.com/gists/${ghConfig.gistId}`, {
                method: "PATCH",
                headers: { "Authorization": `token ${ghConfig.token}`, "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            });
            if(!res.ok) throw new Error("ä¸Šä¼ å¤±è´¥ " + res.status);
            
            msg.innerText = "â˜ï¸ ä¸Šä¼ æˆåŠŸ (" + new Date().toLocaleTimeString() + ")";
        } catch(e) {
            msg.innerText = "âŒ ä¸Šä¼ å¤±è´¥";
            alert("ä¸Šä¼ å¤±è´¥: " + e.message);
        }
    }

    // --- æ¸²æŸ“ä¸åˆ—è¡¨æ‹–æ‹½ ---
    function renderContent(text) {
        if (!text) return "";
        let html = marked.parse(text);
        const envs = [ { tags: ['thm','theorem'], name: 'Theorem', class: 'env-thm' }, { tags: ['conjecture','conj'], name: 'Conjecture', class: 'env-conj' }, { tags: ['lemma'], name: 'Lemma', class: 'env-lemma' }, { tags: ['defn'], name: 'Definition', class: 'env-defn' }, { tags: ['proof'], name: 'Proof', class: 'env-proof', isProof: true } ];
        envs.forEach(env => {
            env.tags.forEach(tag => {
                const regex = new RegExp(`\\\\begin\\{${tag}\\}([\\s\\S]*?)\\\\end\\{${tag}\\}`, 'gi');
                html = html.replace(regex, (m, c) => {
                    c = c.replace(/^<p>|<\/p>$/g, '');
                    return env.isProof ? `<div class="${env.class}"><span class="env-title">${env.name}.</span> <span class="env-content">${c}</span> <span class="qed-symbol">â—¼</span></div>` : `<div class="env-block ${env.class}"><span class="env-title">${env.name}.</span> <span class="env-content">${c}</span></div>`;
                });
            });
        });
        return html;
    }

    // åˆ—è¡¨æ‹–æ‹½é€»è¾‘
    let dragSrcEl = null;

    function handleDragStart(e) {
        dragSrcEl = this;
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/html', this.innerHTML);
        this.classList.add('dragging');
    }

    function handleDragOver(e) {
        if (e.preventDefault) e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
        return false;
    }

    function handleDrop(e) {
        if (e.stopPropagation) e.stopPropagation();
        const dragEndEl = this;
        
        if (dragSrcEl !== dragEndEl) {
            // è·å–ç´¢å¼•
            const oldIndex = parseInt(dragSrcEl.getAttribute('data-index'));
            const newIndex = parseInt(dragEndEl.getAttribute('data-index'));
            
            // ç§»åŠ¨æ•°æ®
            const item = data.splice(oldIndex, 1)[0];
            data.splice(newIndex, 0, item);
            
            // ä¿å­˜å¹¶é‡æ–°æ¸²æŸ“
            renderList();
            syncPush(); 
        }
        return false;
    }
    
    function handleDragEnd(e) {
        this.classList.remove('dragging');
        let items = document.querySelectorAll('#list .item');
        items.forEach(function (item) {
            item.classList.remove('over');
        });
    }

    function renderList() {
        var listHtml = '';
        if(data.length === 0) {
            document.getElementById('list').innerHTML = '<div style="padding:20px; text-align:center; color:#999; font-size:12px">æš‚æ— é—®é¢˜</div>';
            return;
        }

        data.forEach((item, index) => {
            var activeClass = (item.id === currentId) ? 'active' : '';
            var pinnedClass = (item.pinned) ? 'pinned' : '';
            var pinIcon = (item.pinned) ? 'ğŸ“Œ' : 'ğŸ“Œ'; // å›¾æ ‡å¯ä»¥ä¸€æ ·ï¼Œç”¨æ ·å¼åŒºåˆ†é¢œè‰²
            
            listHtml += `
            <li class="item ${activeClass}" draggable="true" data-index="${index}" onclick="loadDetail(${item.id})">
                <div class="pin-btn ${pinnedClass}" onclick="togglePin(event, ${index})" title="ç½®é¡¶/å–æ¶ˆç½®é¡¶">${pinIcon}</div>
                <div class="item-content">
                    <div class="item-title">${escapeHtml(item.title)}</div>
                    <div class="item-date">${new Date(item.date).toLocaleDateString()}</div>
                </div>
            </li>`;
        });
        
        const listEl = document.getElementById('list');
        listEl.innerHTML = listHtml;

        // ç»‘å®šæ‹–æ‹½äº‹ä»¶
        let items = listEl.querySelectorAll('.item');
        items.forEach(function(item) {
            item.addEventListener('dragstart', handleDragStart, false);
            item.addEventListener('dragover', handleDragOver, false);
            item.addEventListener('drop', handleDrop, false);
            item.addEventListener('dragend', handleDragEnd, false);
        });
    }

    function togglePin(e, index) {
        e.stopPropagation(); // é˜²æ­¢è§¦å‘ list click
        const item = data[index];
        item.pinned = !item.pinned;
        
        if(item.pinned) {
            // å¦‚æœç½®é¡¶ï¼Œç§»åŠ¨åˆ°æ•°ç»„æœ€å‰é¢
            data.splice(index, 1);
            data.unshift(item);
        } else {
            // å–æ¶ˆç½®é¡¶ï¼Œæš‚æ—¶ä¸åŠ¨ä½ç½®ï¼Œç”¨æˆ·è‡ªå·±æ‹–ï¼Œæˆ–è€…åˆ·æ–°åè¿˜åœ¨åŸä½
            // ç­–ç•¥ï¼šä¿æŒå½“å‰ä½ç½®ï¼Œåªæ˜¯æ”¹å˜çŠ¶æ€é¢œè‰²
        }
        renderList();
        syncPush();
    }

    function loadDetail(id) {
        currentId = id;
        var item = data.find(x => x.id === id);
        if (!item) return;

        document.getElementById('empty-msg').style.display = 'none';
        document.getElementById('detail-view').style.display = 'flex';
        document.getElementById('editor-container').style.display = 'none';
        document.getElementById('d-title').innerText = item.title;
        document.getElementById('d-date').innerText = new Date(item.date).toLocaleString();
        document.getElementById('d-desc').innerHTML = renderContent(item.desc);
        
        var ansHtml = '';
        if (!item.answers || item.answers.length === 0) ansHtml = '<div style="color:#999; font-style:italic; text-align:center; padding:20px;">æš‚æ— ç¬”è®°</div>';
        else {
            item.answers.forEach((ans, idx) => {
                ansHtml += `<div class="ans-item"><div class="markdown-body">${renderContent(ans.text)}</div><div class="ans-meta"><span>${new Date(ans.date).toLocaleString()}</span><span><button class="btn-link" style="color:#de350b; border:none; background:none; cursor:pointer;" onclick="delAns(${idx})">åˆ é™¤</button></span></div></div>`;
            });
        }
        document.getElementById('ans-list').innerHTML = ansHtml;
        
        // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥æ›´æ–°é«˜äº®
        renderList();
        
        if (window.MathJax) MathJax.typesetPromise([document.getElementById('d-desc'), document.getElementById('ans-list')]);
    }

    // --- å…¨å±ç¼–è¾‘å™¨é€»è¾‘ ---
    
    function enterEditMode(mode) {
        editMode = mode; // 'question' or 'note'
        var item = data.find(x => x.id === currentId);
        if(!item) return;

        document.getElementById('detail-view').style.display = 'none';
        document.getElementById('editor-container').style.display = 'flex';
        
        if (mode === 'question') {
            document.getElementById('editor-mode-text').innerText = "âœï¸ ç¼–è¾‘é—®é¢˜";
            document.getElementById('editor-title').style.display = 'block';
            document.getElementById('editor-title').value = item.title;
            mainEditor.setValue(item.desc);
        } else {
            document.getElementById('editor-mode-text').innerText = "ğŸ“ æ·»åŠ æ–°ç¬”è®°";
            document.getElementById('editor-title').style.display = 'none';
            mainEditor.setValue(""); // ç¬”è®°é»˜è®¤ä¸ºç©º
        }
        
        setTimeout(() => mainEditor.refresh(), 100);
        updatePreview();
    }

    function updatePreview() {
        const text = mainEditor.getValue();
        const previewEl = document.getElementById('editor-preview');
        previewEl.innerHTML = renderContent(text);
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => { if (window.MathJax) MathJax.typesetPromise([previewEl]); }, 300);
    }

    function saveEdit() {
        var item = data.find(x => x.id === currentId);
        if(!item) return;

        if (editMode === 'question') {
            item.title = document.getElementById('editor-title').value;
            item.desc = mainEditor.getValue();
        } else {
            // ä¿å­˜ç¬”è®°
            const noteText = mainEditor.getValue();
            if(!noteText.trim()) { alert("ç¬”è®°å†…å®¹ä¸ºç©º"); return; }
            if(!item.answers) item.answers = [];
            item.answers.push({ text: noteText, date: new Date().toISOString() });
        }

        syncPush(); // ä¿å­˜åˆ°äº‘ç«¯
        exitEditMode();
        loadDetail(currentId);
    }

    function exitEditMode() {
        document.getElementById('editor-container').style.display = 'none';
        document.getElementById('detail-view').style.display = 'flex';
    }

    // --- å…¶ä»–æ“ä½œ ---
    function saveNew() {
        var t = document.getElementById('m-title').value; var d = document.getElementById('m-desc').value; if (!t) return alert('æ ‡é¢˜ä¸èƒ½ä¸ºç©º');
        // æ–°å»ºæ—¶ï¼Œå¦‚æœéœ€è¦ç½®é¡¶ï¼Œpinnedè®¾ä¸ºfalseï¼Œè®©ç”¨æˆ·è‡ªå·±ç‚¹
        var newItem = { id: Date.now(), title: t, desc: d, date: new Date().toISOString(), answers: [], pinned: false };
        data.unshift(newItem);
        syncPush();
        document.getElementById('modal').style.display = 'none';
        document.getElementById('m-title').value = ''; document.getElementById('m-desc').value = '';
        loadDetail(newItem.id);
    }
    
    function delAns(idx) { if(confirm('åˆ é™¤æ­¤ç¬”è®°ï¼Ÿ')) { var item = data.find(x => x.id === currentId); item.answers.splice(idx, 1); syncPush(); loadDetail(currentId); } }
    
    function doDelete() { if(confirm('åˆ é™¤æ•´ä¸ªé—®é¢˜ï¼Ÿ')) { data = data.filter(x => x.id !== currentId); syncPush(); if(data.length > 0) loadDetail(data[0].id); else { currentId = null; location.reload(); } } }

    function openModal() { document.getElementById('modal').style.display = 'flex'; }
    function escapeHtml(text) { if (!text) return text; return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
    
    // å¯¼å‡ºåŠŸèƒ½
    function doExport() {
        var item = data.find(x => x.id === currentId);
        if (!item) return;
        var content = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>' + escapeHtml(item.title) + '</title>';
        content += '<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"><\/script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" async><\/script><script>MathJax={tex:{inlineMath:[["$","$"],["\\\\(","\\\\)"]]}}<\/script>';
        content += '<style>body{max-width:900px;margin:20px auto;font-family:sans-serif;padding:20px;line-height:1.6;color:#333} .ans{background:#f9f9f9;padding:15px;border:1px solid #eee;margin-bottom:10px;border-radius:5px;} .env-block {margin:15px 0;padding:15px;border-radius:4px;text-align:left;background:#e6effc;border-left:4px solid #0052cc;font-style:italic;} .env-title {font-weight:bold;color:#0052cc;margin-right:5px;font-style:normal;} .env-conj {background:#fff7e6;border-left-color:#ff9900;} .env-conj .env-title {color:#d97706;} blockquote {border-left:4px solid #ddd;padding-left:15px;color:#777;} code {background:#f4f4f4;padding:2px 5px;border-radius:3px;font-family:monospace;} pre {background:#f4f4f4;padding:10px;border-radius:5px;overflow-x:auto;} h1,h2,h3 {border-bottom:1px solid #eee;padding-bottom:10px;}</style></head><body>';
        content += '<h1 style="color:#0052cc">' + escapeHtml(item.title) + '</h1><p style="color:#888">Exported: ' + new Date().toLocaleString() + '</p><div id="desc-content"></div><h3 style="margin-top:40px">ç¬”è®°ä¸è®¨è®º</h3><div id="ans-container"></div>';
        content += '<script>var rawDesc=' + JSON.stringify(item.desc) + '; var rawAnswers=' + JSON.stringify(item.answers || []) + '; function render(t){var h=marked.parse(t); return h.replace(/\\\\begin{thm}([\\s\\S]*?)\\\\end{thm}/gi, "<div class=\'env-block\'><span class=\'env-title\'>Theorem.</span>$1</div>").replace(/\\\\begin{conj}([\\s\\S]*?)\\\\end{conj}/gi, "<div class=\'env-block env-conj\'><span class=\'env-title\'>Conjecture.</span>$1</div>");} document.getElementById("desc-content").innerHTML=render(rawDesc); var ah=""; rawAnswers.forEach(function(a){ ah+="<div class=\'ans\'>"+render(a.text)+"<div style=\'font-size:12px;color:#999;margin-top:5px\'>"+new Date(a.date).toLocaleString()+"</div></div>"; }); document.getElementById("ans-container").innerHTML=ah; <\/script></body></html>';
        var blob = new Blob([content], { type: 'text/html;charset=utf-8' });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a'); a.href = url; a.download = 'Research-' + item.title + '.html'; a.click();
    }
</script>
</body>
</html>
