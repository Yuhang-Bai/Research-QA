<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§‘ç ”ç®¡ç†å™¨ v10 (å…¨åµŒå…¥å¼ç¼–è¾‘ç‰ˆ)</title>
    
    <!-- ä¾èµ–åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        MathJax = {
            tex: { 
                inlineMath: [['$', '$'], ['\\(', '\\)']], 
                displayMath: [['$$', '$$'], ['\\[', '\\]']], 
                processEscapes: true,
                tags: 'ams',
                macros: {
                    R: "{\\mathbb{R}}", N: "{\\mathbb{N}}", Z: "{\\mathbb{Z}}", Q: "{\\mathbb{Q}}", C: "{\\mathbb{C}}",
                    P: "{\\mathbb{P}}", E: "{\\mathbb{E}}",
                    bf: ["{\\mathbf{#1}}", 1], rm: ["{\\mathrm{#1}}", 1], it: ["{\\mathit{#1}}", 1], cal: ["{\\mathcal{#1}}", 1]
                }
            },
            startup: { typeset: false }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    
    <!-- CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/markdown/markdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
    
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; height: 100vh; background: #f4f5f7; overflow: hidden; color: #333; }
        
        /* UI åŸºç¡€ */
        .bar-btn { background: #444; border: 1px solid #666; color: white; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 8px;}
        .bar-btn:hover { background: #666; }
        .bar-btn.primary { background: #0366d6; border-color: #0366d6; }
        .bar-btn.warn { background: #d73a49; border-color: #d73a49; }

        /* é¡¶éƒ¨æ  */
        #status-bar { position: absolute; top: 0; left: 0; width: 100%; height: 40px; background: #24292e; color: #fff; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-sizing: border-box; z-index: 100; }

        /* å¸ƒå±€ */
        #container { display: flex; width: 100%; height: 100%; padding-top: 40px; box-sizing: border-box; }
        #sidebar { width: 280px; background: #f9f9f9; display: flex; flex-direction: column; flex-shrink: 0; border-right: 1px solid #ddd; }
        #resizer { width: 5px; background: #ddd; cursor: col-resize; z-index: 10; transition: background 0.2s; }
        #resizer:hover, #resizer.resizing { background: #0366d6; }
        #main { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: white; position: relative; }

        /* åˆ—è¡¨ */
        .sidebar-header { padding: 10px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; background: #fff;}
        #list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        .item { padding: 12px 10px; border-bottom: 1px solid #eee; cursor: pointer; border-left: 4px solid transparent; display: flex; align-items: flex-start; gap: 8px; user-select: none;}
        .item:hover { background: #eaeaea; }
        .item.active { background: #e6effc; border-left: 4px solid #0052cc; }
        
        .pin-icon { color: #ccc; font-size: 12px; cursor: pointer; }
        .pin-icon.pinned { color: #d97706; }
        .share-icon { font-size: 12px; margin-left: 5px; color: #00875a; display:none; }
        .item.shared .share-icon { display: inline; }
        .item-title { font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }

        /* è¯¦æƒ…åŒº */
        #detail-view { display: none; width: 100%; height: 100%; flex-direction: column; overflow-y: auto; }
        .content-wrap { padding: 30px 50px; max-width: 900px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        .markdown-body { line-height: 1.7; font-size: 16px; color: #24292e; }
        .markdown-body pre { background: #f6f8fa; padding: 15px; border-radius: 6px; overflow: auto; }
        
        /* ç¼–è¾‘å™¨é€šç”¨æ ·å¼ */
        .CodeMirror { height: 100%; font-family: "SFMono-Regular", Consolas, monospace; font-size: 15px; }
        .CodeMirror-hints { z-index: 3000; }

        /* [é€šç”¨] åµŒå…¥å¼ç¼–è¾‘å™¨å®¹å™¨æ ·å¼ */
        .embedded-editor {
            display: none; /* é»˜è®¤éšè— */
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-top: 15px;
            background: #fff;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .embedded-editor .toolbar {
            padding: 8px 15px;
            background: #f4f5f7;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .embedded-editor .editor-area {
            display: flex;
            height: 400px; /* ç»Ÿä¸€é«˜åº¦ */
        }
        .embedded-editor .pane {
            width: 50%;
            height: 100%;
            overflow-y: auto;
        }
        .embedded-editor .preview-pane {
            padding: 20px;
            background: #fff;
            border-left: 1px solid #eee;
        }

        /* LaTeX ç¯å¢ƒ */
        .env-block { margin: 1em 0; padding: 15px; border-radius: 4px; border-left: 4px solid #555; background: #f9f9f9; }
        .env-thm { background: #e6effc; border-left-color: #0052cc; } .env-thm .env-title { color: #0052cc; font-weight: bold; }
        .env-conj { background: #fff7e6; border-left-color: #ff9900; } .env-conj .env-title { color: #d97706; }
        .env-lemma { background: #f4f5f7; border-left-color: #5e6c84; } .env-lemma .env-title { color: #42526e; font-weight: bold; }
        .env-defn { background: #e3fcef; border-left-color: #00875a; } .env-defn .env-title { color: #006644; font-weight: bold; }
        .env-proof { background: #fff; border-left: 2px solid #ddd; color: #333; font-style: normal; } 
        .env-proof .env-title { font-style: italic; font-weight: bold; color:#555; }

        /* å…¶ä»– */
        #collab-banner { display: none; background: #e6ffed; color: #0052cc; padding: 8px; text-align: center; border-bottom: 1px solid #bfebbb; font-size: 13px; }
        #loading { display: flex; position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 2000; justify-content: center; align-items: center; font-weight: bold; font-size: 18px; color: #333; flex-direction: column; gap: 10px; }
        .modal { display: none; position: fixed; inset: 0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index: 1000; }
        .modal-box { background:white; padding:25px; width:450px; border-radius:8px; display:flex; flex-direction:column; gap:15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .inp { padding: 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%; box-sizing: border-box; }
        
        body.visitor-mode .only-owner { display: none !important; }
        body.visitor-mode #sidebar { display: none; }
        body.visitor-mode #resizer { display: none; }
    </style>
</head>
<body>

<div id="loading">
    <div>ğŸš€ æ­£åœ¨è¿æ¥äº‘ç«¯...</div>
    <div id="loading-tip" style="font-size:12px; font-weight:normal; color:#666;"></div>
</div>

<!-- é¡¶éƒ¨æ  -->
<div id="status-bar">
    <div style="display:flex; align-items:center; gap:10px;">
        <span id="app-title" style="font-weight:bold;">ç§‘ç ”ç®¡ç†å™¨ v10 (åµŒå…¥å¼ç¼–è¾‘ç‰ˆ)</span>
        <span id="sync-status" style="font-size:12px; color:#aaa;">âšª å°±ç»ª</span>
    </div>
    <div id="auth-controls">
        <button class="bar-btn" onclick="syncPull()">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
        <button class="bar-btn warn" onclick="openConfig()">âš™ï¸ å¯†é’¥</button>
    </div>
</div>

<div id="container">
    <!-- å·¦ä¾§ -->
    <div id="sidebar">
        <div class="sidebar-header">
            <h3>ğŸ“š é—®é¢˜åº“</h3>
            <button class="bar-btn primary" onclick="createNewLocal()">+</button>
        </div>
        <ul id="list"></ul>
    </div>
    <div id="resizer"></div>

    <!-- ä¸»åŒºåŸŸ -->
    <div id="main">
        <div id="collab-banner">ğŸŒ <b>å®æ—¶åä½œä¸­</b>ï¼šå†…å®¹å­˜å‚¨åœ¨ç‹¬ç«‹äº‘ç«¯é“¾æ¥ï¼Œä¿®æ”¹å®æ—¶äº’é€šã€‚</div>
        
        <div id="empty-msg" style="text-align:center; color:#888; margin-top:20vh;">
            <h2>è¯·é€‰æ‹©ä¸€ä¸ªé—®é¢˜</h2>
        </div>

        <div id="detail-view">
            <!-- é—®é¢˜è¯¦æƒ…åŒº -->
            <div class="content-wrap">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:10px; border-bottom:1px solid #eee;">
                    <span id="d-date" style="color:#888; font-size:12px;"></span>
                    <div style="display:flex; gap:10px;">
                        <button class="bar-btn only-owner" id="btn-share" onclick="manageCollaboration()">ğŸ”— ç®¡ç†åä½œ</button>
                        <button class="bar-btn" onclick="openProblemEditor()">âœï¸ ç¼–è¾‘é—®é¢˜</button>
                        <button class="bar-btn warn only-owner" onclick="deleteItem()">ğŸ—‘ï¸</button>
                    </div>
                </div>

                <!-- é—®é¢˜å±•ç¤ºæ¨¡å¼ -->
                <div id="problem-display-area">
                    <h1 id="d-title" style="color:#0052cc; margin-top:0;"></h1>
                    <div id="d-desc" class="markdown-body"></div>
                </div>

                <!-- [æ–°] åµŒå…¥å¼é—®é¢˜ç¼–è¾‘å™¨ -->
                <div id="problem-editor-wrapper" class="embedded-editor">
                    <div class="toolbar">
                        <input id="prob-title-inp" class="inp" style="width:60%; border:1px solid #ccc; padding:6px;" placeholder="é—®é¢˜æ ‡é¢˜">
                        <div>
                            <button class="bar-btn" onclick="closeProblemEditor()">å–æ¶ˆ</button>
                            <button class="bar-btn primary" onclick="saveProblem()">ğŸ’¾ ä¿å­˜ (Ctrl+S)</button>
                        </div>
                    </div>
                    <div class="editor-area">
                        <div class="pane"><textarea id="prob-code-editor"></textarea></div>
                        <div class="pane preview-pane"><div id="prob-live-preview" class="markdown-body"></div></div>
                    </div>
                </div>
            </div>

            <div style="background:#f4f5f7; padding:10px 50px; font-weight:bold; font-size:13px; color:#666; margin-top:20px;">
                ç¬”è®° / è®¨è®º
            </div>

            <div class="content-wrap" style="padding-top:20px; padding-bottom:50px;">
                <div id="ans-list"></div>
                
                <!-- åµŒå…¥å¼ç¬”è®°ç¼–è¾‘å™¨åŒºåŸŸ -->
                <div id="note-section-footer" style="margin-top:30px;">
                    <div id="note-trigger-btn" style="text-align:center;">
                        <button class="bar-btn primary" style="padding:10px 40px; font-size:14px;" onclick="openNoteEditor()">â• æ·»åŠ ç¬”è®°</button>
                    </div>
                    
                    <div id="note-editor-wrapper" class="embedded-editor">
                        <div class="toolbar">
                            <span style="font-weight:bold;">ğŸ“ æ–°ç¬”è®°</span>
                            <div>
                                <button class="bar-btn" onclick="closeNoteEditor()">å–æ¶ˆ</button>
                                <button class="bar-btn primary" onclick="saveNote()">ğŸ’¾ æäº¤ç¬”è®° (Ctrl+S)</button>
                            </div>
                        </div>
                        <div class="editor-area">
                            <div class="pane"><textarea id="note-code-editor"></textarea></div>
                            <div class="pane preview-pane"><div id="note-live-preview" class="markdown-body"></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Config Modal -->
<div id="config-modal" class="modal">
    <div class="modal-box">
        <h3 style="margin:0">âš™ï¸ è¿æ¥è®¾ç½®</h3>
        <div style="background:#fff3cd; color:#856404; padding:10px; font-size:12px; border-radius:4px;">
            âš ï¸ è‹¥å‡ºç° "Failed to fetch"ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼ˆéœ€è®¿é—® GitHub APIï¼‰æˆ– Tokenã€‚
        </div>
        <div>
            <label style="font-size:12px; font-weight:bold;">GitHub Token (å¿…å¡«):</label>
            <input class="inp" id="cfg-token" type="password" placeholder="æ ¼å¼å¦‚: ghp_xxxxxxxxxxxx">
        </div>
        <div>
            <label style="font-size:12px; font-weight:bold;">ä¸»æ•°æ®åº“ Gist ID:</label>
            <input class="inp" id="cfg-id" placeholder="åˆæ¬¡ä½¿ç”¨è¯·ç•™ç©º">
        </div>
        <div style="text-align:right;">
            <button class="bar-btn" onclick="document.getElementById('config-modal').style.display='none'">å…³é—­</button>
            <button class="bar-btn primary" onclick="saveConfig()">ä¿å­˜å¹¶æµ‹è¯•</button>
        </div>
    </div>
</div>

<script>
    // --- æ ¸å¿ƒå˜é‡ ---
    const CFG_KEY = 'v7_config';
    let ghConfig = JSON.parse(localStorage.getItem(CFG_KEY)) || { token: '', mainGistId: '' };
    
    // LaTeX è¡¥å…¨è¯åº“
    const LATEX_KEYWORDS = [
        { text: "\\begin{thm}\n\n\\end{thm}", displayText: "thm (å®šç†)" },
        { text: "\\begin{proof}\n\n\\end{proof}", displayText: "proof (è¯æ˜)" },
        { text: "\\begin{lemma}\n\n\\end{lemma}", displayText: "lemma (å¼•ç†)" },
        { text: "\\begin{defn}\n\n\\end{defn}", displayText: "defn (å®šä¹‰)" },
        { text: "\\begin{conj}\n\n\\end{conj}", displayText: "conj (çŒœæƒ³)" },
        { text: "\\begin{align}\n\n\\end{align}", displayText: "align (å¤šè¡Œå…¬å¼)" },
        { text: "\\begin{itemize}\n\\item \n\\end{itemize}", displayText: "itemize (åˆ—è¡¨)" },
        { text: "\\begin{enumerate}\n\\item \n\\end{enumerate}", displayText: "enumerate (åºå·åˆ—è¡¨)" },
        { text: "\\begin{bmatrix}\n\n\\end{bmatrix}", displayText: "bmatrix (çŸ©é˜µ)" },
        { text: "\\frac{}{}", displayText: "\\frac (åˆ†æ•°)" },
        { text: "\\sqrt{}", displayText: "\\sqrt (æ ¹å·)" },
        { text: "\\sum_{}^{}", displayText: "\\sum (æ±‚å’Œ)" },
        { text: "\\prod_{}^{}", displayText: "\\prod (ä¹˜ç§¯)" },
        { text: "\\int_{}^{}", displayText: "\\int (ç§¯åˆ†)" },
        { text: "\\lim_{ \\to }", displayText: "\\lim (æé™)" },
        "\\alpha", "\\beta", "\\gamma", "\\Gamma", "\\delta", "\\Delta", "\\epsilon", "\\varepsilon", "\\zeta", "\\eta", 
        "\\theta", "\\Theta", "\\iota", "\\kappa", "\\lambda", "\\Lambda", "\\mu", "\\nu", "\\xi", "\\Xi", "\\pi", "\\Pi", 
        "\\rho", "\\sigma", "\\Sigma", "\\tau", "\\upsilon", "\\phi", "\\Phi", "\\chi", "\\psi", "\\Psi", "\\omega", "\\Omega",
        "\\in", "\\notin", "\\subset", "\\subseteq", "\\cup", "\\cap", "\\setminus", "\\emptyset", "\\forall", "\\exists", "\\implies", "\\iff",
        "\\mathbb{}", "\\mathcal{}", "\\mathbf{}", "\\mathrm{}", "\\text{}", "\\hat{}", "\\bar{}", "\\tilde{}", "\\vec{}"
    ];

    let db = { items: [] };
    let currentId = null;
    let currentItemData = null; 
    
    // ä¸¤ä¸ªç¼–è¾‘å™¨å®ä¾‹
    let probCm, noteCm;

    const urlParams = new URLSearchParams(window.location.search);
    const visitorGistId = urlParams.get('gist');

    // --- åˆå§‹åŒ– ---
    window.onload = async function() {
        initEditors();
        if (visitorGistId) {
            enterVisitorMode();
        } else {
            if (ghConfig.token && ghConfig.mainGistId) {
                await syncPullMain();
            } else {
                document.getElementById('loading').style.display = 'none';
                openConfig();
            }
        }
    };

    function initEditors() {
        // é…ç½®é¡¹
        const cmConfig = {
            mode: "markdown", lineNumbers: true, lineWrapping: true, 
            extraKeys: { "Ctrl-Space": "autocomplete" }
        };

        // 1. é—®é¢˜ç¼–è¾‘å™¨ (åµŒå…¥å¼)
        probCm = CodeMirror.fromTextArea(document.getElementById("prob-code-editor"), {
            ...cmConfig, extraKeys: { ...cmConfig.extraKeys, "Ctrl-S": saveProblem }
        });
        setupCmEvents(probCm, 'prob-live-preview');

        // 2. ç¬”è®°ç¼–è¾‘å™¨ (åµŒå…¥å¼)
        noteCm = CodeMirror.fromTextArea(document.getElementById("note-code-editor"), {
            ...cmConfig, extraKeys: { ...cmConfig.extraKeys, "Ctrl-S": saveNote }
        });
        setupCmEvents(noteCm, 'note-live-preview');

        // æ³¨å†Œ Hint Helper (é€šç”¨)
        CodeMirror.registerHelper("hint", "markdown", function(editor) {
            var cur = editor.getCursor(); 
            var token = editor.getTokenAt(cur);
            var start = token.start; 
            var end = cur.ch; 
            var word = token.string.slice(0, end - start);
            
            if (word === "" && token.string === "\\") { word = "\\"; start = token.start; }

            var list = LATEX_KEYWORDS.filter(function(item) { 
                var text = (typeof item === "string") ? item : item.displayText || item.text; 
                return text.indexOf(word) >= 0; 
            });
            
            var hintResult = { list: list, from: CodeMirror.Pos(cur.line, start), to: CodeMirror.Pos(cur.line, end) };
            CodeMirror.on(hintResult, "pick", function(completion) {
                var text = (typeof completion === "string") ? completion : completion.text;
                var braceIdx = text.indexOf("{}");
                if (braceIdx !== -1) { editor.setCursor({ line: cur.line, ch: start + braceIdx + 1 }); }
            });
            return hintResult;
        });

        // æ‹–æ‹½åˆ†æ 
        const resizer = document.getElementById('resizer');
        const sidebar = document.getElementById('sidebar');
        resizer.addEventListener('mousedown', () => {
            document.addEventListener('mousemove', resize, false);
            document.addEventListener('mouseup', stopResize, false);
        });
        function resize(e) { sidebar.style.width = Math.max(150, Math.min(600, e.clientX)) + 'px'; }
        function stopResize() { document.removeEventListener('mousemove', resize, false); document.removeEventListener('mouseup', stopResize, false); }
    }

    function setupCmEvents(cm, previewId) {
        cm.on("inputRead", function(cm, change) { 
            if (change.text[0].match(/[\\a-zA-Z]/)) { CodeMirror.commands.autocomplete(cm, null, { completeSingle: false }); }
        });
        cm.on("change", () => {
            const val = cm.getValue();
            document.getElementById(previewId).innerHTML = renderContent(val);
            if(window.MathJax) MathJax.typesetPromise([document.getElementById(previewId)]);
        });
    }

    function renderContent(text) {
        if (!text) return "";
        let html = marked.parse(text);
        
        const envs = [ 
            { tags: ['thm','theorem'], name: 'Theorem', class: 'env-thm' }, 
            { tags: ['conjecture','conj'], name: 'Conjecture', class: 'env-conj' }, 
            { tags: ['lemma'], name: 'Lemma', class: 'env-lemma' },
            { tags: ['defn','definition'], name: 'Definition', class: 'env-defn' },
            { tags: ['proof'], name: 'Proof', class: 'env-proof', isProof: true } 
        ];

        envs.forEach(env => {
            env.tags.forEach(tag => {
                const regex = new RegExp(`\\\\begin\\{${tag}\\}([\\s\\S]*?)\\\\end\\{${tag}\\}`, 'gi');
                html = html.replace(regex, (m, c) => {
                    c = c.replace(/^\s*<p>|<\/p>\s*$/g, '');
                    let blockHtml = "";
                    if (env.isProof) {
                        blockHtml = `<div class="${env.class}"><span class="env-title">${env.name}.</span> <span class="env-content">${c}</span> <span style="float:right">â—¼</span></div>`;
                    } else {
                        blockHtml = `<div class="env-block ${env.class}"><span class="env-title">${env.name}.</span> <span class="env-content">${c}</span></div>`;
                    }
                    return blockHtml;
                });
            });
        });

        html = html.replace(/<p>(<div class="env-.*?>[\s\S]*?<\/div>)<\/p>/gi, '$1');
        html = html.replace(/<p>(\\begin{align}[\s\S]*?\\end{align})<\/p>/gi, '$1');
        return html;
    }

    async function syncPull() {
        if (visitorGistId) {
            document.getElementById('loading').style.display = 'flex';
            document.getElementById('loading-tip').innerText = "åˆ·æ–°åä½œå†…å®¹...";
            try { await loadSharedItem(visitorGistId); setMsg("å°±ç»ª"); } 
            catch(e) { handleNetworkError(e); } 
            finally { document.getElementById('loading').style.display = 'none'; }
        } else {
            await syncPullMain();
        }
    }

    async function enterVisitorMode() {
        document.body.classList.add('visitor-mode');
        document.getElementById('auth-controls').innerHTML = ''; 
        document.getElementById('app-title').innerText = "åä½œç¼–è¾‘å™¨ (è®¿å®¢)";
        if (!ghConfig.token) {
            const t = prompt("è¯·è¾“å…¥ GitHub Token ä»¥å¯ç”¨ç¼–è¾‘æƒé™ï¼š");
            if(t) ghConfig.token = t;
        }
        await loadSharedItem(visitorGistId);
    }

    async function syncPullMain() {
        if(!ghConfig.token || !ghConfig.mainGistId) return;
        setMsg("æ­£åœ¨åŒæ­¥åˆ—è¡¨...");
        document.getElementById('loading').style.display = 'flex';
        try {
            const res = await fetch(`https://api.github.com/gists/${ghConfig.mainGistId}`, { headers: { "Authorization": `token ${ghConfig.token}` } });
            await handleApiError(res); 
            const json = await res.json();
            let fileObj = json.files["main_db.json"] || json.files["research_data.json"];
            if (!fileObj) {
                const anyJson = Object.keys(json.files).find(k => k.endsWith('.json'));
                if(anyJson) fileObj = json.files[anyJson];
            }
            if (!fileObj) throw new Error("Gist ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ•°æ®æ–‡ä»¶");
            db = JSON.parse(fileObj.content);
            if(!db.items) { db = Array.isArray(db) ? { items: db } : { items: [] }; }
            renderList();
            setMsg("å°±ç»ª");
        } catch(e) { handleNetworkError(e); } 
        finally { document.getElementById('loading').style.display = 'none'; }
    }

    async function handleApiError(res) {
        if (res.ok) return;
        if (res.status === 401) throw new Error("Token æ— æ•ˆ (401)");
        if (res.status === 403) throw new Error("æƒé™è¢«æ‹’ç» (403)");
        if (res.status === 404) throw new Error("Gist ID é”™è¯¯ (404)");
        throw new Error(`è¿æ¥é”™è¯¯ (${res.status})`);
    }

    function handleNetworkError(e) {
        let msg = e.message;
        if (msg.includes("Failed to fetch")) { msg = "è¿æ¥å¤±è´¥ã€‚è¯·æ£€æŸ¥ç½‘ç»œ(éœ€è®¿é—® GitHub API) æˆ– Tokenã€‚"; }
        alert("âš ï¸ " + msg); setMsg("âŒ è¿æ¥å¤±è´¥"); openConfig(); 
    }

    async function loadItem(id) {
        currentId = id;
        const itemRef = db.items.find(x => x.id === id);
        if(!itemRef) return;

        document.getElementById('empty-msg').style.display = 'none';
        document.getElementById('detail-view').style.display = 'flex';
        document.getElementById('collab-banner').style.display = 'none';
        document.getElementById('loading').style.display = 'flex';
        document.getElementById('loading-tip').innerText = "åŠ è½½å†…å®¹ä¸­...";
        
        // é‡ç½®ç¼–è¾‘å™¨çŠ¶æ€
        closeNoteEditor(); 
        closeProblemEditor(); // [æ–°å¢] åˆ‡æ¢é—®é¢˜æ—¶å…³é—­ç¼–è¾‘

        try {
            if (itemRef.shareId) {
                document.getElementById('collab-banner').style.display = 'block';
                await loadSharedItem(itemRef.shareId); 
            } else {
                currentItemData = itemRef; 
                renderDetailView();
            }
        } catch (e) { handleNetworkError(e); } 
        finally { document.getElementById('loading').style.display = 'none'; setMsg("å°±ç»ª"); }
    }

    async function loadSharedItem(gistId) {
        const res = await fetch(`https://api.github.com/gists/${gistId}`, { headers: { "Authorization": `token ${ghConfig.token}` } });
        await handleApiError(res);
        const json = await res.json();
        currentItemData = JSON.parse(json.files["shared_item.json"].content);
        if(!currentId) currentId = currentItemData.id;
        renderDetailView();
    }

    function renderDetailView() {
        const d = currentItemData;
        
        // æ¸²æŸ“æ˜¾ç¤ºåŒºåŸŸ
        document.getElementById('d-title').innerText = d.title;
        document.getElementById('d-date').innerText = new Date(d.date).toLocaleDateString();
        document.getElementById('d-desc').innerHTML = renderContent(d.desc || "");
        
        // ç¡®ä¿æ˜¾ç¤ºåŒºåŸŸå¯è§
        document.getElementById('problem-display-area').style.display = 'block';
        document.getElementById('problem-editor-wrapper').style.display = 'none';

        document.getElementById('ans-list').innerHTML = (d.answers || []).map((a, i) => `
            <div style="background:#fafbfc; border:1px solid #eee; padding:15px; margin-bottom:10px; border-radius:5px;">
                <div class="markdown-body">${renderContent(a.text)}</div>
                <div style="font-size:12px; color:#aaa; margin-top:5px; display:flex; justify-content:space-between;">
                    <span>${new Date(a.date).toLocaleString()}</span>
                    <button class="bar-btn warn" onclick="deleteAns(${i})">åˆ é™¤</button>
                </div>
            </div>
        `).join('');
        
        if(!visitorGistId) renderList(); 
        if(window.MathJax) MathJax.typesetPromise();
    }

    // --- ç¼–è¾‘å™¨æ§åˆ¶ ---
    
    // [ä¿®æ”¹] é—®é¢˜ç¼–è¾‘å™¨ (åµŒå…¥å¼)
    function openProblemEditor() {
        document.getElementById('problem-display-area').style.display = 'none';
        document.getElementById('problem-editor-wrapper').style.display = 'block';
        
        document.getElementById('prob-title-inp').value = currentItemData.title;
        probCm.setValue(currentItemData.desc);
        
        setTimeout(() => {
            probCm.refresh();
            probCm.focus();
        }, 50);
    }

    function closeProblemEditor() {
        document.getElementById('problem-editor-wrapper').style.display = 'none';
        document.getElementById('problem-display-area').style.display = 'block';
    }

    async function saveProblem() {
        currentItemData.title = document.getElementById('prob-title-inp').value;
        currentItemData.desc = probCm.getValue();
        currentItemData.date = new Date().toISOString();
        
        closeProblemEditor();
        await performSave();
        renderDetailView();
    }

    // ç¬”è®°ç¼–è¾‘å™¨ (åµŒå…¥å¼)
    function openNoteEditor() {
        document.getElementById('note-trigger-btn').style.display = 'none';
        document.getElementById('note-editor-wrapper').style.display = 'block';
        noteCm.setValue('');
        setTimeout(() => { noteCm.refresh(); noteCm.focus(); }, 100);
    }

    function closeNoteEditor() {
        document.getElementById('note-editor-wrapper').style.display = 'none';
        document.getElementById('note-trigger-btn').style.display = 'block';
    }

    async function saveNote() {
        const val = noteCm.getValue();
        if(!val.trim()) return;
        if(!currentItemData.answers) currentItemData.answers = [];
        currentItemData.answers.push({ text: val, date: new Date().toISOString() });
        currentItemData.date = new Date().toISOString();
        
        closeNoteEditor();
        await performSave();
        renderDetailView();
    }

    // --- æ•°æ®ä¿å­˜ä¸ç®¡ç† ---

    async function performSave() {
        setMsg("æ­£åœ¨ä¿å­˜...");
        try {
            let targetShareId = visitorGistId;
            if (!targetShareId && currentId) {
                const ref = db.items.find(x => x.id === currentId);
                if(ref && ref.shareId) targetShareId = ref.shareId;
            }

            if (targetShareId) {
                await updateGistFile(targetShareId, "shared_item.json", currentItemData);
                if (!visitorGistId) {
                    const ref = db.items.find(x => x.id === currentId);
                    ref.title = currentItemData.title;
                    ref.date = currentItemData.date;
                    saveMainDB(true); 
                }
            } else {
                await saveMainDB(true);
            }
            setMsg("âœ… å·²ä¿å­˜");
        } catch(e) { handleNetworkError(e); }
    }

    async function updateGistFile(gistId, filename, dataObj) {
        const res = await fetch(`https://api.github.com/gists/${gistId}`, {
            method: "PATCH",
            headers: { "Authorization": `token ${ghConfig.token}`, "Content-Type": "application/json" },
            body: JSON.stringify({ files: { [filename]: { content: JSON.stringify(dataObj, null, 2) } } })
        });
        await handleApiError(res);
    }
    
    async function saveMainDB(silent = false) {
        if(!silent) setMsg("åŒæ­¥ä¸»åº“...");
        await updateGistFile(ghConfig.mainGistId, "main_db.json", db);
    }

    async function deleteAns(idx) {
        if(!confirm("åˆ é™¤ç¬”è®°?")) return;
        currentItemData.answers.splice(idx, 1);
        await performSave();
        renderDetailView();
    }

    async function deleteItem() {
        if(!currentId) return;
        if(!confirm("âš ï¸ ç¡®å®šè¦å½»åº•åˆ é™¤æ­¤é—®é¢˜å—ï¼Ÿ")) return;
        document.getElementById('loading').style.display = 'flex';
        document.getElementById('loading-tip').innerText = "æ­£åœ¨äº‘ç«¯åˆ é™¤...";
        try {
            db.items = db.items.filter(x => x.id !== currentId);
            await saveMainDB(true); 
            location.reload(); 
        } catch(e) {
            document.getElementById('loading').style.display = 'none';
            alert("âŒ åˆ é™¤å¤±è´¥: " + e.message);
        }
    }

    // åä½œç®¡ç†é€»è¾‘
    async function manageCollaboration() {
        const item = db.items.find(x => x.id === currentId);
        if(!item) return;

        if (item.shareId) {
            const action = prompt("âš™ï¸ åä½œç®¡ç†\n1. ğŸ“‹ è·å–åˆ†äº«é“¾æ¥\n2. ğŸ”Œ åœæ­¢åä½œ (å†…å®¹å­˜å›æœ¬åœ°)", "1");
            if (action === "1") { prompt("ğŸ”— é“¾æ¥ï¼š", `${location.origin}${location.pathname}?gist=${item.shareId}`); } 
            else if (action === "2") { await stopCollaboration(item); }
        } else { await convertToShared(); }
    }

    async function stopCollaboration(item) {
        if(!confirm("ç¡®å®šåœæ­¢åä½œå—ï¼Ÿå†…å®¹å°†å­˜å›æœ¬åœ°ï¼Œåˆ†äº«é“¾æ¥å°†å¤±æ•ˆã€‚")) return;
        setMsg("æ­£åœ¨æ–­å¼€...");
        document.getElementById('loading').style.display = 'flex';
        try {
            item.desc = currentItemData.desc; item.answers = currentItemData.answers;
            item.title = currentItemData.title; item.date = currentItemData.date;
            delete item.shareId;
            await saveMainDB(true);
            alert("âœ… å·²å…³é—­åä½œ"); loadItem(item.id); 
        } catch(e) { alert("å¤±è´¥: " + e.message); } 
        finally { document.getElementById('loading').style.display = 'none'; }
    }

    async function convertToShared() {
        const item = db.items.find(x => x.id === currentId);
        if(!confirm("å¼€å¯åä½œæ¨¡å¼ï¼Ÿå†…å®¹å°†ç§»åŠ¨åˆ°ç‹¬ç«‹äº‘ç«¯ç©ºé—´ã€‚")) return;
        setMsg("åˆ›å»ºåä½œç©ºé—´...");
        document.getElementById('loading').style.display = 'flex';
        try {
            const payload = { description: `[Shared] ${item.title}`, public: false, files: { "shared_item.json": { content: JSON.stringify(item, null, 2) } } };
            const res = await fetch("https://api.github.com/gists", { method: "POST", headers: { "Authorization": `token ${ghConfig.token}` }, body: JSON.stringify(payload) });
            await handleApiError(res);
            const json = await res.json();
            item.shareId = json.id;
            await saveMainDB(true);
            alert("âœ… åä½œå·²å¼€å¯"); loadItem(currentId); 
        } catch(e) { handleNetworkError(e); } 
        finally { document.getElementById('loading').style.display = 'none'; }
    }

    // åˆ—è¡¨ç›¸å…³
    function renderList() {
        document.getElementById('list').innerHTML = db.items.map((item, idx) => `
            <li class="item ${item.id === currentId ? 'active' : ''} ${item.shareId ? 'shared' : ''}" 
                draggable="true" onclick="loadItem(${item.id})"
                ondragstart="dragStart(event, ${idx})" ondrop="dragDrop(event, ${idx})" ondragover="event.preventDefault()">
                <span class="pin-icon ${item.isPinned?'pinned':''}" onclick="togglePin(event, ${idx})">ğŸ“Œ</span>
                <span class="item-title">${item.title}</span>
                <span class="share-icon" title="åä½œä¸­">ğŸ”—</span>
            </li>
        `).join('');
    }

    function createNewLocal() {
        const newItem = { id: Date.now(), title: "æ–°é—®é¢˜", desc: "", answers: [], date: new Date().toISOString(), isPinned: false };
        db.items.unshift(newItem);
        saveMainDB();
        loadItem(newItem.id);
    }
    
    function dragStart(e, idx) { e.dataTransfer.setData('idx', idx); }
    function dragDrop(e, targetIdx) { e.preventDefault(); const srcIdx = e.dataTransfer.getData('idx'); const [moved] = db.items.splice(srcIdx, 1); db.items.splice(targetIdx, 0, moved); renderList(); saveMainDB(true); }
    function togglePin(e, idx) { e.stopPropagation(); db.items[idx].isPinned = !db.items[idx].isPinned; if(db.items[idx].isPinned) { const [item] = db.items.splice(idx, 1); db.items.unshift(item); } renderList(); saveMainDB(true); }

    // Config
    function openConfig() { document.getElementById('cfg-token').value = ghConfig.token; document.getElementById('cfg-id').value = ghConfig.mainGistId; document.getElementById('config-modal').style.display = 'flex'; }
    function setMsg(t) { document.getElementById('sync-status').innerText = t; }
    
    async function saveConfig() {
        const t = document.getElementById('cfg-token').value.trim();
        let mid = document.getElementById('cfg-id').value.trim();
        if(!t) return alert("Token ä¸èƒ½ä¸ºç©º");
        if (mid.includes('/')) { mid = mid.split('/').pop().replace('.git', ''); alert("å·²æå– ID: " + mid); }
        ghConfig = { token: t, mainGistId: mid };
        if (!mid) {
            setMsg("æ­£åœ¨åˆå§‹åŒ–..."); document.getElementById('loading').style.display = 'flex';
            try {
                const res = await fetch("https://api.github.com/gists", { method: "POST", headers: { "Authorization": `token ${t}` }, body: JSON.stringify({ description: "Research Manager Main DB", public: false, files: { "main_db.json": { content: JSON.stringify({items:[]}) } } }) });
                await handleApiError(res);
                ghConfig.mainGistId = (await res.json()).id; alert("âœ… å·²åˆ›å»ºæ–°åº“ ID: " + ghConfig.mainGistId);
            } catch(e) { handleNetworkError(e); document.getElementById('loading').style.display = 'none'; return; }
        }
        localStorage.setItem(CFG_KEY, JSON.stringify(ghConfig));
        document.getElementById('config-modal').style.display = 'none';
        syncPullMain();
    }
</script>
</body>
</html>
