<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§‘ç ”ç®¡ç†å™¨ v6</title>
    
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        MathJax = {
            tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$'], ['\\[', '\\]']], processEscapes: true },
            startup: { typeset: false }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/markdown/markdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/stex/stex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
    
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; display: flex; height: 100vh; background: #f4f5f7; overflow: hidden; color: #333; }
        
        /* 1. é¡¶éƒ¨æ  */
        #status-bar {
            position: absolute; top: 0; left: 0; width: 100%; height: 40px; background: #24292e; color: #fff;
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-sizing: border-box; z-index: 100;
        }
        .bar-btn { background: #444; border: 1px solid #666; color: white; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-left: 8px;}
        .bar-btn:hover { background: #666; }
        .bar-btn.primary { background: #0366d6; border-color: #0366d6; }
        .bar-btn.warn { background: #d73a49; border-color: #d73a49; }

        /* 2. ä¸»å¸ƒå±€ä¸æ‹–æ‹½æ¡ */
        #container { display: flex; width: 100%; height: 100%; padding-top: 40px; box-sizing: border-box; }
        
        #sidebar { 
            width: 280px; background: #f9f9f9; display: flex; flex-direction: column; flex-shrink: 0; overflow: hidden; 
            border-right: 1px solid #ddd; /* é»˜è®¤è¾¹æ¡†ï¼Œä¼šè¢«resizerè¦†ç›– */
        }
        
        /* å¯æ‹–åŠ¨åˆ†å‰²çº¿ */
        #resizer {
            width: 5px; background: #ddd; cursor: col-resize; z-index: 10; transition: background 0.2s;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #resizer:hover, #resizer.resizing { background: #0366d6; }

        #main { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: white; position: relative; min-width: 0; }

        /* 3. ä¾§è¾¹æ åˆ—è¡¨ */
        .sidebar-header { padding: 10px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; background: #fff;}
        #list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        .item { padding: 12px 10px; border-bottom: 1px solid #eee; cursor: pointer; border-left: 4px solid transparent; display: flex; align-items: flex-start; gap: 8px; user-select: none;}
        .item:hover { background: #eaeaea; }
        .item.active { background: #e6effc; border-left: 4px solid #0052cc; }
        .item.dragging { opacity: 0.5; background: #ccc; }
        
        .pin-icon { color: #ccc; font-size: 12px; cursor: pointer; margin-top: 2px;}
        .pin-icon.pinned { color: #d97706; }
        .item-content { flex: 1; overflow: hidden; }
        .item-title { font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .item-date { font-size: 11px; color: #888; margin-top: 2px;}

        /* 4. å†…å®¹åŒºåŸŸ */
        #detail-view { display: none; width: 100%; height: 100%; flex-direction: column; overflow-y: auto; }
        .content-wrap { padding: 30px 50px; max-width: 900px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        
        .markdown-body { line-height: 1.7; font-size: 16px; color: #24292e; }
        .markdown-body h1 { border-bottom: 1px solid #eee; padding-bottom: 0.3em; }
        .markdown-body pre { background: #f6f8fa; padding: 15px; border-radius: 6px; overflow: auto; }
        .markdown-body blockquote { border-left: 4px solid #dfe2e5; padding-left: 15px; color: #6a737d; }

        /* ç¬”è®°åŒºåŸŸ */
        .ans-item { border: 1px solid #eee; padding: 20px; border-radius: 8px; margin-bottom: 15px; background: #fafbfc; position: relative; }
        .ans-meta { font-size: 12px; color: #aaa; margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px; display: flex; justify-content: space-between;}

        /* 5. å…¨å±ç¼–è¾‘å™¨ */
        #editor-layer { display: none; position: fixed; inset: 0; background: white; z-index: 200; flex-direction: column; }
        .editor-header { height: 50px; border-bottom: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; background: #f4f5f7; }
        .editor-body { flex: 1; display: flex; overflow: hidden; }
        .editor-col { width: 50%; height: 100%; display: flex; flex-direction: column; border-right: 1px solid #ddd; }
        .preview-pane { padding: 20px 40px; overflow-y: auto; background: #fff; }
        .CodeMirror { height: 100%; font-family: "SFMono-Regular", Consolas, monospace; font-size: 15px; line-height: 1.6; }

        /* è‡ªå®šä¹‰ LaTeX ç¯å¢ƒæ ·å¼ */
        .env-block { margin: 1em 0; padding: 15px; border-radius: 4px; border-left: 4px solid #555; background: #f9f9f9; }
        .env-thm { background: #e6effc; border-left-color: #0052cc; } .env-thm .t { color: #0052cc; font-weight: bold; }
        .env-proof { background: #fff; border-left: 2px solid #ddd; color: #333; } .env-proof .t { font-style: italic; font-weight: bold; }

        /* å¼¹çª—ä¸åŠ è½½ */
        .modal { display: none; position: fixed; inset: 0; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index: 1000; }
        .modal-box { background:white; padding:25px; width:400px; border-radius:8px; display:flex; flex-direction:column; gap:15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .inp { padding: 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%; box-sizing: border-box; }
        #loading { display: flex; position: fixed; inset: 0; background: rgba(255,255,255,0.8); z-index: 2000; justify-content: center; align-items: center; font-weight: bold; font-size: 18px; color: #333; }
        
        /* åä½œæ¨¡å¼ä¸‹çš„ç‰¹æ®Šæ ·å¼ */
        body.collab-mode #sidebar { display: none; }
        body.collab-mode #resizer { display: none; }
        body.collab-mode .only-owner { display: none !important; }
        #collab-banner { display: none; background: #fff3cd; color: #856404; padding: 5px 15px; font-size: 13px; text-align: center; border-bottom: 1px solid #ffeeba; }
    </style>
</head>
<body>

<div id="loading">ğŸš€ è¿æ¥äº‘ç«¯æ•°æ®...</div>

<div id="status-bar">
    <div style="display:flex; align-items:center; gap:10px;">
        <span id="app-title" style="font-weight:bold;">ç§‘ç ”ç®¡ç†å™¨ v6</span>
        <span id="sync-status" style="font-size:12px; color:#aaa;">âšª å‡†å¤‡å°±ç»ª</span>
    </div>
    <div id="auth-controls">
        <button class="bar-btn" onclick="syncPull()" title="é‡æ–°æ‹‰å–">ğŸ”„ åˆ·æ–°</button>
        <button class="bar-btn warn" onclick="openConfig()">âš™ï¸ å¯†é’¥é…ç½®</button>
    </div>
</div>

<div id="collab-banner">âš ï¸ åä½œæ¨¡å¼ï¼šä½ æ­£åœ¨æŸ¥çœ‹å’Œç¼–è¾‘ä¸€ä¸ªç‹¬ç«‹çš„åˆ†äº«é—®é¢˜ã€‚æ‰€æœ‰ä¿®æ”¹å°†ä¿å­˜å›è¯¥åˆ†äº«é“¾æ¥ã€‚</div>

<div id="container">
    <div id="sidebar">
        <div class="sidebar-header">
            <h3 style="margin:0; font-size:16px;">ğŸ“š é—®é¢˜åº“</h3>
            <button class="bar-btn primary" onclick="startNewProblem()">+</button>
        </div>
        <ul id="list">
            </ul>
    </div>

    <div id="resizer"></div>

    <div id="main">
        <div id="empty-msg" style="text-align:center; color:#888; margin-top:20vh;">
            <h2>è¯·é€‰æ‹©æˆ–æ–°å»ºé—®é¢˜</h2>
            <p>æ•°æ®çº¯äº‘ç«¯åŒæ­¥ï¼Œæ— æœ¬åœ°ç¼“å­˜</p>
        </div>

        <div id="detail-view">
            <div class="content-wrap">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; padding-bottom:10px; border-bottom:1px solid #eee;">
                    <span id="d-date" style="color:#888; font-size:12px;"></span>
                    <div style="display:flex; gap:10px;">
                        <button class="bar-btn only-owner" onclick="createCollabLink()">ğŸ”— åˆ›å»ºåä½œé“¾æ¥</button>
                        <button class="bar-btn" onclick="openEditor('problem')">âœï¸ ç¼–è¾‘é—®é¢˜</button>
                        <button class="bar-btn warn only-owner" onclick="deleteProblem()">ğŸ—‘ï¸</button>
                    </div>
                </div>
                <h1 id="d-title" style="color:#0052cc; margin-top:0;"></h1>
                <div id="d-desc" class="markdown-body"></div>
            </div>

            <div style="background:#f4f5f7; padding:10px 50px; font-weight:bold; font-size:13px; color:#666; text-transform:uppercase; letter-spacing:1px;">
                ç¬”è®°ä¸è®¨è®º
            </div>

            <div class="content-wrap" style="background:#fff;">
                <div id="ans-list"></div>
                <div style="margin-top:30px; text-align:center;">
                    <button class="bar-btn primary" style="padding:10px 30px; font-size:14px;" onclick="openEditor('note')">â• æ·»åŠ å…¨å±ç¬”è®°</button>
                </div>
                <div style="height:50px;"></div>
            </div>
        </div>
    </div>
</div>

<div id="editor-layer">
    <div class="editor-header">
        <span id="editor-mode-title" style="font-weight:bold;">ç¼–è¾‘</span>
        <input id="editor-title-input" class="inp" style="width:300px; display:none;" placeholder="é—®é¢˜æ ‡é¢˜">
        <div>
            <button class="bar-btn" onclick="closeEditor()">å–æ¶ˆ</button>
            <button class="bar-btn primary" onclick="saveEditorContent()">ğŸ’¾ ä¿å­˜ (Ctrl+S)</button>
        </div>
    </div>
    <div class="editor-body">
        <div class="editor-col">
            <textarea id="code-editor"></textarea>
        </div>
        <div class="editor-col preview-pane">
            <div id="editor-preview" class="markdown-body"></div>
        </div>
    </div>
</div>

<div id="config-modal" class="modal">
    <div class="modal-box">
        <h3>âš™ï¸ äº‘ç«¯é…ç½® (Gist)</h3>
        <p style="font-size:12px; color:#666;">è¯·è¾“å…¥å…·å¤‡ <b>gist</b> æƒé™çš„ GitHub Tokenã€‚</p>
        <input class="inp" id="cfg-token" type="password" placeholder="ghp_xxxxxxxxxxxx">
        <input class="inp" id="cfg-gist-id" placeholder="Gist ID (ç•™ç©ºåˆ™è‡ªåŠ¨åˆ›å»ºæ–°çš„)">
        <div style="text-align:right;">
            <button class="bar-btn" onclick="document.getElementById('config-modal').style.display='none'">å…³é—­</button>
            <button class="bar-btn primary" onclick="saveConfig()">ä¿å­˜å¹¶è¿æ¥</button>
        </div>
    </div>
</div>

<script>
    // --- 0. æ ¸å¿ƒçŠ¶æ€ä¸é…ç½® ---
    const CFG_KEY = 'v6_gh_config'; // ä»…å­˜å‚¨ Token å’Œ ä¸»GistID
    let ghConfig = JSON.parse(localStorage.getItem(CFG_KEY)) || { token: '', gistId: '' };
    
    // å†…å­˜æ•°æ® (æ—  LocalStorage)
    let db = { items: [] }; 
    let currentId = null;
    let editorMode = 'problem'; // 'problem' | 'note'
    
    // åä½œæ¨¡å¼çŠ¶æ€
    const urlParams = new URLSearchParams(window.location.search);
    const collabGistId = urlParams.get('gist'); // å¦‚æœ URL æœ‰ ?gist=... åˆ™è¿›å…¥åä½œæ¨¡å¼
    const isCollabMode = !!collabGistId;

    // ç¼–è¾‘å™¨å®ä¾‹
    let cmEditor;

    // --- 1. åˆå§‹åŒ– ---
    window.onload = async function() {
        initUI();
        
        if (isCollabMode) {
            enterCollabMode();
        } else {
            if (ghConfig.token && ghConfig.gistId) {
                await syncPull();
            } else {
                document.getElementById('loading').style.display = 'none';
                openConfig();
            }
        }
    };

    function initUI() {
        // CodeMirror
        cmEditor = CodeMirror.fromTextArea(document.getElementById("code-editor"), {
            mode: "markdown", lineNumbers: true, lineWrapping: true,
            extraKeys: { "Ctrl-S": saveEditorContent }
        });
        cmEditor.on("change", () => {
            const val = cmEditor.getValue();
            document.getElementById('editor-preview').innerHTML = renderContent(val);
            if(window.MathJax) MathJax.typesetPromise([document.getElementById('editor-preview')]);
        });

        // æ‹–æ‹½è°ƒæ•´å®½åº¦
        const resizer = document.getElementById('resizer');
        const sidebar = document.getElementById('sidebar');
        let isResizing = false;

        resizer.addEventListener('mousedown', (e) => {
            isResizing = true;
            resizer.classList.add('resizing');
            document.body.style.cursor = 'col-resize';
        });
        window.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            let newWidth = e.clientX;
            if (newWidth < 150) newWidth = 150;
            if (newWidth > 600) newWidth = 600;
            sidebar.style.width = newWidth + 'px';
        });
        window.addEventListener('mouseup', () => {
            isResizing = false;
            resizer.classList.remove('resizing');
            document.body.style.cursor = 'default';
        });
    }

    // --- 2. åä½œæ¨¡å¼é€»è¾‘ ---
    async function enterCollabMode() {
        document.body.classList.add('collab-mode');
        document.getElementById('collab-banner').style.display = 'block';
        document.getElementById('app-title').innerText = "åä½œæŸ¥çœ‹å™¨";
        document.getElementById('auth-controls').innerHTML = ''; // éšè—é…ç½®æŒ‰é’®
        
        // å°è¯•ä» URL Hash æˆ– prompt è·å– Token (å¦‚æœ Gist æ˜¯ç§æœ‰çš„)
        // ç®€å•èµ·è§ï¼Œè¿™é‡Œå‡è®¾ç”¨æˆ·å¦‚æœä¹Ÿæ˜¯ç§‘ç ”è€…ï¼Œæœ‰è‡ªå·±çš„ Tokenï¼Œæˆ–è€… Gist æ˜¯ Public çš„
        // ä¸ºäº†ä½“éªŒï¼Œæˆ‘ä»¬è¿™é‡Œç›´æ¥å°è¯•è¯»å–ã€‚å¦‚æœå¤±è´¥ï¼Œæç¤ºç”¨æˆ·è¾“å…¥ Tokenã€‚
        
        // å®é™…ä¸Šï¼Œåä½œéœ€è¦ Token æ‰èƒ½ç¼–è¾‘ã€‚
        // æˆ‘ä»¬æ£€æŸ¥æœ¬åœ°æ˜¯å¦å·²æœ‰ tokenï¼Œå¦‚æœæ²¡æœ‰ï¼Œæç¤ºè¾“å…¥ä¸€ä¸ªä¸´æ—¶ tokenã€‚
        if (!ghConfig.token) {
            const tempToken = prompt("è¿›å…¥åä½œæ¨¡å¼ï¼šè¯·è¾“å…¥ä½ çš„ GitHub Token ä»¥å¯ç”¨ç¼–è¾‘åŠŸèƒ½ (ä¸ä¼šä¿å­˜åˆ°æœåŠ¡å™¨)");
            if(tempToken) ghConfig.token = tempToken;
        }

        await syncPull(collabGistId); // æ‹‰å–ç‰¹å®š Gist
        // åä½œæ¨¡å¼ä¸‹ DB ç»“æ„å¯èƒ½ä¸åŒï¼Œæˆ‘ä»¬å‡è®¾æ¯ä¸ªåä½œ Gist åªå­˜äº†ä¸€ä¸ª Item å¯¹è±¡
        // ä¸ºäº†å¤ç”¨é€»è¾‘ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªå• Item åŒ…è£…è¿› db.items
        if (!Array.isArray(db.items)) {
            // è¯´æ˜æ‹‰å–çš„æ˜¯å•ä½“å¯¹è±¡
            const singleItem = JSON.parse(JSON.stringify(db)); // db ç›®å‰æ˜¯è¯¥å¯¹è±¡
            db = { items: [singleItem] };
        }
        
        renderList();
        if(db.items.length > 0) loadDetail(db.items[0].id);
    }

    async function createCollabLink() {
        const item = db.items.find(x => x.id === currentId);
        if(!item) return;
        if(!confirm(`å°†è¦æŠŠé—®é¢˜ "${item.title}" å‘å¸ƒä¸ºä¸€ä¸ªç‹¬ç«‹çš„ Gist ä»¥ä¾¿åˆ†äº«å—ï¼Ÿ`)) return;
        
        setMsg("æ­£åœ¨åˆ›å»ºåˆ†äº«é“¾æ¥...");
        try {
            // å‘å¸ƒå•ä½“å¯¹è±¡
            const res = await fetch("https://api.github.com/gists", {
                method: "POST",
                headers: { "Authorization": `token ${ghConfig.token}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    description: `[Shared] ${item.title}`,
                    public: false, // è®¾ä¸ºç§æœ‰é“¾æ¥
                    files: { "problem_shared.json": { content: JSON.stringify(item, null, 2) } }
                })
            });
            if(!res.ok) throw new Error("åˆ›å»ºå¤±è´¥");
            const json = await res.json();
            const shareUrl = `${window.location.origin}${window.location.pathname}?gist=${json.id}`;
            
            prompt("ğŸ”— é“¾æ¥å·²ç”Ÿæˆï¼\nå°†æ­¤é“¾æ¥å‘é€ç»™åˆä½œè€…ï¼Œä»–ä»¬å¯ä»¥ç›´æ¥æŸ¥çœ‹å¹¶ç¼–è¾‘æ­¤é—®é¢˜ï¼š", shareUrl);
            setMsg("åˆ†äº«é“¾æ¥åˆ›å»ºæˆåŠŸ");
        } catch(e) {
            alert(e.message);
            setMsg("åˆ›å»ºå¤±è´¥");
        }
    }

    // --- 3. æ•°æ®åŒæ­¥ (æ ¸å¿ƒ) ---
    async function syncPull(targetGistId = null) {
        const gid = targetGistId || ghConfig.gistId;
        if (!ghConfig.token || !gid) return;
        
        document.getElementById('loading').style.display = 'flex';
        setMsg("æ­£åœ¨åŒæ­¥...");
        
        try {
            const res = await fetch(`https://api.github.com/gists/${gid}`, {
                headers: { "Authorization": `token ${ghConfig.token}` },
                cache: "no-store"
            });
            if(!res.ok) throw new Error("æ— æ³•è¿æ¥ Gistï¼Œè¯·æ£€æŸ¥ Token æˆ– ID");
            const json = await res.json();
            const filename = Object.keys(json.files)[0];
            const content = json.files[filename].content;
            
            db = JSON.parse(content);
            if(!db.items) db = { items: [] }; // åˆå§‹ä¿æŠ¤

            renderList();
            // å¦‚æœä¸åœ¨åä½œæ¨¡å¼ä¸”æœ‰é€‰ä¸­IDï¼Œåˆ·æ–°è¯¦æƒ…
            if(!isCollabMode && currentId) {
                // æ£€æŸ¥è¯¥IDæ˜¯å¦è¿˜å­˜åœ¨
                if(db.items.find(x=>x.id === currentId)) loadDetail(currentId);
                else document.getElementById('detail-view').style.display = 'none';
            }
            
            setMsg("âœ… åŒæ­¥å®Œæˆ");
        } catch(e) {
            alert("åŒæ­¥é”™è¯¯: " + e.message);
            setMsg("âŒ åŒæ­¥å¤±è´¥");
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    async function syncPush() {
        const gid = isCollabMode ? collabGistId : ghConfig.gistId;
        if (!ghConfig.token || !gid) return alert("é…ç½®ç¼ºå¤±");
        
        setMsg("æ­£åœ¨ä¿å­˜åˆ°äº‘ç«¯...");
        
        // å¦‚æœæ˜¯åä½œæ¨¡å¼ï¼Œæ¨é€å•ä½“ï¼›å¦‚æœæ˜¯ä¸»æ¨¡å¼ï¼Œæ¨é€æ•´ä¸ªDB
        let contentStr = "";
        let fileName = "research_data.json";

        if (isCollabMode) {
            // åä½œæ¨¡å¼ä¸‹ db.items[0] æ˜¯æˆ‘ä»¬è¦ä¿å­˜çš„å¯¹è±¡
            contentStr = JSON.stringify(db.items[0], null, 2);
            fileName = "problem_shared.json"; // å°è¯•ä¿æŒä¸€è‡´ï¼Œæˆ–è€…æ˜¯åŸæ–‡ä»¶å
        } else {
            contentStr = JSON.stringify(db, null, 2);
        }

        try {
            const res = await fetch(`https://api.github.com/gists/${gid}`, {
                method: "PATCH",
                headers: { "Authorization": `token ${ghConfig.token}`, "Content-Type": "application/json" },
                body: JSON.stringify({ files: { [fileName]: { content: contentStr } } })
            });
            if(!res.ok) throw new Error("ä¿å­˜å¤±è´¥");
            setMsg("â˜ï¸ ä¿å­˜æˆåŠŸ " + new Date().toLocaleTimeString());
        } catch(e) {
            alert(e.message);
            setMsg("âŒ ä¿å­˜å¤±è´¥");
        }
    }

    // --- 4. ä¸šåŠ¡é€»è¾‘ä¸ UI æ¸²æŸ“ ---
    function renderList() {
        const ul = document.getElementById('list');
        ul.innerHTML = '';
        
        // æ’åºé€»è¾‘ï¼šå…ˆ Pin çš„ï¼Œç„¶åæŒ‰ items æ•°ç»„é¡ºåº
        // ä¸ºäº†æ”¯æŒè‡ªå®šä¹‰æ’åºï¼Œæˆ‘ä»¬ç›´æ¥æ¸²æŸ“ db.items çš„é¡ºåºã€‚
        // ç½®é¡¶åªæ˜¯è§†è§‰ä¸Šçš„ "Pin"ï¼Œæˆ–è€…æˆ‘ä»¬å¯ä»¥æŠŠ Pin çš„ç§»åˆ°æ•°ç»„å‰é¢ã€‚
        // ç­–ç•¥ï¼šitems æ•°ç»„å°±æ˜¯æ˜¾ç¤ºé¡ºåºã€‚Pin åªæ˜¯ä¸€ä¸ªæ ‡è®°ï¼Œæˆ‘ä»¬æ‰‹åŠ¨é€»è¾‘æŠŠ Pin çš„æ’å‰é¢æ˜¾ç¤ºï¼Ÿ
        // éœ€æ±‚æ˜¯â€œè‡ªç”±æ‹‰åŠ¨æ’åºâ€ä»¥åŠâ€œç½®é¡¶â€ã€‚
        // ç®€å•å®ç°ï¼šæ•°æ®ç»“æ„ä¸­ isPinned çš„é¡¹æ€»æ˜¯æ’åœ¨é isPinned ä¹‹å‰ã€‚å†…éƒ¨å†æŒ‰ index æ’åºã€‚
        
        // å®é™…ä¸Šï¼Œä¸ºäº†å®Œå…¨è‡ªç”±ï¼Œæˆ‘ä»¬ä¸å¦‚åªç”¨æ•°ç»„é¡ºåºã€‚
        // "ç½®é¡¶" åŠŸèƒ½å°†è¯¥ item ç§»åŠ¨åˆ°æ•°ç»„å¤´éƒ¨ã€‚
        
        db.items.forEach((item, index) => {
            const li = document.createElement('li');
            li.className = `item ${item.id === currentId ? 'active' : ''}`;
            li.draggable = true;
            li.innerHTML = `
                <div class="pin-icon ${item.isPinned ? 'pinned' : ''}" onclick="togglePin(event, ${index})">ğŸ“Œ</div>
                <div class="item-content">
                    <div class="item-title">${escapeHtml(item.title)}</div>
                    <div class="item-date">${new Date(item.date).toLocaleDateString()}</div>
                </div>
            `;
            li.onclick = () => loadDetail(item.id);
            
            // æ‹–æ‹½äº‹ä»¶
            li.addEventListener('dragstart', (e) => {
                li.classList.add('dragging');
                e.dataTransfer.setData('text/plain', index);
            });
            li.addEventListener('dragend', () => li.classList.remove('dragging'));
            li.addEventListener('dragover', (e) => e.preventDefault()); // å…è®¸ drop
            li.addEventListener('drop', (e) => handleDrop(e, index));

            ul.appendChild(li);
        });
    }

    function handleDrop(e, targetIndex) {
        e.preventDefault();
        const sourceIndex = parseInt(e.dataTransfer.getData('text/plain'));
        if (sourceIndex === targetIndex) return;

        // ç§»åŠ¨æ•°ç»„å…ƒç´ 
        const [movedItem] = db.items.splice(sourceIndex, 1);
        db.items.splice(targetIndex, 0, movedItem);
        
        renderList();
        syncPush(); // æ’åºåç«‹å³åŒæ­¥
    }

    function togglePin(e, index) {
        e.stopPropagation();
        const item = db.items[index];
        item.isPinned = !item.isPinned;
        
        // å¦‚æœç½®é¡¶ï¼Œç§»åŠ¨åˆ°æœ€å‰ï¼›å–æ¶ˆç½®é¡¶ï¼Œç§»åŠ¨åˆ°ï¼ˆæ¯”å¦‚ï¼‰ç¬¬äºŒä¸ªä½ç½®ï¼Ÿ
        // ç®€å•å¤„ç†ï¼šç½®é¡¶=ç§»åˆ° index 0ã€‚å–æ¶ˆç½®é¡¶=ä¸ç§»åŠ¨ï¼Œåªå˜è‰²ã€‚
        // æˆ–è€…ï¼šæ¯æ¬¡æ¸²æŸ“æ—¶ï¼Œå…ˆæ¸²æŸ“ Pinnedï¼Œå†æ¸²æŸ“å…¶ä»–çš„ã€‚
        // ä¸ºäº†é…åˆâ€œè‡ªç”±æ’åºâ€ï¼Œæˆ‘ä»¬é‡‡ç”¨ï¼šç½®é¡¶æ“ä½œ = ç‰©ç†ç§»åŠ¨åˆ°é¡¶éƒ¨ã€‚
        if (item.isPinned) {
            db.items.splice(index, 1);
            db.items.unshift(item);
        }
        renderList();
        syncPush();
    }

    function loadDetail(id) {
        currentId = id;
        const item = db.items.find(x => x.id === id);
        if(!item) return;

        document.getElementById('empty-msg').style.display = 'none';
        document.getElementById('detail-view').style.display = 'flex';
        
        document.getElementById('d-title').innerText = item.title;
        document.getElementById('d-date').innerText = "æ›´æ–°äº: " + new Date(item.date).toLocaleString();
        document.getElementById('d-desc').innerHTML = renderContent(item.desc);
        
        const ansContainer = document.getElementById('ans-list');
        ansContainer.innerHTML = item.answers.map((a, idx) => `
            <div class="ans-item">
                <div class="markdown-body">${renderContent(a.text)}</div>
                <div class="ans-meta">
                    <span>${new Date(a.date).toLocaleString()}</span>
                    <button class="bar-btn warn" style="padding:2px 6px;" onclick="deleteAns(${idx})">åˆ é™¤</button>
                </div>
            </div>
        `).join('');

        renderList();
        if(window.MathJax) MathJax.typesetPromise();
    }

    // --- 5. ç¼–è¾‘å™¨é€»è¾‘ ---
    function openEditor(mode) {
        editorMode = mode;
        const layer = document.getElementById('editor-layer');
        const titleInp = document.getElementById('editor-title-input');
        const item = db.items.find(x => x.id === currentId);

        layer.style.display = 'flex';
        
        if (mode === 'problem') {
            document.getElementById('editor-mode-title').innerText = "ç¼–è¾‘é—®é¢˜";
            titleInp.style.display = 'block';
            titleInp.value = item.title;
            cmEditor.setValue(item.desc);
        } else {
            document.getElementById('editor-mode-title').innerText = "æ·»åŠ ç¬”è®°";
            titleInp.style.display = 'none';
            cmEditor.setValue(""); // æ¸…ç©º
            cmEditor.focus();
        }
        setTimeout(() => cmEditor.refresh(), 100);
    }

    function closeEditor() {
        document.getElementById('editor-layer').style.display = 'none';
    }

    function saveEditorContent() {
        const val = cmEditor.getValue();
        const item = db.items.find(x => x.id === currentId);
        
        if (editorMode === 'problem') {
            item.title = document.getElementById('editor-title-input').value;
            item.desc = val;
            item.date = new Date().toISOString();
        } else {
            if (!val.trim()) return;
            item.answers.push({ text: val, date: new Date().toISOString() });
            item.date = new Date().toISOString(); // æ›´æ–°ä¸»é—®é¢˜æ—¶é—´
        }
        
        closeEditor();
        loadDetail(currentId); // åˆ·æ–°ç•Œé¢
        syncPush(); // åŒæ­¥
    }

    function startNewProblem() {
        // ç›´æ¥æ–°å»ºä¸€ä¸ªï¼Œç„¶åè¿›å…¥ç¼–è¾‘æ¨¡å¼
        const newItem = { id: Date.now(), title: "æ–°é—®é¢˜ " + new Date().toLocaleDateString(), desc: "", answers: [], date: new Date().toISOString() };
        db.items.unshift(newItem);
        currentId = newItem.id;
        renderList();
        loadDetail(newItem.id);
        openEditor('problem');
    }

    function deleteProblem() {
        if(confirm("ç¡®å®šåˆ é™¤æ­¤é—®é¢˜å—ï¼Ÿæ— æ³•æ¢å¤ã€‚")) {
            db.items = db.items.filter(x => x.id !== currentId);
            currentId = null;
            document.getElementById('detail-view').style.display = 'none';
            document.getElementById('empty-msg').style.display = 'block';
            renderList();
            syncPush();
        }
    }
    
    function deleteAns(idx) {
        if(confirm("åˆ é™¤æ­¤ç¬”è®°ï¼Ÿ")) {
            const item = db.items.find(x => x.id === currentId);
            item.answers.splice(idx, 1);
            loadDetail(currentId);
            syncPush();
        }
    }

    // --- 6. è¾…åŠ© ---
    function openConfig() { document.getElementById('config-modal').style.display = 'flex'; }
    
    async function saveConfig() {
        const t = document.getElementById('cfg-token').value.trim();
        const i = document.getElementById('cfg-gist-id').value.trim();
        
        if (!t) return alert("Token å¿…å¡«");
        
        ghConfig.token = t;
        ghConfig.gistId = i;
        
        // è‡ªåŠ¨åˆ›å»ºé€»è¾‘
        if (!i) {
            try {
                setMsg("æ­£åœ¨åˆ›å»ºæ–°æ•°æ®åº“...");
                const res = await fetch("https://api.github.com/gists", {
                    method: "POST",
                    headers: { "Authorization": `token ${t}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        description: "Research Manager v6 DB",
                        public: false,
                        files: { "research_data.json": { content: JSON.stringify({ items: [] }) } }
                    })
                });
                const json = await res.json();
                ghConfig.gistId = json.id;
                alert("å·²è‡ªåŠ¨åˆ›å»ºæ–°æ•°æ®åº“ ID: " + json.id);
            } catch(e) {
                return alert("åˆ›å»ºå¤±è´¥: " + e.message);
            }
        }
        
        localStorage.setItem(CFG_KEY, JSON.stringify(ghConfig));
        document.getElementById('config-modal').style.display = 'none';
        syncPull();
    }

    function setMsg(txt) { document.getElementById('sync-status').innerText = txt; }
    
    function renderContent(text) {
        if (!text) return "";
        let html = marked.parse(text);
        // ç®€å•çš„ LaTeX ç¯å¢ƒæ›¿æ¢
        html = html.replace(/\\begin\{thm\}([\s\S]*?)\\end\{thm\}/gi, '<div class="env-block env-thm"><span class="t">Theorem.</span> $1</div>');
        html = html.replace(/\\begin\{proof\}([\s\S]*?)\\end\{proof\}/gi, '<div class="env-block env-proof"><span class="t">Proof.</span> $1 <span style="float:right">â—¼</span></div>');
        return html;
    }
    
    function escapeHtml(text) { return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;"); }

</script>
</body>
</html>
